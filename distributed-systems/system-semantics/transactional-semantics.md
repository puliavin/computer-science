# Transactional Semantics (–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –°–µ–º–∞–Ω—Ç–∏–∫–∞)

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–í–≤–µ–¥–µ–Ω–∏–µ](#–≤–≤–µ–¥–µ–Ω–∏–µ)
2. [ACID: –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π](#acid-—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ-—Å–≤–æ–π—Å—Ç–≤–∞-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
3. [Atomicity (–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å)](#1-atomicity-–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å)
4. [Consistency (–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å)](#2-consistency-—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å-—á–µ—Ä–µ–∑-invariants)
5. [Isolation (–ò–∑–æ–ª—è—Ü–∏—è)](#3-isolation-–∏–∑–æ–ª—è—Ü–∏—è)
6. [Durability (–î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å)](#4-durability-–¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å)
7. [Exactly-Once Effects](#5-exactly-once-effects-—ç—Ñ—Ñ–µ–∫—Ç—ã-—Ä–æ–≤–Ω–æ-–æ–¥–∏–Ω-—Ä–∞–∑)
8. [Distributed Transactions](#6-distributed-transactions-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
9. [Two-Phase Commit (2PC)](#7-two-phase-commit-2pc)
10. [Three-Phase Commit (3PC)](#8-three-phase-commit-3pc)
11. [Saga Pattern](#9-saga-pattern-–ø–∞—Ç—Ç–µ—Ä–Ω-—Å–∞–≥–∞)
12. [Compensation Semantics](#10-compensation-semantics-—Å–µ–º–∞–Ω—Ç–∏–∫–∞-–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏)
13. [Outbox Pattern](#11-outbox-pattern-–ø–∞—Ç—Ç–µ—Ä–Ω-–∏—Å—Ö–æ–¥—è—â–∏—Ö-—Å–æ–æ–±—â–µ–Ω–∏–π)
14. [–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–¥—Ö–æ–¥–æ–≤](#—Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è-—Ç–∞–±–ª–∏—Ü–∞-–ø–æ–¥—Ö–æ–¥–æ–≤)
15. [Best Practices](#best-practices-–ª—É—á—à–∏–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏)
16. [–ó–∞–∫–ª—é—á–µ–Ω–∏–µ](#–∑–∞–∫–ª—é—á–µ–Ω–∏–µ)

---

## –í–≤–µ–¥–µ–Ω–∏–µ

**Transactional Semantics** (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞) ‚Äî —ç—Ç–æ –Ω–∞–±–æ—Ä –≥–∞—Ä–∞–Ω—Ç–∏–π, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏—Ö –∫–∞–∫ –≥—Ä—É–ø–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ –∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ.

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –ø–µ—Ä–µ–≤–æ–¥–∏—à—å –¥–µ–Ω—å–≥–∏ –¥—Ä—É–≥—É —á–µ—Ä–µ–∑ –±–∞–Ω–∫. –≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –∫–∞–∂–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ–π: —Å–Ω—è—Ç—å –¥–µ–Ω—å–≥–∏ —Å —Ç–≤–æ–µ–≥–æ —Å—á—ë—Ç–∞ –∏ –ø–æ–ª–æ–∂–∏—Ç—å –Ω–∞ —Å—á—ë—Ç –¥—Ä—É–≥–∞. –ù–æ —á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç, –µ—Å–ª–∏:
- –î–µ–Ω—å–≥–∏ —Å–ø–∏—à—É—Ç—Å—è —Å —Ç–≤–æ–µ–≥–æ —Å—á—ë—Ç–∞, –Ω–æ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–¥—ë—Ç –¥–æ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞ —Å—á—ë—Ç –¥—Ä—É–≥–∞?
- –î–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—ã—Ç–∞—é—Ç—Å—è —Å–Ω—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Ä—É–±–ª–µ–π —Å –æ–¥–Ω–æ–≥–æ —Å—á—ë—Ç–∞?
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Å–±–æ—è ‚Äî –æ—Å—Ç–∞–Ω—É—Ç—Å—è –ª–∏ –¥–µ–Ω—å–≥–∏ –Ω–∞ —Å—á–µ—Ç–∞—Ö?

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ä–µ—à–∞—é—Ç —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã. –û–Ω–∏ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –æ–¥–Ω—É –Ω–µ–¥–µ–ª–∏–º—É—é –µ–¥–∏–Ω–∏—Ü—É —Ä–∞–±–æ—Ç—ã: –ª–∏–±–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Å—ë, –ª–∏–±–æ –Ω–∏—á–µ–≥–æ.

–í —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (Postgres, MongoDB, Kafka, –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã) –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π —Å–µ–º–∞–Ω—Ç–∏–∫–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫:
- üí∏ –ü–æ—Ç–µ—Ä–µ –¥–µ–Ω–µ–≥ (–¥–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å, –Ω–æ –Ω–µ –∑–∞—á–∏—Å–ª–∏–ª–∏—Å—å)
- üì¶ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –∑–∞–∫–∞–∑–æ–≤ (–∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–ª—Å—è –¥–≤–∞–∂–¥—ã –∏–∑-–∑–∞ retry)
- üîÑ –ù–∞—Ä—É—à–µ–Ω–∏—é –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª (–ø—Ä–æ–¥–∞–ª–∏ –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–∞, —á–µ–º –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ)
- üêõ Inconsistent state (–¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É)

---

## ACID: –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

ACID ‚Äî —ç—Ç–æ –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ —á–µ—Ç—ã—Ä—ë—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–≤–æ–π—Å—Ç–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:

```
A - Atomicity     (–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å)
C - Consistency   (–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å)
I - Isolation     (–ò–∑–æ–ª—è—Ü–∏—è)
D - Durability    (–î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å)
```

–≠—Ç–∏ —Å–≤–æ–π—Å—Ç–≤–∞ –±—ã–ª–∏ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω—ã –µ—â—ë –≤ 1980-—Ö –≥–æ–¥–∞—Ö, –Ω–æ –æ—Å—Ç–∞—é—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –∏ —Å–µ–≥–æ–¥–Ω—è.

---

## 1. Atomicity (–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Atomicity** (–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∫ –µ–¥–∏–Ω–∞—è –Ω–µ–¥–µ–ª–∏–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: –ª–∏–±–æ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è, –ª–∏–±–æ –Ω–∏ –æ–¥–Ω–æ.

–¢–µ—Ä–º–∏–Ω –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—Ç –≥—Ä–µ—á–µ—Å–∫–æ–≥–æ "atomos" ‚Äî –Ω–µ–¥–µ–ª–∏–º—ã–π. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ª–∏–±–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º, –ª–∏–±–æ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é.

### ‚úÖ –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º –∏–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤–æ–≤—Å–µ
- –ü—Ä–∏ —Å–±–æ–µ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è (rollback)
- –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å "—á–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π" —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –í–Ω–µ—à–Ω–∏–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ª–∏–±–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–¥–æ", –ª–∏–±–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–ø–æ—Å–ª–µ"

### ‚ùå –ß—Ç–æ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –ß—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –±—É–¥–µ—Ç —É—Å–ø–µ—à–Ω–æ–π (–æ–Ω–∞ –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è rollback)
- –ó–∞—â–∏—Ç—É –æ—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- –ß—Ç–æ –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –≤–∏–¥—è—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π (—ç—Ç–æ Isolation)
- –ß—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –ø–æ—Å–ª–µ –∫—Ä–∞—Ö–∞ —Å–∏—Å—Ç–µ–º—ã (—ç—Ç–æ Durability)

### üåç –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –≤ Postgres**

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä ‚Äî –ø–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏:

```
–û–ø–µ—Ä–∞—Ü–∏–∏:
1. UPDATE accounts SET balance = balance - 100 WHERE id = 'Alice'
2. UPDATE accounts SET balance = balance + 100 WHERE id = 'Bob'
```

–ë–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏: –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —Å–±–æ–π. –î–µ–Ω—å–≥–∏ —Å–ø–∏—à—É—Ç—Å—è —É Alice, –Ω–æ –Ω–µ –∑–∞—á–∏—Å–ª—è—Ç—Å—è Bob. –î–µ–Ω—å–≥–∏ –ø—Ä–æ—Å—Ç–æ –∏—Å—á–µ–∑–Ω—É—Ç!

–° –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å—é: –µ—Å–ª–∏ –≤—Ç–æ—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, –ø–µ—Ä–≤–∞—è –æ—Ç–∫–∞—Ç–∏—Ç—Å—è. –õ–∏–±–æ –æ–±–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –ª–∏–±–æ –Ω–∏ –æ–¥–Ω–∞.

**–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ e-commerce**

–ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –Ω—É–∂–Ω–æ:
1. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `orders`
2. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å–∏ –≤ `order_items` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
3. –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ `inventory`
4. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ `payments`

–ï—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ —É–ø–∞–¥—ë—Ç –ø–æ—Å–ª–µ —à–∞–≥–∞ 2, –Ω–æ –¥–æ —à–∞–≥–∞ 3 ‚Äî –ø–æ–ª—É—á–∏—Ç—Å—è –∑–∞–∫–∞–∑ –±–µ–∑ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞. –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç: –ª–∏–±–æ —Å–æ–∑–¥–∞—Å—Ç—Å—è –≤–µ—Å—å –∑–∞–∫–∞–∑ —Ü–µ–ª–∏–∫–æ–º, –ª–∏–±–æ –Ω–∏—á–µ–≥–æ.

**Kafka Transactions**

–í Kafka —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–∑–Ω—ã–µ —Ç–æ–ø–∏–∫–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, event-driven —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–∫–∞–∑:
1. –ß–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ `orders-input`
2. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ `inventory-updates`
3. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ `notifications`
4. –ö–æ–º–º–∏—Ç–∏—Ç offset –≤ `orders-input`

–ë–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏: —Å–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –æ–¥–∏–Ω —Ç–æ–ø–∏–∫, –Ω–æ –Ω–µ –≤ –¥—Ä—É–≥–æ–π. –ü–æ–ª—É—á–∏—Ç—Å—è –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

–° –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å—é: –ª–∏–±–æ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –∏ offset –∫–æ–º–º–∏—Ç–∏—Ç—Å—è, –ª–∏–±–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ß–∞—Å—Ç–∏—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑-–∑–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è**

–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–æ –∑–∞–±—ã–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –¥—É–º–∞—è —á—Ç–æ –≤—Å—ë OK.

–ü—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞–ª–∏ –∑–∞–∫–∞–∑ –≤ –ë–î (–æ—Ç–∫–∞—Ç–∏–ª—Å—è), –Ω–æ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ email –∫–ª–∏–µ–Ω—Ç—É "–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç". –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç –ø–∏—Å—å–º–æ –æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∑–∞–∫–∞–∑–µ.

**–°–º–µ—à–∏–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –∏ –Ω–µ—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

–í–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î —Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å HTTP-–∑–∞–ø—Ä–æ—Å –≤–æ –≤–Ω–µ—à–Ω—é—é —Å–∏—Å—Ç–µ–º—É. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –Ω–æ HTTP-–∑–∞–ø—Ä–æ—Å —É–∂–µ —É—à—ë–ª –∏ –Ω–µ –æ—Ç–∫–∞—Ç–∏—Ç—Å—è.

–ü—Ä–∏–º–µ—Ä: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç API –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏, –Ω–æ –¥–µ–Ω—å–≥–∏ —É–∂–µ —Å–ø–∏—Å–∞–ª–∏—Å—å.

**–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π scope —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**

–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π, —Å—á–∏—Ç–∞—è —á—Ç–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ "–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã". –ù–æ –ø—Ä–∏ —Å–±–æ–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è inconsistent state.

–ü—Ä–∏–º–µ—Ä: –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞, –Ω–æ –Ω–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ inventory. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø—Ä–æ–¥–∞–Ω–æ –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–∞, —á–µ–º –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ.

**Application-level rollback –∑–∞–±—ã—Ç**

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ commit —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –æ—Ç–∫–∞—Ç–∏—Ç—Å—è, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å.

–ü—Ä–∏–º–µ—Ä: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–∫–æ–º–º–∏—Ç–∏–ª–∞—Å—å. –ó–∞—Ç–µ–º –∫–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å welcome email, –Ω–æ –ø–∞–¥–∞–µ—Ç. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –≤ –ë–î, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É –∫–ª–∏–µ–Ω—Ç—É.

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–û–ø—Ä–µ–¥–µ–ª—è–π—Ç–µ –≥—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —è–≤–Ω–æ**

–ß—ë—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª—è–π: –∫–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏. –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ A –∏ B –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –≤–º–µ—Å—Ç–µ –∏–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –≤–æ–æ–±—â–µ ‚Äî –æ–Ω–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

**–î–µ—Ä–∂–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏**

–î–ª–∏–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –æ—Ç–∫–∞—Ç–æ–≤. –í–∫–ª—é—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.

–ü–ª–æ—Ö–æ: –Ω–∞—á–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, –≤—ã–ø–æ–ª–Ω–∏—Ç—å HTTP-–∑–∞–ø—Ä–æ—Å (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å —Å–µ–∫—É–Ω–¥—ã), –∑–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î.
–•–æ—Ä–æ—à–æ: –≤—ã–ø–æ–ª–Ω–∏—Ç—å HTTP-–∑–∞–ø—Ä–æ—Å, –∑–∞—Ç–µ–º –≤ –∫–æ—Ä–æ—Ç–∫–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î.

**–ò–∑–±–µ–≥–∞–π –≤–Ω–µ—à–Ω–∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**

–ù–µ –≤—ã–∑—ã–≤–∞–π –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è –æ—Ç–∫–∞—Ç–∏—Ç—å:
- HTTP/gRPC –≤—ã–∑–æ–≤—ã
- –û—Ç–ø—Ä–∞–≤–∫–∞ emails
- –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É
- –í—ã–∑–æ–≤—ã –≤–Ω–µ—à–Ω–∏—Ö API

–ï—Å–ª–∏ –≤–Ω–µ—à–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω—É–∂–Ω—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ø–∞—Ç—Ç–µ—Ä–Ω—ã Outbox –∏–ª–∏ Saga (—Å–º. –Ω–∏–∂–µ).

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π rollback**

–£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç—É
- –ù–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è, –∑–∞–≤–∏—Å—è—â–∏–µ –æ—Ç —É—Å–ø–µ—Ö–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ò—Å–ø–æ–ª—å–∑—É–π idempotent –æ–ø–µ—Ä–∞—Ü–∏–∏**

–ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å retry –ø–æ—Å–ª–µ —Å–±–æ—è, –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç—ã.

---

## 2. Consistency (–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ Invariants)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Consistency** (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–¥–Ω–æ–≥–æ valid —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –¥—Ä—É–≥–æ–µ valid —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Å–æ–±–ª—é–¥–∞—è –≤—Å–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (invariants).

**Invariants** (–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã) ‚Äî —ç—Ç–æ –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏—Å—Ç–∏–Ω–Ω—ã. –ù–∞–ø—Ä–∏–º–µ—Ä: "–±–∞–ª–∞–Ω—Å —Å—á—ë—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º" –∏–ª–∏ "—Å—É–º–º–∞ –≤—Å–µ—Ö –±–∞–ª–∞–Ω—Å–æ–≤ —Ä–∞–≤–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–µ".

### ‚úÖ –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –ü–æ—Å–ª–µ commit —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ (constraints) —Å–æ–±–ª—é–¥–µ–Ω—ã
- –í—Å–µ invariants –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ª–æ–≥–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- Foreign key constraints, unique constraints, check constraints –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

### ‚ùå –ß—Ç–æ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—ç—Ç–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞)
- –ß—Ç–æ invariants —Å–æ–±–ª—é–¥–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–æ –Ω–∞—á–∞–ª–∞ –∏ –ø–æ—Å–ª–µ commit)
- –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏

### üåç –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –≤ Postgres**

Postgres –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ constraints:

`UNIQUE constraint`: Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º. –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º email.

`FOREIGN KEY constraint`: –ö–∞–∂–¥—ã–π –∑–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

`CHECK constraint`: –¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π. –ù–µ–ª—å–∑—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—É—é —Ü–µ–Ω—É.

–ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞—Ä—É—à–∏—Ç—å constraint, Postgres –æ—Ç–∫–∞—Ç–∏—Ç –µ—ë —Ü–µ–ª–∏–∫–æ–º.

**Invariant –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏: Conservation of money**

–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç: "–°—É–º–º–∞ –¥–µ–Ω–µ–≥ –≤–æ –≤—Å–µ—Ö —Å—á–µ—Ç–∞—Ö –ø–æ—Å—Ç–æ—è–Ω–Ω–∞ (–¥–µ–Ω—å–≥–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∏ –Ω–µ –∏—Å—á–µ–∑–∞—é—Ç)".

–ü—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ –¥–µ–Ω–µ–≥:
- –î–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: Alice = 1000, Bob = 500, Total = 1500
- –ü–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: Alice = 900, Bob = 600, Total = 1500

–ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞—Ä—É—à–∏—Ç —ç—Ç–æ—Ç –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ —Å–ø–∏—à–µ—Ç —É Alice, –Ω–æ –Ω–µ –∑–∞—á–∏—Å–ª–∏—Ç Bob), Consistency –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç rollback.

**MongoDB –∏ schema validation**

MongoDB (—Å –≤–µ—Ä—Å–∏–∏ 3.6+) –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç schema validation. –ú–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å JSON Schema, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞.

–ü—Ä–∏–º–µ—Ä: –¥–æ–∫—É–º–µ–Ω—Ç –∑–∞–∫–∞–∑–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª—è `userId`, `items`, `totalPrice`, –≥–¥–µ `totalPrice` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–≤–µ–Ω —Å—É–º–º–µ —Ü–µ–Ω items.

–ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑, –Ω–∞—Ä—É—à–∞—é—â–∏–π schema, MongoDB –æ—Ç–∫–∞—Ç–∏—Ç –µ—ë.

**Distributed invariants: –ø—Ä–æ–±–ª–µ–º–∞**

–ü—Ä–µ–¥—Å—Ç–∞–≤—å –¥–≤–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞:
- `order-service` (—Å–≤–æ—è –ë–î)
- `inventory-service` (—Å–≤–æ—è –ë–î)

Invariant: "–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ".

–ü—Ä–æ–±–ª–µ–º–∞: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ Postgres –Ω–µ –º–æ–∂–µ—Ç –æ–±–µ—Å–ø–µ—á–∏—Ç—å consistency –º–µ–∂–¥—É –¥–≤—É–º—è —Ä–∞–∑–Ω—ã–º–∏ –ë–î. –≠—Ç–æ —Ç—Ä–µ–±—É–µ—Ç distributed transactions –∏–ª–∏ Saga patterns.

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**Deferred constraint checking**

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ë–î (–≤–∫–ª—é—á–∞—è Postgres) –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É constraints –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º rollback'–∞–º –≤ –∫–æ–Ω—Ü–µ –¥–æ–ª–≥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

–ü—Ä–∏–º–µ—Ä: –≤—Å—Ç–∞–≤–ª—è–µ—à—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π —Å foreign keys. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è. –í –∫–æ–Ω—Ü–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ –æ–¥–Ω–∞ –∏–∑ –∑–∞–ø–∏—Å–µ–π —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ID ‚Äî –≤—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è.

**Race condition –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ invariants**

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç invariant, –∑–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é. –ù–æ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –æ–ø–µ—Ä–∞—Ü–∏–µ–π –¥—Ä—É–≥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∏–∑–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ, –Ω–∞—Ä—É—à–∞—è invariant.

–ü—Ä–∏–º–µ—Ä:
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º: –Ω–∞ —Å–∫–ª–∞–¥–µ 5 —Ç–æ–≤–∞—Ä–æ–≤
2. –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ –Ω–∞ 3 —Ç–æ–≤–∞—Ä–∞
3. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –¥—Ä—É–≥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑ –Ω–∞ 3 —Ç–æ–≤–∞—Ä–∞
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø—Ä–æ–¥–∞–Ω–æ 6 —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ç–æ–ª—å–∫–æ 5

–†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π isolation level –∏–ª–∏ database constraints.

**Application-level invariants –Ω–µ –≤ –ë–î**

Invariant –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –Ω–æ –Ω–µ –≤ –ë–î —á–µ—Ä–µ–∑ constraints. –î—Ä—É–≥–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –ë–î –º–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å invariant.

–ü—Ä–∏–º–µ—Ä: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç "–±–∞–ª–∞–Ω—Å >= 0", –Ω–æ –≤ –ë–î –Ω–µ—Ç CHECK constraint. DBA –≤—ã–ø–æ–ª–Ω—è–µ—Ç UPDATE –≤—Ä—É—á–Ω—É—é, —Å–æ–∑–¥–∞–≤–∞—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å.

**Inconsistency –∏–∑-–∑–∞ eventual consistency**

–í —Å–∏—Å—Ç–µ–º–∞—Ö —Å eventual consistency (–Ω–∞–ø—Ä–∏–º–µ—Ä, MongoDB –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, Cassandra) –≤–æ–∑–º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ invariants.

–ü—Ä–∏–º–µ—Ä: –≤ MongoDB —Å–æ–∑–¥–∞–ª–∏ –∑–∞–∫–∞–∑, –∑–∞—Ç–µ–º —É–º–µ–Ω—å—à–∏–ª–∏ inventory. –ú–µ–∂–¥—É —ç—Ç–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª. –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, inventory –Ω–µ —É–º–µ–Ω—å—à–µ–Ω.

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–ò—Å–ø–æ–ª—å–∑—É–π database constraints**

–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤—ã—Ä–∞–∂–∞–π invariants —á–µ—Ä–µ–∑ database constraints (UNIQUE, FOREIGN KEY, CHECK). –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏—Ö —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–û–ø—Ä–µ–¥–µ–ª—è–π invariants —è–≤–Ω–æ**

–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π –≤—Å–µ –±–∏–∑–Ω–µ—Å-invariants. –ü–æ–Ω–∏–º–∞–π, –∫–∞–∫–∏–µ –∏–∑ –Ω–∏—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã, –∞ –∫–∞–∫–∏–µ –º–æ–≥—É—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞—Ä—É—à–∞—Ç—å—Å—è.

**–í—ã–±–∏—Ä–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π isolation level**

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ invariants —Ç—Ä–µ–±—É—é—Ç —Å—Ç—Ä–æ–≥–æ–π –∏–∑–æ–ª—è—Ü–∏–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, "–Ω–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ" —Ç—Ä–µ–±—É–µ—Ç Serializable isolation –∏–ª–∏ SELECT FOR UPDATE.

**–ò—Å–ø–æ–ª—å–∑—É–π optimistic locking –¥–ª—è application-level invariants**

–ï—Å–ª–∏ invariant –Ω–µ–ª—å–∑—è –≤—ã—Ä–∞–∑–∏—Ç—å —á–µ—Ä–µ–∑ DB constraint, –∏—Å–ø–æ–ª—å–∑—É–π version/timestamp –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è concurrent updates.

**–¢–µ—Å—Ç–∏—Ä—É–π –Ω–∞—Ä—É—à–µ–Ω–∏—è constraints**

–ü–∏—à–∏ —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—ã—Ç–∞—é—Ç—Å—è –Ω–∞—Ä—É—à–∏—Ç—å constraints –∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç, —á—Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è.

---

## 3. Isolation (–ò–∑–æ–ª—è—Ü–∏—è)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Isolation** (–∏–∑–æ–ª—è—Ü–∏—è) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–æ –æ—Ç –¥—Ä—É–≥–∏—Ö concurrent —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –≠—Ç–æ —Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ –∏ –º–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ ACID.

### –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏

–°—É—â–µ—Å—Ç–≤—É–µ—Ç 4 —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏ (–æ—Ç —Å–ª–∞–±–æ–≥–æ –∫ —Å–∏–ª—å–Ω–æ–º—É):

```
Read Uncommitted ‚Üí Read Committed ‚Üí Repeatable Read ‚Üí Serializable
       ‚Üì                  ‚Üì                ‚Üì                ‚Üì
   –°–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π                                   –°–∞–º—ã–π –º–µ–¥–ª–µ–Ω–Ω—ã–π
   –ú–Ω–æ–≥–æ –∞–Ω–æ–º–∞–ª–∏–π                                  –ù–µ—Ç –∞–Ω–æ–º–∞–ª–∏–π
```

### üé≠ Isolation Anomalies (–ê–Ω–æ–º–∞–ª–∏–∏ –∏–∑–æ–ª—è—Ü–∏–∏)

–°–ª–∞–±—ã–µ —É—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ –¥–æ–ø—É—Å–∫–∞—é—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏:

**Dirty Read (–ì—Ä—è–∑–Ω–æ–µ —á—Ç–µ–Ω–∏–µ)**

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è T1 —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–º–µ–Ω–∏–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è T2, –Ω–æ T2 –µ—â—ë –Ω–µ –∑–∞–∫–æ–º–º–∏—Ç–∏–ª–∞—Å—å (–∏ –º–æ–∂–µ—Ç –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è).

```
–í—Ä–µ–º—è    T1                          T2
  1                                  UPDATE balance = 500 WHERE id = 1
  2      SELECT balance WHERE id = 1
         -> –≤–∏–¥–∏—Ç 500
  3                                  ROLLBACK
  4      –ò—Å–ø–æ–ª—å–∑—É–µ—Ç balance = 500
         –ù–û! –≠—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ!
```

**Non-Repeatable Read (–ù–µ–ø–æ–≤—Ç–æ—Ä—è–µ–º–æ–µ —á—Ç–µ–Ω–∏–µ)**

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è T1 —á–∏—Ç–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–≤–∞–∂–¥—ã –∏ –ø–æ–ª—É—á–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –ø–æ—Ç–æ–º—É —á—Ç–æ T2 –∏–∑–º–µ–Ω–∏–ª–∞ –∏ –∑–∞–∫–æ–º–º–∏—Ç–∏–ª–∞ –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —ç—Ç–∏–º–∏ —á—Ç–µ–Ω–∏—è–º–∏.

```
–í—Ä–µ–º—è    T1                          T2
  1      SELECT balance WHERE id = 1
         -> –≤–∏–¥–∏—Ç 1000
  2                                  UPDATE balance = 500 WHERE id = 1
  3                                  COMMIT
  4      SELECT balance WHERE id = 1
         -> –≤–∏–¥–∏—Ç 500
         –î–≤–∞ —á—Ç–µ–Ω–∏—è –¥–∞–ª–∏ —Ä–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!
```

**Phantom Read (–§–∞–Ω—Ç–æ–º–Ω–æ–µ —á—Ç–µ–Ω–∏–µ)**

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è T1 –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–≤–∞–∂–¥—ã –∏ –ø–æ–ª—É—á–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ –Ω–∞–±–æ—Ä—ã —Å—Ç—Ä–æ–∫, –ø–æ—Ç–æ–º—É —á—Ç–æ T2 –≤—Å—Ç–∞–≤–∏–ª–∞/—É–¥–∞–ª–∏–ª–∞ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.

```
–í—Ä–µ–º—è    T1                                    T2
  1      SELECT COUNT(*) FROM orders
         WHERE status = 'pending'
         -> –≤–∏–¥–∏—Ç 5
  2                                            INSERT INTO orders ...
                                               (status = 'pending')
  3                                            COMMIT
  4      SELECT COUNT(*) FROM orders
         WHERE status = 'pending'
         -> –≤–∏–¥–∏—Ç 6
         –ü–æ—è–≤–∏–ª–∞—Å—å "—Ñ–∞–Ω—Ç–æ–º–Ω–∞—è" —Å—Ç—Ä–æ–∫–∞!
```

**Write Skew (–ü–µ—Ä–µ–∫–æ—Å –∑–∞–ø–∏—Å–∏)**

–î–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–∏—Ç–∞—é—Ç –æ–¥–Ω–∏ –¥–∞–Ω–Ω—ã–µ, –ø—Ä–∏–Ω–∏–º–∞—é—Ç —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ, –∏ –æ–±–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç ‚Äî –Ω–∞—Ä—É—à–∞—è invariant.

```
Invariant: "–•–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–æ–∫—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å on-call"

–í—Ä–µ–º—è    T1 (Alice)                   T2 (Bob)
  1      SELECT COUNT(*)              SELECT COUNT(*)
         FROM oncall                  FROM oncall
         -> –≤–∏–¥–∏—Ç 2                   -> –≤–∏–¥–∏—Ç 2
  2      –†–µ—à–∞–µ—Ç: –º–æ–∂–Ω–æ —Å–Ω—è—Ç—å—Å—è        –†–µ—à–∞–µ—Ç: –º–æ–∂–Ω–æ —Å–Ω—è—Ç—å—Å—è
  3      UPDATE oncall                UPDATE oncall
         SET status = 'off'           SET status = 'off'
         WHERE doctor = 'Alice'       WHERE doctor = 'Bob'
  4      COMMIT                       COMMIT

–†–µ–∑—É–ª—å—Ç–∞—Ç: 0 –¥–æ–∫—Ç–æ—Ä–æ–≤ on-call! Invariant –Ω–∞—Ä—É—à–µ–Ω.
```

**Lost Update (–ü–æ—Ç–µ—Ä—è–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)**

–î–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–∏—Ç–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ, –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç –µ–≥–æ, –∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç –æ–±—Ä–∞—Ç–Ω–æ ‚Äî –æ–¥–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥—Ä—É–≥–æ–µ.

```
–í—Ä–µ–º—è    T1                          T2
  1      SELECT value = 10
  2                                  SELECT value = 10
  3      value = value + 5 = 15
  4                                  value = value + 3 = 13
  5      UPDATE value = 15
  6                                  UPDATE value = 13
  7      COMMIT
  8                                  COMMIT

–†–µ–∑—É–ª—å—Ç–∞—Ç: value = 13. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ +5 –ø–æ—Ç–µ—Ä—è–Ω–æ!
```

### –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π –∏–∑–æ–ª—è—Ü–∏–∏ –∏ –∞–Ω–æ–º–∞–ª–∏–π

| Isolation Level    | Dirty Read | Non-Repeatable Read | Phantom Read | Write Skew | Lost Update |
|--------------------|------------|---------------------|--------------|------------|-------------|
| Read Uncommitted   | ‚úó –í–æ–∑–º–æ–∂–Ω–æ | ‚úó –í–æ–∑–º–æ–∂–Ω–æ          | ‚úó –í–æ–∑–º–æ–∂–Ω–æ   | ‚úó –í–æ–∑–º–æ–∂–Ω–æ | ‚úó –í–æ–∑–º–æ–∂–Ω–æ  |
| Read Committed     | ‚úì –ù–µ—Ç      | ‚úó –í–æ–∑–º–æ–∂–Ω–æ          | ‚úó –í–æ–∑–º–æ–∂–Ω–æ   | ‚úó –í–æ–∑–º–æ–∂–Ω–æ | ‚úó –í–æ–∑–º–æ–∂–Ω–æ  |
| Repeatable Read    | ‚úì –ù–µ—Ç      | ‚úì –ù–µ—Ç               | ‚úó –í–æ–∑–º–æ–∂–Ω–æ * | ‚úó –í–æ–∑–º–æ–∂–Ω–æ | ‚úì –ù–µ—Ç       |
| Serializable       | ‚úì –ù–µ—Ç      | ‚úì –ù–µ—Ç               | ‚úì –ù–µ—Ç        | ‚úì –ù–µ—Ç      | ‚úì –ù–µ—Ç       |

_* Postgres Repeatable Read –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç phantom reads_

### üåç –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**Read Committed –≤ Postgres (default)**

Postgres –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Read Committed. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç:
- –ù–µ —É–≤–∏–¥–∏—à—å uncommitted –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–Ω–µ—Ç dirty reads)
- –ù–æ –º–æ–∂–µ—à—å —É–≤–∏–¥–µ—Ç—å —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º —á—Ç–µ–Ω–∏–∏ (non-repeatable reads OK)

–ü—Ä–∏–º–µ—Ä: –æ—Ç—á—ë—Ç –æ –±–∞–ª–∞–Ω—Å–∞—Ö —Å—á–µ—Ç–æ–≤. –ß–∏—Ç–∞–µ—à—å –±–∞–ª–∞–Ω—Å Alice = 1000, –∑–∞—Ç–µ–º Bob = 500. –ú–µ–∂–¥—É —ç—Ç–∏–º–∏ —á—Ç–µ–Ω–∏—è–º–∏ –ø—Ä–æ–∏–∑–æ—à—ë–ª –ø–µ—Ä–µ–≤–æ–¥ Alice ‚Üí Bob. –ß–∏—Ç–∞–µ—à—å Alice –ø–æ–≤—Ç–æ—Ä–Ω–æ = 900. –°—É–º–º–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –Ω–µ —Å—Ö–æ–¥–∏—Ç—Å—è!

**Repeatable Read –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç —Ç—Ä–µ–±—É–µ—Ç consistent snapshot –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–µ—à—å Repeatable Read:
- –í—Å–µ —á—Ç–µ–Ω–∏—è –≤–∏–¥—è—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î (snapshot)
- –î–∞–∂–µ –µ—Å–ª–∏ –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ ‚Äî —Ç—ã –≤–∏–¥–∏—à—å —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –û—Ç—á—ë—Ç –±—É–¥–µ—Ç internally consistent

**Serializable –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

–ü—Ä–æ–¥–∞–∂–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–∏–ª–µ—Ç–æ–≤ –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç). Invariant: "–Ω–µ–ª—å–∑—è –ø—Ä–æ–¥–∞—Ç—å –±–æ–ª—å—à–µ –±–∏–ª–µ—Ç–æ–≤, —á–µ–º –µ—Å—Ç—å".

–° Repeatable Read –≤–æ–∑–º–æ–∂–µ–Ω write skew:
- T1 –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: available = 2, –ø—Ä–æ–¥–∞—ë—Ç 2 –±–∏–ª–µ—Ç–∞
- T2 –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: available = 2, –ø—Ä–æ–¥–∞—ë—Ç 2 –±–∏–ª–µ—Ç–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø—Ä–æ–¥–∞–Ω–æ 4 –±–∏–ª–µ—Ç–∞ –≤–º–µ—Å—Ç–æ 2

–° Serializable –æ–¥–Ω–∞ –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –æ—Ç–∫–∞—Ç–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π serialization failure.

**MongoDB Snapshot Isolation**

MongoDB (–≤ replica set —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏) –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Snapshot Isolation ‚Äî –ø–æ—Ö–æ–∂–µ –Ω–∞ Repeatable Read:
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç consistent snapshot –¥–∞–Ω–Ω—ã—Ö
- –ù–µ –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ù–æ –≤–æ–∑–º–æ–∂–Ω—ã –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, write skew –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö)

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Read Committed –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö stronger isolation**

–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ Read Committed –¥–æ–ø—É—Å–∫–∞–µ—Ç non-repeatable reads. –ü–∏—à–µ—Ç –∫–æ–¥, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é—â–∏–π consistent view –¥–∞–Ω–Ω—ã—Ö.

–ü—Ä–∏–º–µ—Ä: –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ aggregates (SUM, COUNT) –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ú–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω—è—é—Ç—Å—è, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.

**Serialization failures –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã**

–ü—Ä–∏ Serializable isolation –ë–î –º–æ–∂–µ—Ç –æ—Ç–∫–∞—Ç–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –æ—à–∏–±–∫–æ–π "serialization failure". –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ retry.

–ü—Ä–∏–º–µ—Ä: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç—É –æ—à–∏–±–∫—É. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "Internal Server Error" –≤–º–µ—Å—Ç–æ —É—Å–ø–µ—à–Ω–æ–π retry.

**Deadlocks –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π concurrency**

–î–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç locks –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ ‚Äî deadlock. –ë–î –æ—Ç–∫–∞—Ç–∏—Ç –æ–¥–Ω—É –∏–∑ –Ω–∏—Ö.

–ü—Ä–∏–º–µ—Ä:
- T1: UPDATE table A, –ø–æ—Ç–æ–º table B
- T2: UPDATE table B, –ø–æ—Ç–æ–º table A
- Deadlock! –û–¥–Ω–∞ –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –æ—Ç–∫–∞—Ç–∏—Ç—Å—è.

**False sense of safety —Å Repeatable Read**

Repeatable Read –Ω–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∞–Ω–æ–º–∞–ª–∏–∏. Write skew –≤—Å—ë –µ—â—ë –≤–æ–∑–º–æ–∂–µ–Ω.

–ü—Ä–∏–º–µ—Ä: –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç, —á—Ç–æ Repeatable Read = Serializable. Invariant –Ω–∞—Ä—É—à–∞–µ—Ç—Å—è –∏–∑-–∑–∞ write skew.

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–í—ã–±–∏—Ä–∞–π isolation level –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ**

–†–∞–∑–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –∏–∑–æ–ª—è—Ü–∏–∏:
- –ß—Ç–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: Read Committed OK
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã: Repeatable Read
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å invariants: Serializable –∏–ª–∏ explicit locking

**–ò—Å–ø–æ–ª—å–∑—É–π SELECT FOR UPDATE –¥–ª—è explicit locking**

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å—Ç—Ä–æ–∫—É –∏ –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –µ—ë, –∏—Å–ø–æ–ª—å–∑—É–π `SELECT ... FOR UPDATE`. –≠—Ç–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç lock –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç lost updates.

**–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π serialization failures**

–ü—Ä–∏ Serializable isolation –±—É–¥—å –≥–æ—Ç–æ–≤ –∫ –æ—à–∏–±–∫–∞–º "could not serialize access". –†–µ–∞–ª–∏–∑—É–π retry —Å exponential backoff.

**–ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è locks**

–ö–æ—Ä–æ—Ç–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ = –º–µ–Ω—å—à–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤. –ù–µ –¥–µ–ª–∞–π –º–µ–¥–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (HTTP calls) –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

**–ò—Å–ø–æ–ª—å–∑—É–π optimistic locking –¥–ª—è long-running transactions**

–ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–ª–≥–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, user interaction), –∏—Å–ø–æ–ª—å–∑—É–π version column:
- –ß–∏—Ç–∞–µ—à—å —Å—Ç—Ä–æ–∫—É —Å –≤–µ—Ä—Å–∏–µ–π V1
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç
- –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: UPDATE ... WHERE version = V1
- –ï—Å–ª–∏ version –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Äî –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π –æ–±–Ω–æ–≤–∏–ª —Å—Ç—Ä–æ–∫—É

**–¢–µ—Å—Ç–∏—Ä—É–π concurrent scenarios**

–ü–∏—à–∏ integration —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–∏–º—É–ª–∏—Ä—É—é—Ç concurrent —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç, —á—Ç–æ invariants —Å–æ–±–ª—é–¥–∞—é—Ç—Å—è.

---

## 4. Durability (–î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Durability** (–¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ commit —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã permanently –∏ –ø–µ—Ä–µ–∂–∏–≤—É—Ç –ª—é–±–æ–π —Å–±–æ–π —Å–∏—Å—Ç–µ–º—ã (crash, power failure, etc.).

### ‚úÖ –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –ü–æ—Å–ª–µ COMMIT –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ persistent storage (–¥–∏—Å–∫)
- –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∂–∏–≤—É—Ç crash —Å–µ—Ä–≤–µ—Ä–∞
- –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∂–∏–≤—É—Ç power failure
- –î–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ restart

### ‚ùå –ß—Ç–æ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –ó–∞—â–∏—Ç—É –æ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑—Ä—É—à–µ–Ω–∏—è –¥–∏—Å–∫–∞ (–Ω—É–∂–Ω—ã backups/replication)
- –ó–∞—â–∏—Ç—É –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
- –ß—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ—Å–ª–µ crash (–Ω—É–∂–Ω–æ –≤—Ä–µ–º—è –Ω–∞ recovery)
- –ó–∞—â–∏—Ç—É –æ—Ç –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–∞ (–Ω—É–∂–Ω–∞ geographical replication)

### üåç –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**Write-Ahead Log (WAL) –≤ Postgres**

Postgres –∏—Å–ø–æ–ª—å–∑—É–µ—Ç WAL –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è durability:
1. –ü–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º data files Postgres –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ WAL
2. WAL –ø–∏—à–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–±—ã—Å—Ç—Ä–æ)
3. COMMIT –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ fsync WAL –Ω–∞ –¥–∏—Å–∫
4. Data files –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (background process)

–ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–¥—ë—Ç –ø–æ—Å–ª–µ COMMIT:
- WAL —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ committed –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Postgres —á–∏—Ç–∞–µ—Ç WAL –∏ replay –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è

**Kafka Log Segments**

Kafka —Ö—Ä–∞–Ω–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ log segments –Ω–∞ –¥–∏—Å–∫–µ:
- Producer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- Kafka –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ segment –∏ –¥–µ–ª–∞–µ—Ç fsync (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
- Producer –ø–æ–ª—É—á–∞–µ—Ç acknowledgement —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏
- –î–∞–∂–µ –ø–æ—Å–ª–µ crash —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –¥–∏—Å–∫–µ

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `acks=all`: Producer –∂–¥—ë—Ç, –ø–æ–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç—Å—è –Ω–∞ N replicas. Durability –ø—Ä–æ—Ç–∏–≤ –ø–æ—Ç–µ—Ä–∏ —Ü–µ–ª–æ–≥–æ –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–∞.

**MongoDB —Å journaling**

MongoDB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç journal (–ø–æ—Ö–æ–∂–µ –Ω–∞ WAL):
- –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ journal
- Journal fsync –∫–∞–∂–¥—ã–µ 100ms (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- COMMIT –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ fsync journal
- Actual data files –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ–∑–∂–µ

–ï—Å–ª–∏ MongoDB crash'–∏—Ç—Å—è:
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —á–∏—Ç–∞–µ—Ç journal
- Replay –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ checkpoint
- –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è

**Redis —Å AOF (Append-Only File)**

Redis ‚Äî in-memory –ë–î, –Ω–æ –º–æ–∂–µ—Ç –æ–±–µ—Å–ø–µ—á–∏—Ç—å durability —á–µ—Ä–µ–∑ AOF:
- –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø–∏—Å–∏ append'–∏—Ç—Å—è –≤ AOF
- –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å fsync: always, every second, –∏–ª–∏ never
- `fsync=always`: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è durability, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–æ
- `fsync=everysec`: –∫–æ–º–ø—Ä–æ–º–∏—Å—Å (–ø–æ—Ç–µ—Ä—è –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ crash)

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**Fsync disabled –¥–ª—è performance**

–î–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–∫–ª—é—á–∞—é—Ç fsync. COMMIT –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –≤ OS buffer, –Ω–æ –¥–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∑–∞–ø–∏—Å–∏ –Ω–∞ –¥–∏—Å–∫.

–ü—Ä–∏–º–µ—Ä: Postgres —Å `fsync=off`. –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç COMMIT, –Ω–æ –¥–∞–Ω–Ω—ã–µ –µ—â—ë –≤ RAM. Power failure ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ COMMIT.

**Disk write cache –±–µ–∑ battery backup**

–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∏—Å–∫–∏ –∏–º–µ—é—Ç write cache (RAM –Ω–∞ –¥–∏—Å–∫–µ). Fsync –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ, –Ω–æ –¥–∞–Ω–Ω—ã–µ –µ—â—ë –≤ cache, –Ω–µ –Ω–∞ –ø–ª–∞—Å—Ç–∏–Ω–∞—Ö.

Power failure ‚Üí –¥–∞–Ω–Ω—ã–µ –≤ disk cache –ø–æ—Ç–µ—Ä—è–Ω—ã. –†–µ—à–µ–Ω–∏–µ: battery-backed write cache –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ disk cache.

**Replication lag –∫–∞–∫ –∏–ª–ª—é–∑–∏—è durability**

–î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ master –∏ replica, –Ω–æ replica –æ—Ç—Å—Ç–∞—ë—Ç –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥. Master –ø–∞–¥–∞–µ—Ç, replica —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–æ–≤—ã–º master ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–µ–∫—É–Ω–¥ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Ç–µ—Ä—è–Ω—ã.

–ü—Ä–∏–º–µ—Ä: —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–∫–æ–º–º–∏—Ç–∏–ª–∞—Å—å –Ω–∞ master, –Ω–æ –Ω–µ –¥–æ—à–ª–∞ –¥–æ replica. Master —É–ø–∞–ª. Replica —Å—Ç–∞–ª–∞ –Ω–æ–≤—ã–º master. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞.

**Backup restore –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ data loss**

Backups –¥–µ–ª–∞—é—Ç—Å—è —Ä–∞–∑ –≤ –¥–µ–Ω—å. –ë–î –ø–∞–¥–∞–µ—Ç. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ—Å—å —Å backup –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è ‚Äî –ø–æ—Ç–µ—Ä—è 24 —á–∞—Å–æ–≤ –¥–∞–Ω–Ω—ã—Ö.

–†–µ—à–µ–Ω–∏–µ: Point-in-Time Recovery (PITR) —á–µ—Ä–µ–∑ WAL archives –∏–ª–∏ continuous backup.

**Corruption –Ω–∞ –¥–∏—Å–∫–µ**

Durability –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥–∏—Å–∫–µ, –Ω–æ –Ω–µ —á—Ç–æ –¥–∏—Å–∫ –Ω–µ corrupted. Bit rot, disk failures –º–æ–≥—É—Ç –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.

–†–µ—à–µ–Ω–∏–µ: checksums, replication, regular backup verification.

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–í–∫–ª—é—á–∞–π fsync –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

–î–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∑–∞–∫–∞–∑–æ–≤, user data ‚Äî –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–∫–ª—é—á–∞–π fsync. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–∞, –Ω–æ –Ω–µ –≤–∞–∂–Ω–µ–µ data integrity.

**–ò—Å–ø–æ–ª—å–∑—É–π replication –¥–ª—è availability –∏ durability**

- Synchronous replication: COMMIT —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ N replicas (–≤—ã—Å–æ–∫–∞—è durability, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
- Asynchronous replication: COMMIT –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ master (–±—ã—Å—Ç—Ä–µ–µ, –Ω–æ —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ failover)

**–î–µ–ª–∞–π regular backups –∏ —Ç–µ—Å—Ç–∏—Ä—É–π restore**

- Backups –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º–∏
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ç–µ—Å—Ç–∏—Ä—É–π restore –ø—Ä–æ—Ü–µ–¥—É—Ä—É
- –•—Ä–∞–Ω–∏ backups off-site (–∑–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–∞)

**–ò—Å–ø–æ–ª—å–∑—É–π PITR –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ data loss**

Point-in-Time Recovery —á–µ—Ä–µ–∑ WAL/journal archives –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∫ –ª—é–±–æ–π —Å–µ–∫—É–Ω–¥–µ –≤ –ø—Ä–æ—à–ª–æ–º.

**–ú–æ–Ω–∏—Ç–æ—Ä—å replication lag**

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å replication, –º–æ–Ω–∏—Ç–æ—Ä—å lag –º–µ–∂–¥—É master –∏ replicas. –ë–æ–ª—å—à–æ–π lag = —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ failover.

**–ò—Å–ø–æ–ª—å–∑—É–π geographical replication –¥–ª—è disaster recovery**

–î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–∏—Å—Ç–µ–º —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω—ã–µ geographical locations. –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–∞.

---

## 5. Exactly-Once Effects (–≠—Ñ—Ñ–µ–∫—Ç—ã –†–æ–≤–Ω–æ –û–¥–∏–Ω –†–∞–∑)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Exactly-Once Effects** ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–µ–¥—ë—Ç —Å–≤–æ–π side effect —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑, –¥–∞–∂–µ –ø—Ä–∏ retries –∏ failures.

–í–∞–∂–Ω–æ —Ä–∞–∑–ª–∏—á–∞—Ç—å:
- **Exactly-Once Delivery**: —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ (—á–∞—Å—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ)
- **Exactly-Once Processing**: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ (–≤–æ–∑–º–æ–∂–Ω–æ —Å idempotency)
- **Exactly-Once Effects**: side effect –ø—Ä–æ–∏–∑–æ—à—ë–ª —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ (—Ç—Ä–µ–±—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–ª–∏ idempotency)

### ‚úÖ –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è external observer
- –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è side effects (duplicate charges, duplicate orders)
- –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ side effects (missing charges, missing orders)
- –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ –±—É–¥—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å –µ–¥–∏–Ω–æ–∂–¥—ã

### ‚ùå –ß—Ç–æ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –ß—Ç–æ –∫–æ–¥ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ (–º–æ–≥—É—Ç –±—ã—Ç—å retries)
- –ß—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ —Å–µ—Ç–∏
- –ò–¥–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏)

### üåç –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**Kafka Exactly-Once Semantics (EOS)**

Kafka –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç exactly-once —á–µ—Ä–µ–∑ transactional producer –∏ idempotent producer:

–°—Ü–µ–Ω–∞—Ä–∏–π: —á–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ç–æ–ø–∏–∫–∞ A, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º, –ø–∏—à–µ–º –≤ —Ç–æ–ø–∏–∫ B, –∫–æ–º–º–∏—Ç–∏–º offset –≤ A.

–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ EOS:
- –ó–∞–ø–∏—Å–∞–ª–∏ –≤ B, –Ω–æ crash –¥–æ –∫–æ–º–º–∏—Ç–∞ offset –≤ A ‚Üí –ø—Ä–∏ restart –∑–∞–ø–∏—à–µ–º –≤ B —Å–Ω–æ–≤–∞ (duplicate)
- –ó–∞–∫–æ–º–º–∏—Ç–∏–ª–∏ offset, –Ω–æ crash –¥–æ –∑–∞–ø–∏—Å–∏ –≤ B ‚Üí –ø–æ—Ç–µ—Ä—è–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ

–° EOS:
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∑–∞–ø–∏—Å—å –≤ B + –∫–æ–º–º–∏—Ç offset –≤ A) –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –õ–∏–±–æ –æ–±–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –ª–∏–±–æ –Ω–∏ –æ–¥–Ω–∞
- Consumer —Å `isolation.level=read_committed` –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ committed —Å–æ–æ–±—â–µ–Ω–∏—è

**Idempotent API —Å deduplication key**

Payment API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç idempotency key:

```
POST /payments
{
  "idempotency_key": "order-12345",
  "amount": 100,
  "user_id": "alice"
}
```

–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å retry:
- –ü–µ—Ä–≤—ã–π —Ä–∞–∑: —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–ª–∞—Ç—ë–∂, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 200 OK
- Retry —Å —Ç–µ–º –∂–µ key: API –≤–∏–¥–∏—Ç, —á—Ç–æ –ø–ª–∞—Ç—ë–∂ —Å —Ç–∞–∫–∏–º key —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç 200 OK
- –î–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑

**Database unique constraint –¥–ª—è idempotency**

–¢–∞–±–ª–∏—Ü–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º constraint –Ω–∞ request ID:

```
CREATE TABLE payments (
  id SERIAL PRIMARY KEY,
  request_id UUID UNIQUE NOT NULL,
  amount INT,
  user_id INT
)
```

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:
- –ü—ã—Ç–∞–µ–º—Å—è INSERT —Å request_id
- –ï—Å–ª–∏ request_id —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí constraint violation ‚Üí –∑–Ω–∞—á–∏—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏
- –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Üí –ø–µ—Ä–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

**At-Least-Once + Idempotency = Exactly-Once Effects**

–°–∏—Å—Ç–µ–º–∞ —Å at-least-once delivery (–Ω–∞–ø—Ä–∏–º–µ—Ä, RabbitMQ):
- –°–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å delivered –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ idempotent: –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç duplicate effects
- –†–µ–∑—É–ª—å—Ç–∞—Ç: exactly-once effects

–ü—Ä–∏–º–µ—Ä: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫–∞–∑–æ–≤. –°–æ–æ–±—â–µ–Ω–∏–µ "create order 12345" –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –¥–≤–∞–∂–¥—ã, –Ω–æ ORDER —Å–æ–∑–¥–∞—Å—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –±–ª–∞–≥–æ–¥–∞—Ä—è UNIQUE constraint –Ω–∞ order_id.

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**Retry –±–µ–∑ idempotency**

–û–ø–µ—Ä–∞—Ü–∏—è retry –ø–æ—Å–ª–µ timeout, –Ω–µ –∑–Ω–∞—è —á—Ç–æ –ø–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å.

–ü—Ä–∏–º–µ—Ä: —Å–ø–∏—Å–∞–Ω–∏–µ –¥–µ–Ω–µ–≥ —Å–æ —Å—á—ë—Ç–∞. Timeout –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ. Retry ‚Üí –¥–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å –¥–≤–∞–∂–¥—ã.

**Idempotency key –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è**

API –ø—Ä–æ–≤–µ—Ä—è–µ—Ç idempotency key –≤ –ø–∞–º—è—Ç–∏, –Ω–æ –Ω–µ –≤ –ë–î. –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è ‚Äî memory lost ‚Äî retry —Å–æ–∑–¥–∞—ë—Ç duplicate.

**Partial failure –≤ distributed system**

–û–ø–µ—Ä–∞—Ü–∏—è —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —à–∞–≥–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö. –û–¥–∏–Ω —à–∞–≥ —É—Å–ø–µ—à–µ–Ω, –¥—Ä—É–≥–æ–π fail. Retry ‚Üí –ø–µ—Ä–≤—ã–π —à–∞–≥ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è.

–ü—Ä–∏–º–µ—Ä:
1. –°–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏ —Å –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞ (—É—Å–ø–µ—Ö)
2. –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ –≤ –ë–î (fail)
3. Retry: —Å–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏ —Å–Ω–æ–≤–∞ (duplicate charge)

**Idempotency key conflicts**

–î–≤–∞ —Ä–∞–∑–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ —Å–ª—É—á–∞–π–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π idempotency key. –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, –≤—Ç–æ—Ä–æ–π –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–≤–æ–≥–æ.

–†–µ—à–µ–Ω–∏–µ: idempotency key –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º per client (–Ω–∞–ø—Ä–∏–º–µ—Ä, `client_id + request_id`).

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–î–µ–ª–∞–π –æ–ø–µ—Ä–∞—Ü–∏–∏ idempotent**

–ì–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–π –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–∞–∫, —á—Ç–æ–±—ã –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ safely retry:
- SET operations –≤–º–µ—Å—Ç–æ INCREMENT
- UPSERT –≤–º–µ—Å—Ç–æ INSERT
- DELETE WHERE –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç)

**–ò—Å–ø–æ–ª—å–∑—É–π unique constraints –¥–ª—è deduplication**

–î–æ–±–∞–≤–ª—è–π –≤ –ë–î unique constraint –Ω–∞ request_id/idempotency_key. Constraint enforcement –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç no duplicates.

**–°–æ—Ö—Ä–∞–Ω—è–π idempotency keys persistently**

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å idempotency keys, —Å–æ—Ö—Ä–∞–Ω—è–π –∏—Ö –≤ –ë–î, –Ω–µ –≤ –ø–∞–º—è—Ç–∏. –ò–Ω–∞—á–µ restart —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ loss of deduplication info.

**–ò—Å–ø–æ–ª—å–∑—É–π transactions –¥–ª—è atomicity**

–ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —à–∞–≥–æ–≤, –æ–±–æ—Ä–∞—á–∏–≤–∞–π –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é. –õ–∏–±–æ –≤—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –ª–∏–±–æ –Ω–∏ –æ–¥–∏–Ω.

**–ì–µ–Ω–µ—Ä–∏—Ä—É–π idempotency keys –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ**

–ö–ª–∏–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç unique idempotency key –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, UUID). Retry –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ key.

**–ú–æ–Ω–∏—Ç–æ—Ä—å duplicates**

–î–∞–∂–µ —Å idempotency –º–æ–≥—É—Ç –±—ã—Ç—å –±–∞–≥–∏. –ú–æ–Ω–∏—Ç–æ—Ä—å –º–µ—Ç—Ä–∏–∫–∏: "—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –±—ã–ª–∏ deduplicated". –†–æ—Å—Ç —á–∏—Å–ª–∞ duplicates –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É.

---

## 6. Distributed Transactions (–†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Distributed Transaction** (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è) ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —Å–∏—Å—Ç–µ–º (–ë–î, —Å–µ—Ä–≤–∏—Å–æ–≤, –æ—á–µ—Ä–µ–¥–µ–π), –Ω–æ –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ: –ª–∏–±–æ –≤–µ–∑–¥–µ commit, –ª–∏–±–æ –≤–µ–∑–¥–µ rollback.

### –ü—Ä–æ–±–ª–µ–º–∞

–õ–æ–∫–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –æ–¥–Ω–æ–π –ë–î –ª–µ–≥–∫–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç ACID. –ù–æ —á—Ç–æ –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç:
- –î–≤–µ —Ä–∞–∑–Ω—ã–µ –ë–î
- –ë–î –∏ –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π
- –ù–µ—Å–∫–æ–ª—å–∫–æ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –ë–î

–ö–∞–∫ –æ–±–µ—Å–ø–µ—á–∏—Ç—å atomicity –∏ consistency?

### ‚úÖ –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç (–≤ —Ç–µ–æ—Ä–∏–∏)

- –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å across multiple systems
- –õ–∏–±–æ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ commit, –ª–∏–±–æ –≤—Å–µ rollback
- Consistency across distributed state

### ‚ùå –ß—Ç–æ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç (–ø—Ä–æ–±–ª–µ–º—ã –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ)

- –í—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (distributed transactions –º–µ–¥–ª–µ–Ω–Ω—ã–µ)
- –í—ã—Å–æ–∫—É—é availability (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è, –≤–æ–∑–º–æ–∂–Ω—ã deadlocks)
- –ü—Ä–æ—Å—Ç–æ—Ç—É (—Å–ª–æ–∂–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ debugging)
- –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –ø—Ä–∏ network partitions (CAP theorem)

### üåç –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**–ü–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –±–∞–Ω–∫–∞–º–∏**

–ë–∞–Ω–∫ A –∏ –ë–∞–Ω–∫ B –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ –ë–î. –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ –æ—Ç Alice (–ë–∞–Ω–∫ A) –∫ Bob (–ë–∞–Ω–∫ B):
1. –°–ø–∏—Å–∞—Ç—å —Å Alice –≤ –ë–î –±–∞–Ω–∫–∞ A
2. –ó–∞—á–∏—Å–ª–∏—Ç—å Bob –≤ –ë–î –±–∞–Ω–∫–∞ B

–ù—É–∂–Ω–∞ distributed transaction: –ª–∏–±–æ –æ–±–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ª–∏–±–æ –Ω–∏ –æ–¥–Ω–∞.

**E-commerce: –∑–∞–∫–∞–∑ –∏ —Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞**

–î–≤–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞:
- Order Service (—Å–≤–æ—è –ë–î)
- Inventory Service (—Å–≤–æ—è –ë–î)

–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞:
1. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ orders (Order Service)
2. –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ (Inventory Service)

–ë–µ–∑ distributed transaction: –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, –Ω–æ inventory –Ω–µ —É–º–µ–Ω—å—à–µ–Ω ‚Üí overselling.

**Transactional Outbox Pattern (–±–µ–∑ distributed transaction)**

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ distributed transaction:
1. –í –æ–¥–Ω–æ–π –ª–æ–∫–∞–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: —Å–æ–∑–¥–∞—Ç—å order + —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ outbox table
2. Background –ø—Ä–æ—Ü–µ—Å—Å —á–∏—Ç–∞–µ—Ç outbox –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç event –≤ Kafka
3. Inventory Service —á–∏—Ç–∞–µ—Ç event –∏ —É–º–µ–Ω—å—à–∞–µ—Ç inventory

–ù–µ—Ç distributed transaction, –Ω–æ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ outbox pattern.

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–î–ª–∏–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç —Å–∏—Å—Ç–µ–º—É**

Distributed transaction –¥–µ—Ä–∂–∏—Ç locks –≤–æ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö. –ï—Å–ª–∏ –æ–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫ –º–µ–¥–ª–µ–Ω–Ω—ã–π ‚Äî –≤—Å—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ—Ä–º–æ–∑–∏—Ç.

**Network partition –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ inconsistency**

Distributed transaction —Ç—Ä–µ–±—É–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏. –ü—Ä–∏ network partition –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å consensus ‚Üí –ª–∏–±–æ inconsistency, –ª–∏–±–æ unavailability (CAP theorem).

**Coordinator single point of failure**

Distributed transaction —Ç—Ä–µ–±—É–µ—Ç coordinator (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ 2PC). –ï—Å–ª–∏ coordinator –ø–∞–¥–∞–µ—Ç ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç "–ø–æ–≤–∏—Å–Ω—É—Ç—å" in doubt.

**Deadlocks –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ**

–î–≤–µ distributed transactions –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç locks –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ ‚Üí distributed deadlock. –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–µ–µ, —á–µ–º –≤ –æ–¥–Ω–æ–π –ë–î.

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–ò–∑–±–µ–≥–∞–π distributed transactions –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ**

Distributed transactions —Å–ª–æ–∂–Ω—ã –∏ –º–µ–¥–ª–µ–Ω–Ω—ã. –†–∞—Å—Å–º–æ—Ç—Ä–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:
- Saga pattern
- Event sourcing
- Eventual consistency
- Outbox pattern

**–ò—Å–ø–æ–ª—å–∑—É–π distributed transactions —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

–ï—Å–ª–∏ –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∞–±—Å–æ–ª—é—Ç–Ω–æ —Ç—Ä–µ–±—É—é—Ç atomicity across systems ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π distributed transaction (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã). –ù–æ –ø–æ–Ω–∏–º–∞–π trade-offs.

**–†–µ–∞–ª–∏–∑—É–π timeouts –∏ compensation**

Distributed transaction –º–æ–∂–µ—Ç "–ø–æ–≤–∏—Å–Ω—É—Ç—å". –†–µ–∞–ª–∏–∑—É–π timeouts –∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è recovery –∏–ª–∏ rollback.

**–ú–æ–Ω–∏—Ç–æ—Ä—å in-doubt transactions**

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–æ–≥—É—Ç –Ω–∏ commit, –Ω–∏ rollback (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ failure coordinator). –¢—Ä–µ–±—É—é—Ç manual intervention.

---

## 7. Two-Phase Commit (2PC)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Two-Phase Commit (2PC)** (–¥–≤—É—Ö—Ñ–∞–∑–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è) ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ distributed transactions. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç atomicity: –ª–∏–±–æ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ commit, –ª–∏–±–æ –≤—Å–µ rollback.

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–£—á–∞—Å—Ç–Ω–∏–∫–∏:**
- **Coordinator** (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä): —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
- **Participants** (—É—á–∞—Å—Ç–Ω–∏–∫–∏): –ë–î/—Å–µ—Ä–≤–∏—Å—ã, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

**–§–∞–∑–∞ 1: Prepare (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞)**

1. Coordinator –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `PREPARE` –≤—Å–µ–º participants
2. –ö–∞–∂–¥—ã–π participant:
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ
   - –ü–∏—à–µ—Ç –≤ log —Å–æ—Å—Ç–æ—è–Ω–∏–µ (prepared)
   - –û—Ç–≤–µ—á–∞–µ—Ç `YES` (–≥–æ—Ç–æ–≤ commit) –∏–ª–∏ `NO` (—Ö–æ—á—É abort)
   - –ï—Å–ª–∏ YES ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ—Å—É—Ä—Å—ã (–¥–µ—Ä–∂–∏—Ç locks)

**–§–∞–∑–∞ 2: Commit/Abort**

–ï—Å–ª–∏ –≤—Å–µ participants –æ—Ç–≤–µ—Ç–∏–ª–∏ YES:
1. Coordinator –ø–∏—à–µ—Ç –≤ log: `COMMIT`
2. Coordinator –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `COMMIT` –≤—Å–µ–º participants
3. Participants –∫–æ–º–º–∏—Ç—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç locks
4. Participants –æ—Ç–≤–µ—á–∞—é—Ç `ACK`
5. Coordinator –ø–∏—à–µ—Ç –≤ log: `DONE`

–ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω participant –æ—Ç–≤–µ—Ç–∏–ª NO:
1. Coordinator –ø–∏—à–µ—Ç –≤ log: `ABORT`
2. Coordinator –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `ABORT` –≤—Å–µ–º participants
3. Participants –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç –ª–æ–∫–∞–ª—å–Ω–æ –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç locks

### üåç –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**XA Transactions –≤ Java**

Java –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç distributed transactions —á–µ—Ä–µ–∑ JTA (Java Transaction API) –∏ XA protocol (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ 2PC):
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç XA transaction
- –í—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, MySQL –∏ PostgreSQL)
- Transaction manager (–Ω–∞–ø—Ä–∏–º–µ—Ä, Atomikos) –¥–µ–π—Å—Ç–≤—É–µ—Ç –∫–∞–∫ coordinator
- –ü—Ä–∏ commit –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è 2PC –º–µ–∂–¥—É –ë–î

**MySQL Cluster**

MySQL Cluster –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 2PC –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π across multiple data nodes:
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö nodes
- Transaction coordinator –≤—ã–ø–æ–ª–Ω—è–µ—Ç 2PC
- –í—Å–µ nodes –ª–∏–±–æ commit, –ª–∏–±–æ rollback

**PostgreSQL —Å postgres_fdw**

Postgres –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å distributed transactions —á–µ—Ä–µ–∑ Foreign Data Wrappers (FDW):
- –ó–∞–ø—Ä–æ—Å –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ remote —Ç–∞–±–ª–∏—Ü—ã (—á–µ—Ä–µ–∑ FDW)
- Postgres –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 2PC –¥–ª—è coordination
- –û–±–µ –ë–î commit –∏–ª–∏ –æ–±–µ rollback

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ (Blocking Protocol)**

2PC ‚Äî blocking protocol. –ü–æ—Å–ª–µ —Ñ–∞–∑—ã Prepare participants –¥–µ—Ä–∂–∞—Ç locks, –æ–∂–∏–¥–∞—è —Ä–µ—à–µ–Ω–∏—è coordinator.

–ü—Ä–æ–±–ª–µ–º–∞: Coordinator –ø–∞–¥–∞–µ—Ç –ø–æ—Å–ª–µ Prepare, –Ω–æ –¥–æ Commit/Abort. Participants "–ø–æ–≤–∏—Å–∞—é—Ç" —Å –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã–º–∏ locks, –±–ª–æ–∫–∏—Ä—É—è –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

**In-Doubt Transactions**

–ï—Å–ª–∏ coordinator –ø–∞–¥–∞–µ—Ç –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ participants –∑–∞–∫–æ–º–º–∏—Ç–∏–ª–∏, –∞ –¥—Ä—É–≥–∏–µ –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –∫–æ–º–∞–Ω–¥—É:
- –ß–∞—Å—Ç—å participants —Å—á–∏—Ç–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é committed
- –ß–∞—Å—Ç—å –∂–¥—ë—Ç –∫–æ–º–∞–Ω–¥—ã
- –°–∏—Å—Ç–µ–º–∞ –≤ inconsistent state –¥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è coordinator

**Single Point of Failure (Coordinator)**

Coordinator ‚Äî single point of failure. –ï–≥–æ –ø–∞–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ ongoing transactions.

–†–µ—à–µ–Ω–∏–µ: coordinator –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å high-available (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ replication), –Ω–æ —ç—Ç–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç —Å–∏—Å—Ç–µ–º—É.

**–ü–ª–æ—Ö–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

2PC —Ç—Ä–µ–±—É–µ—Ç:
- –î–≤–∞ —Ä–∞—É–Ω–¥–∞ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (Prepare + Commit)
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è
- Locks —É–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –¥–æ–ª—å—à–µ

–†–µ–∑—É–ª—å—Ç–∞—Ç: –Ω–∏–∑–∫–∞—è throughput, –≤—ã—Å–æ–∫–∏–µ latency.

**Network partition**

–ï—Å–ª–∏ network partition —Ä–∞–∑–¥–µ–ª—è–µ—Ç coordinator –∏ participants:
- Participants –Ω–µ –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É Commit/Abort
- Locks —É–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ –¥–æ–ª–≥–æ
- –°–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (violates Availability –≤ CAP)

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–ò—Å–ø–æ–ª—å–∑—É–π 2PC —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ**

2PC –º–µ–¥–ª–µ–Ω–Ω—ã–π –∏ —Ö—Ä—É–ø–∫–∏–π. –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (Saga, eventual consistency) –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤.

**–†–µ–∞–ª–∏–∑—É–π timeouts**

Participants –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å timeout: –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –∫–æ–º–∞–Ω–¥—É –æ—Ç coordinator –≤ —Ç–µ—á–µ–Ω–∏–µ T —Å–µ–∫—É–Ω–¥ ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç locks.

**–î–µ–ª–∞–π coordinator high-available**

–ò—Å–ø–æ–ª—å–∑—É–π replication –¥–ª—è coordinator. –ï—Å–ª–∏ primary coordinator –ø–∞–¥–∞–µ—Ç, backup –±–µ—Ä—ë—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.

**–ü–∏—à–∏ prepare records –≤ persistent log**

Coordinator –∏ participants –¥–æ–ª–∂–Ω—ã –ø–∏—Å–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ durable log. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ø–æ—Å–ª–µ crash.

**–ú–æ–Ω–∏—Ç–æ—Ä—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**

Long-running 2PC —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Äî –ø—Ä–∏–∑–Ω–∞–∫ –ø—Ä–æ–±–ª–µ–º—ã. –ú–æ–Ω–∏—Ç–æ—Ä—å –∏ alert–∏—Ä—É–π.

**–¢–µ—Å—Ç–∏—Ä—É–π failure scenarios**

–°–∏–º—É–ª–∏—Ä—É–π –ø–∞–¥–µ–Ω–∏—è coordinator/participants –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞–¥–∏—è—Ö 2PC. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

---

## 8. Three-Phase Commit (3PC)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Three-Phase Commit (3PC)** (—Ç—Ä—ë—Ö—Ñ–∞–∑–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è) ‚Äî —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è 2PC, –∫–æ—Ç–æ—Ä–∞—è –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É blocking –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ coordinator.

### –û—Ç–ª–∏—á–∏–µ –æ—Ç 2PC

2PC –∏–º–µ–µ—Ç –¥–≤–µ —Ñ–∞–∑—ã: Prepare –∏ Commit.
3PC –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ñ–∞–∑—É: **Pre-Commit**.

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–§–∞–∑–∞ 1: CanCommit (–ú–æ–∂–µ—à—å –∑–∞–∫–æ–º–º–∏—Ç–∏—Ç—å?)**

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ Prepare –≤ 2PC:
1. Coordinator —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç participants: –≥–æ—Ç–æ–≤—ã –ª–∏ –≤—ã commit?
2. Participants –æ—Ç–≤–µ—á–∞—é—Ç YES –∏–ª–∏ NO

**–§–∞–∑–∞ 2: PreCommit (–ü–æ–¥–≥–æ—Ç–æ–≤—å—Å—è –∫ –∫–æ–º–º–∏—Ç—É)**

–ù–æ–≤–∞—è —Ñ–∞–∑–∞:
1. Coordinator –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `PRECOMMIT` –≤—Å–µ–º participants (–µ—Å–ª–∏ –≤—Å–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ YES)
2. Participants –ø–∏—à—É—Ç –≤ log: "–≥–æ—Ç–æ–≤–ª—é—Å—å –∫ commit"
3. Participants –æ—Ç–≤–µ—á–∞—é—Ç `ACK`
4. **–í–∞–∂–Ω–æ**: Participants —Ç–µ–ø–µ—Ä—å –∑–Ω–∞—é—Ç, —á—Ç–æ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–∂–µ –≥–æ—Ç–æ–≤—ã –∫ commit

**–§–∞–∑–∞ 3: DoCommit (–°–¥–µ–ª–∞–π –∫–æ–º–º–∏—Ç)**

1. Coordinator –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `DOCOMMIT`
2. Participants –∫–æ–º–º–∏—Ç—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –Ω–∞–¥ 2PC

**Non-blocking –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö**

–ï—Å–ª–∏ coordinator –ø–∞–¥–∞–µ—Ç –ø–æ—Å–ª–µ PreCommit:
- Participants –∑–Ω–∞—é—Ç, —á—Ç–æ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –∫ commit
- –ú–æ–≥—É—Ç –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ: –ø–æ–¥–æ–∂–¥–∞—Ç—å timeout, –∑–∞—Ç–µ–º commit
- –ù–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å coordinator –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ –¥–æ–ª–≥–æ

–í 2PC participant –Ω–µ –∑–Ω–∞–µ—Ç, –≥–æ—Ç–æ–≤—ã –ª–∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ. –ù–µ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ù–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø–æ–ª–Ω–æ—Å—Ç—å—é**

3PC non-blocking —Ç–æ–ª—å–∫–æ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ —Å reliable network. –ü—Ä–∏ network partitions –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã.

**Network partition —Å–æ–∑–¥–∞—ë—Ç inconsistency**

–°—Ü–µ–Ω–∞—Ä–∏–π:
1. Coordinator –æ—Ç–ø—Ä–∞–≤–∏–ª PRECOMMIT —á–∞—Å—Ç–∏ participants
2. Network partition: –¥—Ä—É–≥–∞—è —á–∞—Å—Ç—å –Ω–µ –ø–æ–ª—É—á–∏–ª–∞ PRECOMMIT
3. –ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å (–ø–æ–ª—É—á–∏–ª–∞ PRECOMMIT) –ø–æ—Å–ª–µ timeout –¥–µ–ª–∞–µ—Ç COMMIT
4. –í—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å (–Ω–µ –ø–æ–ª—É—á–∏–ª–∞) –¥–µ–ª–∞–µ—Ç ABORT
5. Inconsistency!

**–°–ª–æ–∂–Ω–µ–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å**

3PC —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –ª–æ–≥–∏–∫–∏: —Ç–∞–π–º–∞—É—Ç—ã, state –º–∞—à–∏–Ω–∞ —Å —Ç—Ä–µ–º—è —Ñ–∞–∑–∞–º–∏, coordinator recovery.

**–ë–æ–ª—å—à–µ —Å–µ—Ç–µ–≤—ã—Ö —Ä–∞—É–Ω–¥–æ–≤**

3PC —Ç—Ä–µ–±—É–µ—Ç —Ç—Ä–∏ —Ä–∞—É–Ω–¥–∞ –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö ‚Üí –≤—ã—à–µ latency.

**–†–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ**

–ò–∑-–∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –Ω–µ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º 2PC, 3PC —Ä–µ–¥–∫–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ production. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (Paxos, Raft, Saga).

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã**

–í–º–µ—Å—Ç–æ 2PC/3PC –∏—Å–ø–æ–ª—å–∑—É–π:
- **Consensus algorithms** (Paxos, Raft) –¥–ª—è distributed coordination
- **Saga pattern** –¥–ª—è long-running transactions
- **Event sourcing + CQRS** –¥–ª—è eventual consistency

**–ï—Å–ª–∏ –≤—Å—ë –∂–µ –Ω—É–∂–µ–Ω 3PC**

- –†–µ–∞–ª–∏–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É timeouts –Ω–∞ –≤—Å–µ—Ö —Ñ–∞–∑–∞—Ö
- –¢–µ—Å—Ç–∏—Ä—É–π network partition scenarios
- –ü–∏—à–∏ state –≤ persistent log
- –ú–æ–Ω–∏—Ç–æ—Ä—å stuck transactions

---

## 9. Saga Pattern (–ü–∞—Ç—Ç–µ—Ä–Ω –°–∞–≥–∞)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Saga** ‚Äî –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è long-running —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ —á–µ—Ä–µ–∑ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –ö–∞–∂–¥–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î –∏ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ/—Å–æ–æ–±—â–µ–Ω–∏–µ, –∑–∞–ø—É—Å–∫–∞—é—â–µ–µ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.

–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è: –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–π distributed transaction –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ ‚Äî –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è —á–µ—Ä–µ–∑ **compensating transactions**.

### –¢–∏–ø—ã Saga

**Choreography-based Saga (–•–æ—Ä–µ–æ–≥—Ä–∞—Ñ–∏—è)**

–ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞. –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å —Å–ª—É—à–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏ —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å.

```
–ü—Ä–∏–º–µ—Ä: —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞

1. Order Service: —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑ ‚Üí –ø—É–±–ª–∏–∫—É–µ—Ç "OrderCreated"
2. Inventory Service: —Å–ª—É—à–∞–µ—Ç "OrderCreated" ‚Üí —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç —Ç–æ–≤–∞—Ä ‚Üí –ø—É–±–ª–∏–∫—É–µ—Ç "InventoryReserved"
3. Payment Service: —Å–ª—É—à–∞–µ—Ç "InventoryReserved" ‚Üí —Å–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ–Ω—å–≥–∏ ‚Üí –ø—É–±–ª–∏–∫—É–µ—Ç "PaymentCompleted"
4. Shipping Service: —Å–ª—É—à–∞–µ—Ç "PaymentCompleted" ‚Üí —Å–æ–∑–¥–∞—ë—Ç –¥–æ—Å—Ç–∞–≤–∫—É
```

**Orchestration-based Saga (–û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è)**

–ï—Å—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π orchestrator, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é —à–∞–≥–æ–≤.

```
Order Saga Orchestrator:
1. –í—ã–∑—ã–≤–∞–µ—Ç Inventory Service: —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–π —Ç–æ–≤–∞—Ä
2. –í—ã–∑—ã–≤–∞–µ—Ç Payment Service: —Å–ø–∏—à–∏ –¥–µ–Ω—å–≥–∏
3. –í—ã–∑—ã–≤–∞–µ—Ç Shipping Service: —Å–æ–∑–¥–∞–π –¥–æ—Å—Ç–∞–≤–∫—É
```

### ‚úÖ –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- Eventual consistency: –≤ –∫–æ–Ω—Ü–µ –∫–æ–Ω—Ü–æ–≤ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–¥—ë—Ç –≤ consistent —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- –ö–∞–∂–¥—ã–π —à–∞–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–±—ã—Å—Ç—Ä–æ)
- –û—Ç–∫–∞—Ç —á–µ—Ä–µ–∑ compensating transactions

### ‚ùå –ß—Ç–æ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å: –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–∏–¥–∏–º—ã
- –ò–∑–æ–ª—è—Ü–∏—é: –¥—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å partial results
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω—É—é consistency

### üåç –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**E-commerce: —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞**

Saga —à–∞–≥–∏:
1. **CreateOrder**: Order Service —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑ (status = PENDING)
2. **ReserveInventory**: Inventory Service —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç —Ç–æ–≤–∞—Ä
3. **ChargePayment**: Payment Service —Å–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ–Ω—å–≥–∏
4. **ConfirmOrder**: Order Service –º–µ–Ω—è–µ—Ç status = CONFIRMED

–ï—Å–ª–∏ —à–∞–≥ 3 (ChargePayment) failed:
- Compensation step 2: –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
- Compensation step 1: –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑ (status = CANCELLED)

**–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è**

Saga –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—ë—Ç–∞ + –æ—Ç–µ–ª—è + –∞—Ä–µ–Ω–¥—ã –∞–≤—Ç–æ:
1. –ë—Ä–æ–Ω–∏—Ä—É–µ–º –ø–æ–ª—ë—Ç
2. –ë—Ä–æ–Ω–∏—Ä—É–µ–º –æ—Ç–µ–ª—å
3. –ë—Ä–æ–Ω–∏—Ä—É–µ–º –∞–≤—Ç–æ

–ï—Å–ª–∏ —à–∞–≥ 3 failed (–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≤—Ç–æ):
- Compensation: –æ—Ç–º–µ–Ω—è–µ–º –±—Ä–æ–Ω—å –æ—Ç–µ–ª—è
- Compensation: –æ—Ç–º–µ–Ω—è–µ–º –±—Ä–æ–Ω—å –ø–æ–ª—ë—Ç–∞

**Netflix: distributed –ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ –≤–∏–¥–µ–æ**

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–¥–µ–æ:
1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –≤ S3
2. –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ –ë–î
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫–æ–¥–∏–Ω–≥
4. –°–æ–∑–¥–∞—Ç—å thumbnails
5. –û–±–Ω–æ–≤–∏—Ç—å CDN

–ï—Å–ª–∏ —à–∞–≥ 4 failed:
- Compensation: –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫–æ–¥–∏–Ω–≥
- Compensation: —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –ë–î
- Compensation: —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –∏–∑ S3

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**Anomalies –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è isolation**

Saga –Ω–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞. –î—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

–ü—Ä–∏–º–µ—Ä:
- Saga —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑ (status = PENDING)
- –î—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∑–∞–∫–∞–∑ –≤ —Å—Ç–∞—Ç—É—Å–µ PENDING –∏ –¥—É–º–∞–µ—Ç, —á—Ç–æ –æ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω
- Saga –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –æ–ø–ª–∞—Ç—ã
- –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤–∏–¥–µ–ª –µ–≥–æ –∫–∞–∫ "—Å–æ–∑–¥–∞–Ω"

**Compensating transactions –º–æ–≥—É—Ç fails**

–ß—Ç–æ –µ—Å–ª–∏ compensation —Ç–æ–∂–µ failed?

–ü—Ä–∏–º–µ—Ä:
- –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–ª–∏ —Ç–æ–≤–∞—Ä
- –û–ø–ª–∞—Ç–∞ failed
- –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ (compensation)
- Inventory Service –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî compensation failed!

–†–µ—à–µ–Ω–∏–µ: compensation –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å retriable –∏–ª–∏ eventual consistency.

**–°–ª–æ–∂–Ω–æ—Å—Ç—å orchestrator**

Orchestrator –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–º state machine, –æ—Å–æ–±–µ–Ω–Ω–æ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —à–∞–≥–æ–≤ –∏ —É—Å–ª–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏.

**Lost updates**

–î–≤–∞ saga –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è—é—Ç –æ–¥–Ω–∏ –¥–∞–Ω–Ω—ã–µ.

–ü—Ä–∏–º–µ—Ä:
- Saga A —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–≤–∞—Ä
- Saga B —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç —Ç–æ—Ç –∂–µ —Ç–æ–≤–∞—Ä (–µ—â—ë –Ω–µ –≤–∏–¥–∏—Ç —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ A)
- Overselling!

–†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–π optimistic locking –∏–ª–∏ semantic locks.

**Ordering –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤ choreography**

–í choreography-based saga –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Ä—É—à–µ–Ω.

–ü—Ä–∏–º–µ—Ä:
- Service A –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ E1, –∑–∞—Ç–µ–º E2
- Service B –ø–æ–ª—É—á–∞–µ—Ç E2, –∑–∞—Ç–µ–º E1 (–∏–∑-–∑–∞ network delays)
- –õ–æ–≥–∏–∫–∞ –Ω–∞—Ä—É—à–µ–Ω–∞

–†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–π event version/sequence number.

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–í—ã–±–∏—Ä–∞–π –º–µ–∂–¥—É choreography –∏ orchestration**

- **Choreography**: –ø—Ä–æ—â–µ –¥–ª—è simple —Å–∞–≥, –º–µ–Ω—å—à–µ coupling, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å flow
- **Orchestration**: —á—ë—Ç–∫–æ –≤–∏–¥–∏–º—ã–π flow, –ª–µ–≥—á–µ debugging, –Ω–æ orchestrator –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å bottleneck

**–î–µ–ª–∞–π compensations idempotent**

Compensation –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ (retry). –û–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å idempotent.

**–ò—Å–ø–æ–ª—å–∑—É–π semantic locks –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏**

–í–º–µ—Å—Ç–æ database locks –∏—Å–ø–æ–ª—å–∑—É–π application-level locks. –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª–µ `reserved_by` –≤ —Ç–∞–±–ª–∏—Ü–µ inventory.

**–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π timeout**

–ï—Å–ª–∏ —à–∞–≥ saga –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –≤ —Ä–∞–∑—É–º–Ω–æ–µ –≤—Ä–µ–º—è ‚Äî —Å—á–∏—Ç–∞–π –µ–≥–æ failed –∏ –∑–∞–ø—É—Å–∫–∞–π compensation.

**–ò—Å–ø–æ–ª—å–∑—É–π event sourcing –¥–ª—è audit trail**

–°–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ —Å–æ–±—ã—Ç–∏—è saga –≤ event store. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å debugging –∏ recovery.

**–ú–æ–Ω–∏—Ç–æ—Ä—å –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∞–≥–∏**

Long-running saga –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É. Alert–∏—Ä—É–π –µ—Å–ª–∏ saga —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ.

**–¢–µ—Å—Ç–∏—Ä—É–π partial failures**

–°–∏–º—É–ª–∏—Ä—É–π failures –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –∏ —É–±–µ–¥–∏—Å—å, —á—Ç–æ compensations —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

---

## 10. Compensation Semantics (–°–µ–º–∞–Ω—Ç–∏–∫–∞ –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Compensation** (–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è) ‚Äî –æ–ø–µ—Ä–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ª–æ–≥–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Saga –∏ –¥—Ä—É–≥–∏—Ö long-running transactions –¥–ª—è "–æ—Ç–∫–∞—Ç–∞".

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç database rollback (–∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞ storage level), compensation ‚Äî —ç—Ç–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, –æ—Ç–º–µ–Ω—è—é—â–∞—è —ç—Ñ—Ñ–µ–∫—Ç.

### –¢–∏–ø—ã –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π

**Backward Recovery (–û—Ç–∫–∞—Ç –Ω–∞–∑–∞–¥)**

–û—Ç–º–µ–Ω—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.

```
–®–∞–≥–∏:        A ‚Üí B ‚Üí C ‚Üí D [failed]
Compensation:    ‚Üê C'‚Üê B'‚Üê A'
```

**Forward Recovery (–û—Ç–∫–∞—Ç –≤–ø–µ—Ä—ë–¥)**

–ü—Ä–æ–ø—É—Å–∫–∞–µ–º failed —à–∞–≥ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–ª—å—à–µ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ).

```
–®–∞–≥–∏:        A ‚Üí B ‚Üí C [failed] ‚Üí D (—Å default –∑–Ω–∞—á–µ–Ω–∏—è–º–∏)
```

### ‚úÖ –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –õ–æ–≥–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
- Eventual consistency –ø–æ—Å–ª–µ compensation
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å recovery –æ—Ç partial failures

### ‚ùå –ß—Ç–æ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –§–∏–∑–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç (–∫–∞–∫ database rollback)
- –ß—Ç–æ compensation –≤—Å–µ–≥–¥–∞ –≤–æ–∑–º–æ–∂–Ω–∞ (–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã)
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç (compensation –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)
- –ò–¥–µ–∞–ª—å–Ω—É—é –∏–∑–æ–ª—è—Ü–∏—é (—ç—Ñ—Ñ–µ–∫—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –≤–∏–¥–Ω—ã –¥–æ compensation)

### üåç –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**–û—Ç–º–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞**

–û–ø–µ—Ä–∞—Ü–∏—è: `ReserveInventory(item_id, quantity)`
- –£–º–µ–Ω—å—à–∞–µ—Ç `available_quantity`
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `reserved_quantity`

Compensation: `CancelReservation(item_id, quantity)`
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `available_quantity`
- –£–º–µ–Ω—å—à–∞–µ—Ç `reserved_quantity`

**–í–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞**

–û–ø–µ—Ä–∞—Ü–∏—è: `ChargePayment(user_id, amount)` ‚Äî —Å–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ–Ω—å–≥–∏
Compensation: `RefundPayment(user_id, amount)` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ–Ω—å–≥–∏

–í–∞–∂–Ω–æ: —ç—Ç–æ –Ω–µ rollback! –î–µ–Ω—å–≥–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å –∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å. –í –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±—É–¥–µ—Ç –¥–≤–∞ records: charge –∏ refund.

**–û—Ç–º–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email**

–û–ø–µ—Ä–∞—Ü–∏—è: `SendEmail(user_id, content)` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email

Compensation: ??? ‚Äî –Ω–µ–ª—å–∑—è "–æ—Ç–º–µ–Ω–∏—Ç—å" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π email!

–í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥–æ–π email: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É–π –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –ø–∏—Å—å–º–æ"
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ email –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—à–∏–±–æ—á–Ω–æ
- Compensation –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ–º –∫–∞–∫ —Ñ–∞–∫—Ç

**–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ S3**

–û–ø–µ—Ä–∞—Ü–∏—è: `UploadFile(filename, content)` ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª
Compensation: `DeleteFile(filename)` ‚Äî —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª

–ù–æ —á—Ç–æ –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ –±—ã–ª –ø—Ä–æ—á–∏—Ç–∞–Ω –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º? –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ "–æ—Ç–º–µ–Ω–∏—Ç" —Ñ–∞–∫—Ç —á—Ç–µ–Ω–∏—è.

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞**

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã:
- –û—Ç–ø—Ä–∞–≤–∫–∞ email
- –í—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ API, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Ç–∫–∞—Ç
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Kafka (—Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ consumers)

–†–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–π —Å–∏—Å—Ç–µ–º—É —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –≤ –∫–æ–Ω—Ü–µ saga.

**Compensation –Ω–µ idempotent**

Compensation –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã (retry) –∏ –¥—É–±–ª–∏—Ä—É–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç.

–ü—Ä–∏–º–µ—Ä:
- Compensation: `RefundPayment(100)`
- Retry –≤—ã–∑—ã–≤–∞–µ—Ç –µ—â—ë —Ä–∞–∑: `RefundPayment(100)`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª 200 –æ–±—Ä–∞—Ç–Ω–æ –≤–º–µ—Å—Ç–æ 100

–†–µ—à–µ–Ω–∏–µ: –¥–µ–ª–∞–π compensations idempotent (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ—Ö—Ä–∞–Ω—è–π ID compensation –æ–ø–µ—Ä–∞—Ü–∏–∏).

**Partial compensation**

Compensation —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —à–∞–≥–æ–≤. –û–¥–∏–Ω —à–∞–≥ —É—Å–ø–µ—à–µ–Ω, –¥—Ä—É–≥–æ–π failed.

–ü—Ä–∏–º–µ—Ä:
- Compensation: –æ—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ + –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏
- –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ, –Ω–æ –≤–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥ failed
- Partial compensation!

–†–µ—à–µ–Ω–∏–µ: compensations —Ç–æ–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–º–∏ –∏–ª–∏ retriable.

**Ordering compensations**

Compensations –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ —à–∞–≥–æ–≤ saga. –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ inconsistency.

–ü—Ä–∏–º–µ—Ä:
- –®–∞–≥–∏: CreateOrder ‚Üí ReserveInventory ‚Üí ChargePayment
- –ï—Å–ª–∏ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å–Ω–∞—á–∞–ª–∞ CreateOrder, –ø–æ—Ç–æ–º ReserveInventory) ‚Äî –º–æ–∂–µ–º –Ω–∞—Ä—É—à–∏—Ç—å invariants

**Semantic compensation —Å–ª–æ–∂–Ω–∞**

–ò–Ω–æ–≥–¥–∞ compensation ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ "–æ–±—Ä–∞—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è". –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–ª–æ–∂–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞.

–ü—Ä–∏–º–µ—Ä: –æ—Ç–º–µ–Ω–∞ –∞–≤–∏–∞–±–∏–ª–µ—Ç–∞ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å —à—Ç—Ä–∞—Ñ—ã, partial refund, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±–æ–Ω—É—Å–Ω—ã—Ö –º–∏–ª—å –∏ —Ç.–¥.

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–ü—Ä–æ–µ–∫—Ç–∏—Ä—É–π compensations –≤–º–µ—Å—Ç–µ —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏**

–î–ª—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –¥—É–º–∞–π: –∫–∞–∫ –µ—ë –æ—Ç–∫–∞—Ç–∏—Ç—å? –ï—Å–ª–∏ compensation –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –∏–ª–∏ —Å–ª–æ–∂–Ω–∞ ‚Äî —Ä–∞—Å—Å–º–æ—Ç—Ä–∏ –¥—Ä—É–≥–æ–π –¥–∏–∑–∞–π–Ω.

**–î–µ–ª–∞–π compensations idempotent**

Compensation –¥–æ–ª–∂–Ω–∞ safely –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑. –ò—Å–ø–æ–ª—å–∑—É–π deduplication keys.

**–†–∞—Å–ø–æ–ª–∞–≥–∞–π –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ü–µ**

–û–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è –æ—Ç–∫–∞—Ç–∏—Ç—å (–æ—Ç–ø—Ä–∞–≤–∫–∞ email, –≤—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ API), –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –∫–æ–Ω—Ü–µ saga. –ï—Å–ª–∏ –æ–Ω–∏ –≤ –Ω–∞—á–∞–ª–µ ‚Äî –æ—Ç–∫–∞—Ç —Å–ª–æ–∂–Ω–µ–µ.

**–õ–æ–≥–∏—Ä—É–π compensations**

–°–æ—Ö—Ä–∞–Ω—è–π –≤ audit log –∫–∞–∫–∏–µ compensations –±—ã–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å debugging –∏ compliance.

**–¢–µ—Å—Ç–∏—Ä—É–π compensations**

–ù–µ –∑–∞–±—ã–≤–∞–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å compensations —Ç–∞–∫ –∂–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ, –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏. –°–∏–º—É–ª–∏—Ä—É–π failures –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —ç—Ç–∞–ø–∞—Ö.

**–ò—Å–ø–æ–ª—å–∑—É–π timeout –¥–ª—è compensations**

–ï—Å–ª–∏ compensation –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –≤ —Ä–∞–∑—É–º–Ω–æ–µ –≤—Ä–µ–º—è ‚Äî alert–∏—Ä—É–π. Manual intervention –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω—É–∂–Ω–∞.

---

## 11. Outbox Pattern (–ü–∞—Ç—Ç–µ—Ä–Ω –ò—Å—Ö–æ–¥—è—â–∏—Ö –°–æ–æ–±—â–µ–Ω–∏–π)

### üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Outbox Pattern** ‚Äî –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π/—Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ë–î –≤ message broker (Kafka, RabbitMQ) —Å exactly-once —Å–µ–º–∞–Ω—Ç–∏–∫–æ–π.

### –ü—Ä–æ–±–ª–µ–º–∞

–¢–∏–ø–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
1. –û–±–Ω–æ–≤–ª—è–µ—à—å –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞—ë—à—å –∑–∞–∫–∞–∑)
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—à—å —Å–æ–±—ã—Ç–∏–µ –≤ Kafka ("OrderCreated")

–ü—Ä–æ–±–ª–µ–º—ã:
- –ß—Ç–æ –µ—Å–ª–∏ –ë–î –æ–±–Ω–æ–≤–∏–ª–∞—Å—å, –Ω–æ Kafka –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω? –°–æ–±—ã—Ç–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ.
- –ß—Ç–æ –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ—Å—å, –Ω–æ –ë–î rollback? –°–æ–±—ã—Ç–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–æ.
- –ö–∞–∫ –æ–±–µ—Å–ø–µ—á–∏—Ç—å atomicity: –ª–∏–±–æ –æ–±–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –ª–∏–±–æ –Ω–∏ –æ–¥–Ω–∞?

### –†–µ—à–µ–Ω–∏–µ: Outbox Table

**–®–∞–≥ 1**: –í —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –≥–¥–µ –æ–±–Ω–æ–≤–ª—è–µ—à—å –¥–∞–Ω–Ω—ã–µ, –≤—Å—Ç–∞–≤–ª—è–µ—à—å —Å–æ–±—ã—Ç–∏–µ –≤ outbox table.

```
BEGIN TRANSACTION
  INSERT INTO orders (id, user_id, amount) VALUES (...)
  INSERT INTO outbox (event_type, payload) VALUES ('OrderCreated', '...')
COMMIT
```

–¢–µ–ø–µ—Ä—å –æ–±–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã.

**–®–∞–≥ 2**: Background –ø—Ä–æ—Ü–µ—Å—Å (Outbox Publisher) —á–∏—Ç–∞–µ—Ç outbox table –∏ –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ Kafka.

**–®–∞–≥ 3**: –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ–º–µ—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ outbox –∫–∞–∫ published –∏–ª–∏ —É–¥–∞–ª—è–µ—Ç.

### ‚úÖ –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- –°–æ–±—ã—Ç–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ —Ç–æ–≥–¥–∞ –∏ —Ç–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- At-least-once delivery (—Å–æ–±—ã—Ç–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –¥–≤–∞–∂–¥—ã –ø—Ä–∏ retries)
- –ú–æ–∂–Ω–æ –¥–æ–±–∏—Ç—å—Å—è exactly-once effects —á–µ—Ä–µ–∑ idempotent consumers

### ‚ùå –ß—Ç–æ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç

- Exactly-once delivery (–≤–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏ retries)
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é (–µ—Å—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–∫–∞ Outbox Publisher –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç)
- Ordering –≥–∞—Ä–∞–Ω—Ç–∏–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏

### üåç –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã

**Order Service —Å Kafka**

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:
1. –í –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: —Å–æ–∑–¥–∞—Ç—å order + –≤—Å—Ç–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ outbox
2. Outbox Publisher —á–∏—Ç–∞–µ—Ç outbox –∫–∞–∂–¥—ã–µ 100ms
3. –ü—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ Kafka —Ç–æ–ø–∏–∫ `orders`
4. –ü–æ–º–µ—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∫–∞–∫ published

–ï—Å–ª–∏ Kafka –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:
- –°–æ–±—ã—Ç–∏—è –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ outbox
- –ö–æ–≥–¥–∞ Kafka –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è ‚Äî –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã
- –ù–∏ –æ–¥–Ω–æ —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω–æ

**Debezium –¥–ª—è Change Data Capture (CDC)**

–í–º–µ—Å—Ç–æ Outbox Publisher –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CDC:
- Debezium —Å–ª–µ–¥–∏—Ç –∑–∞ changes –≤ outbox table (—á–µ—Ä–µ–∑ database log)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—É–±–ª–∏–∫—É–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –≤ Kafka
- –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è latency (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã)

**Microservices event-driven architecture**

–ö–∞–∂–¥—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç —Å–≤–æ—é outbox table. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ outbox. –î—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ.

### ‚ö†Ô∏è –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–î—É–±–ª–∏–∫–∞—Ç—ã —Å–æ–±—ã—Ç–∏–π**

Outbox Publisher –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ Kafka, –Ω–æ crash –¥–æ –ø–æ–º–µ—Ç–∫–∏ –≤ outbox –∫–∞–∫ published. –ü—Ä–∏ restart –ø—É–±–ª–∏–∫—É–µ—Ç —Å–Ω–æ–≤–∞.

–†–µ—à–µ–Ω–∏–µ: consumers –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å idempotent. –ò—Å–ø–æ–ª—å–∑—É–π deduplication key –≤ —Å–æ–±—ã—Ç–∏–∏.

**–†–∞—Å—Ç—É—â–∞—è outbox table**

–ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª—è—Ç—å published —Å–æ–±—ã—Ç–∏—è, outbox table —Ä–∞—Å—Ç—ë—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ.

–†–µ—à–µ–Ω–∏–µ:
- –£–¥–∞–ª—è–π published —Å–æ–±—ã—Ç–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π TTL/archiving –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π

**Ordering –ø—Ä–æ–±–ª–µ–º—ã**

–°–æ–±—ã—Ç–∏—è –≤ outbox –º–æ–≥—É—Ç –±—ã—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –Ω–µ –≤ —Ç–æ–º –ø–æ—Ä—è–¥–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤—Å—Ç–∞–≤–ª–µ–Ω—ã (–µ—Å–ª–∏ Outbox Publisher –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ).

–†–µ—à–µ–Ω–∏–µ:
- –ò—Å–ø–æ–ª—å–∑—É–π sequence number –≤ —Å–æ–±—ã—Ç–∏—è—Ö
- –ò–ª–∏ –ø—É–±–ª–∏–∫—É–π —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ–¥–Ω–æ–≥–æ entity —Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–ø–æ partition key)

**Latency**

Outbox Publisher –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç outbox table —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100ms). –≠—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç latency –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π.

–†–µ—à–µ–Ω–∏–µ:
- –£–º–µ–Ω—å—à–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª polling
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π database triggers + NOTIFY –¥–ª—è immediate processing
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π CDC (Debezium) –¥–ª—è real-time capturing

**Outbox Publisher single point of failure**

–ï—Å–ª–∏ Outbox Publisher —É–ø–∞–¥—ë—Ç, —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è.

–†–µ—à–µ–Ω–∏–µ:
- –ó–∞–ø—É—Å—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ instances —Å leader election
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π CDC (Debezium, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç high availability)

### üèóÔ∏è –ö–∞–∫ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

**–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π outbox –¥–ª—è critical events**

–ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "OrderCreated", "PaymentCompleted"), –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é –≤ Kafka. –ò—Å–ø–æ–ª—å–∑—É–π outbox.

**–†–µ–∞–ª–∏–∑—É–π idempotent consumers**

Outbox –¥–∞—ë—Ç at-least-once delivery. Consumers –¥–æ–ª–∂–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã idempotent.

**–î–æ–±–∞–≤–ª—è–π metadata –≤ —Å–æ–±—ã—Ç–∏—è**

–ü–æ–ª–µ–∑–Ω—ã–µ –ø–æ–ª—è:
- `event_id` (UUID) ‚Äî –¥–ª—è deduplication
- `event_timestamp` ‚Äî –∫–æ–≥–¥–∞ —Å–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ
- `event_version` ‚Äî –≤–µ—Ä—Å–∏—è schema —Å–æ–±—ã—Ç–∏—è
- `aggregate_id` ‚Äî ID —Å—É—â–Ω–æ—Å—Ç–∏, –∫ –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ

**–ò—Å–ø–æ–ª—å–∑—É–π CDC –¥–ª—è low latency**

–ï—Å–ª–∏ latency –∫—Ä–∏—Ç–∏—á–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–π Change Data Capture (Debezium) –≤–º–µ—Å—Ç–æ polling-based Outbox Publisher.

**–ú–æ–Ω–∏—Ç–æ—Ä—å —Ä–∞–∑–º–µ—Ä outbox**

Alert–∏—Ä—É–π –µ—Å–ª–∏ outbox table —Ä–∞—Å—Ç—ë—Ç (—Å–æ–±—ã—Ç–∏–π –Ω–µ —É—Å–ø–µ–≤–∞—é—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å—Å—è). –≠—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É —Å Publisher.

**–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä—É–π outbox –ø–æ –≤—Ä–µ–º–µ–Ω–∏**

–î–ª—è –æ—á–µ–Ω—å high-throughput —Å–∏—Å—Ç–µ–º –º–æ–∂–µ—à—å –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å outbox table –ø–æ timestamp. –°—Ç–∞—Ä—ã–µ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –º–æ–∂–Ω–æ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å.

**–¢–µ—Å—Ç–∏—Ä—É–π scenarios —Å retries**

–°–∏–º—É–ª–∏—Ä—É–π failures Outbox Publisher –∏ —É–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ –∏—Ç–æ–≥–µ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –∏ consumers –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã.

---

## –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ü–æ–¥—Ö–æ–¥                   | Atomicity        | Performance | Complexity | Use Cases                                  |
|--------------------------|------------------|-------------|------------|-------------------------------------------|
| Local Transaction        | ‚úì –ü–æ–ª–Ω–∞—è         | ‚ö° –í—ã—Å–æ–∫–∞—è   | üü¢ –ù–∏–∑–∫–∞—è  | –û–¥–Ω–∞ –ë–î, –ø—Ä–æ—Å—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏                  |
| 2PC                      | ‚úì –ü–æ–ª–Ω–∞—è         | üêå –ù–∏–∑–∫–∞—è   | üî¥ –í—ã—Å–æ–∫–∞—è | –ö—Ä–∏—Ç–∏—á–Ω—ã–µ distributed tx (—Ä–µ–¥–∫–æ)           |
| 3PC                      | ~ –ß–∞—Å—Ç–∏—á–Ω–∞—è      | üêå –ù–∏–∑–∫–∞—è   | üî¥ –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | –ü–æ—á—Ç–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è                |
| Saga (Choreography)      | ‚úó –ù–µ—Ç            | ‚ö° –í—ã—Å–æ–∫–∞—è   | üü° –°—Ä–µ–¥–Ω—è—è | Event-driven, independent services         |
| Saga (Orchestration)     | ‚úó –ù–µ—Ç            | üèÉ –°—Ä–µ–¥–Ω—è—è  | üü° –°—Ä–µ–¥–Ω—è—è | Complex workflows, centralized control     |
| Outbox Pattern           | ‚úì DB + Events    | üèÉ –°—Ä–µ–¥–Ω—è—è  | üü° –°—Ä–µ–¥–Ω—è—è | Reliable event publishing                  |
| Exactly-Once (Kafka EOS) | ‚úì Full pipeline  | üèÉ –°—Ä–µ–¥–Ω—è—è  | üü° –°—Ä–µ–¥–Ω—è—è | Stream processing, critical data pipelines |

---

## Best Practices (–õ—É—á—à–∏–µ –ü—Ä–∞–∫—Ç–∏–∫–∏)

### üéØ –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–µ–º–∞–Ω—Ç–∏–∫–∏

**–ù–∞—á–∏–Ω–∞–π —Å –ø—Ä–æ—Å—Ç–æ–≥–æ**

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π distributed transactions –µ—Å–ª–∏ –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏—Å—å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Saga –µ—Å–ª–∏ –º–æ–∂–Ω–æ —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω—É –ë–î.

**–ó–∞–¥–∞–≤–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã**

- –ù—É–∂–Ω–∞ –ª–∏ –º–Ω–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è consistency –∏–ª–∏ eventual consistency OK?
- –ú–æ–≥—É –ª–∏ —è —Å–¥–µ–ª–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é idempotent?
- –ù–∞—Å–∫–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã –≤–æ–∑–º–æ–∂–Ω—ã–µ inconsistencies?
- –ö–∞–∫–æ–≤–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å failures?

**–ò—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—É —Ä–µ—à–µ–Ω–∏–π**

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ                           | –í—ã–±–æ—Ä                                    |
|--------------------------------------|------------------------------------------|
| –û–¥–Ω–∞ –ë–î, –∫—Ä–∏—Ç–∏—á–Ω–∞ atomicity          | Local transaction + Serializable         |
| –ù–µ—Å–∫–æ–ª—å–∫–æ –ë–î, –∫—Ä–∏—Ç–∏—á–Ω–∞ atomicity     | 2PC (–µ—Å–ª–∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ) –∏–ª–∏ Saga |
| Eventual consistency OK              | Saga + Compensation                      |
| –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π —Å atomicity       | Outbox Pattern                           |
| Stream processing exactly-once       | Kafka Transactions (EOS)                 |
| Long-running workflows               | Saga —Å Orchestration                     |

### üõ°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–†–∞–∑–ª–∏—á–∞–π retriable –∏ non-retriable errors**

- **Retriable**: network timeout, temporary unavailability ‚Üí retry
- **Non-retriable**: validation error, business rule violation ‚Üí –Ω–µ retry, —Å—Ä–∞–∑—É fail

**–ò—Å–ø–æ–ª—å–∑—É–π exponential backoff**

–ü—Ä–∏ retry –Ω–µ –¥–µ–ª–∞–π —Å—Ä–∞–∑—É, –∏—Å–ø–æ–ª—å–∑—É–π exponential backoff: 1s, 2s, 4s, 8s...

**–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π —á–∏—Å–ª–æ retries**

–ù–µ retry –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ. –ü–æ—Å–ª–µ N –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ ‚Äî fail –∏ alert–∏—Ä—É–π humans.

**–õ–æ–≥–∏—Ä—É–π –∏ –º–æ–Ω–∏—Ç–æ—Ä—å**

- –õ–æ–≥–∏—Ä—É–π –∫–∞–∂–¥—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å unique ID
- –ú–æ–Ω–∏—Ç–æ—Ä—å –º–µ—Ç—Ä–∏–∫–∏: success rate, retry rate, compensation rate
- Alert–∏—Ä—É–π –ø—Ä–∏ –∞–Ω–æ–º–∞–ª–∏—è—Ö

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**Unit —Ç–µ—Å—Ç—ã –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ**

Transactional semantics —Ç—Ä–µ–±—É–µ—Ç integration –∏ chaos testing.

**–¢–µ—Å—Ç–∏—Ä—É–π failure scenarios**

- Network timeout –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ü–∞–¥–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ—Å–ª–µ Prepare, –¥–æ Commit
- Duplicate messages
- Out-of-order messages

**–ò—Å–ø–æ–ª—å–∑—É–π Chaos Engineering**

–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –≤–Ω–æ—Å–∏ failures –≤ production-like –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–π, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏**

- Transaction success rate
- Transaction duration (p50, p95, p99)
- Rollback rate
- Compensation rate
- In-doubt transactions count
- Outbox size / lag

**Distributed tracing**

–ò—Å–ø–æ–ª—å–∑—É–π distributed tracing (Jaeger, Zipkin) –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π across services.

**Alerting**

Alert–∏—Ä—É–π –Ω–∞:
- –†–æ—Å—Ç rollback rate
- Long-running transactions
- In-doubt transactions
- –†–∞—Å—Ç—É—â–∞—è outbox

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Transactional Semantics ‚Äî —ç—Ç–æ —Å–ª–æ–∂–Ω–∞—è, –Ω–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –ø—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º. –û—Å–Ω–æ–≤–Ω—ã–µ takeaways:

üéØ **ACID ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç**: –ü–æ–Ω–∏–º–∞–π Atomicity, Consistency, Isolation, Durability –∏ –∏—Ö trade-offs.

üéØ **–ù–µ—Ç silver bullet**: –ö–∞–∂–¥—ã–π –ø–æ–¥—Ö–æ–¥ (2PC, 3PC, Saga, Outbox) –∏–º–µ–µ—Ç —Å–≤–æ–∏ –ø–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã. –í—ã–±–∏—Ä–∞–π –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ.

üéØ **Simplicity first**: –ù–∞—á–∏–Ω–∞–π —Å –ø—Ä–æ—Å—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–∂–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ.

üéØ **Idempotency ‚Äî —Ç–≤–æ–π –¥—Ä—É–≥**: –î–µ–ª–∞–π –æ–ø–µ—Ä–∞—Ü–∏–∏ idempotent –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ. –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç retry –∏ recovery.

üéØ **–¢–µ—Å—Ç–∏—Ä—É–π failures**: Distributed transactions –ª–æ–º–∞—é—Ç—Å—è. –¢–µ—Å—Ç–∏—Ä—É–π failure scenarios –∏ —É–±–µ–¥–∏—Å—å, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

üéØ **–ú–æ–Ω–∏—Ç–æ—Ä—å**: –ë–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—ã –Ω–µ —É–∑–Ω–∞–µ—à—å –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö, –ø–æ–∫–∞ –æ–Ω–∏ –Ω–µ —Å—Ç–∞–Ω—É—Ç –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–æ–π.

–ü–æ–º–Ω–∏: –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö failures –Ω–µ–∏–∑–±–µ–∂–Ω—ã. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ gracefully –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç failures –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–µ–º–∞–Ω—Ç–∏–∫—É –¥–ª—è –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏–π.

–£–¥–∞—á–∏ –≤ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –Ω–∞–¥—ë–∂–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º! üöÄ
