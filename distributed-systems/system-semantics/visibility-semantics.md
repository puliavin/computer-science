# Visibility Semantics (–°–µ–º–∞–Ω—Ç–∏–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö)

## –í–≤–µ–¥–µ–Ω–∏–µ

–ü—Ä–µ–¥—Å—Ç–∞–≤—å —Å–∏—Ç—É–∞—Ü–∏—é: —Ç—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ–±–Ω–æ–≤–∏–ª —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –≤ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏, –¥–æ–±–∞–≤–∏–ª –Ω–æ–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é. –û–±–Ω–æ–≤–ª—è–µ—à—å —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Äî –∞ —Ñ–æ—Ç–æ –Ω–µ—Ç. –ó–∞—Ö–æ–¥–∏—à—å —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Äî –µ—Å—Ç—å. –ü—Ä–æ—Å–∏—à—å –¥—Ä—É–≥–∞ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å ‚Äî —É –Ω–µ–≥–æ —Ç–æ–∂–µ –Ω–µ—Ç. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç? –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä **Visibility Semantics**.

**Visibility Semantics (—Å–µ–º–∞–Ω—Ç–∏–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏)** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ —Ç–æ–≥–æ, **–∫–æ–≥–¥–∞ –∏ –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏** –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ. –≠—Ç–æ –æ–¥–∏–Ω –∏–∑ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–ø—Ä—è–º—É—é –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

### –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ?

Visibility semantics ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞—è —Ç–µ–æ—Ä–∏—è. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏, –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ä–µ–∞–ª—å–Ω—ã–º –ø—Ä–æ–±–ª–µ–º–∞–º:

- üí∞ **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –ø–ª–∞—Ç—ë–∂, —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —É—Å–ø–µ—Ö, –Ω–æ –¥–µ–Ω—å–≥–∏ "–∑–∞–≤–∏—Å–∞—é—Ç" –∏ –Ω–µ –≤–∏–¥–Ω—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—é –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç. –ö–ª–∏–µ–Ω—Ç—ã –ø–∞–Ω–∏–∫—É—é—Ç, –∑–≤–æ–Ω—è—Ç –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É, –¥–µ–ª–∞—é—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–ª–∞—Ç—ë–∂.

- üõí **–ü–ª–æ—Ö–æ–π UX –≤ e-commerce**: –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É, –Ω–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è. –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–∞–¥–∞–µ—Ç.

- üìù **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –¥–æ–∫—É–º–µ–Ω—Ç, –≤–∏–¥–∏—Ç –µ–≥–æ –≤ —Å–ø–∏—Å–∫–µ, –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ ‚Äî –∞ –¥–æ–∫—É–º–µ–Ω—Ç "–Ω–µ –Ω–∞–π–¥–µ–Ω". –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â—ë –Ω–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á—Ç–µ–Ω–∏—è.

- üîí **–ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É —É–≤–æ–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –Ω–æ —Ç–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –µ—â—ë 5 –º–∏–Ω—É—Ç –∏–∑-–∑–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è. –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∏ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.

- üìä **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –æ—Ç—á—ë—Ç—ã**: –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–∑–¥–∞—ë—Ç –æ—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º, –Ω–æ —á–∞—Å—Ç—å —Å–≤–µ–∂–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –≤—ã–±–æ—Ä–∫—É, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ä–µ–ø–ª–∏–∫–∞ –æ—Ç—Å—Ç–∞—ë—Ç –æ—Ç –º–∞—Å—Ç–µ—Ä–∞. –ë–∏–∑–Ω–µ—Å-—Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–µ–ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

### –ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç Consistency Semantics

–í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É **Consistency Semantics** –∏ **Visibility Semantics**:

- **Consistency Semantics** –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å: "*–ö–∞–∫–∏–µ* –¥–∞–Ω–Ω—ã–µ –≤–∏–¥—è—Ç —Ä–∞–∑–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã?" (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π)
- **Visibility Semantics** –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å: "*–ö–æ–≥–¥–∞* –∏ *–∫—Ç–æ* –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è?" (–º–æ–º–µ–Ω—Ç –∏ –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏)

–ü—Ä–æ—â–µ –≥–æ–≤–æ—Ä—è: consistency ‚Äî –ø—Ä–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, visibility ‚Äî –ø—Ä–æ –∏—Ö –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ.

### –§–∞–∫—Ç–æ—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –≤–∏–¥–∏–º–æ—Å—Ç—å

–í–∏–¥–∏–º–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ñ–∞–∫—Ç–æ—Ä–æ–≤:

1. **–†–µ–ø–ª–∏–∫–∞—Ü–∏—è**: –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–∏–ª–∏—Å—å —Å –º–∞—Å—Ç–µ—Ä–∞ –Ω–∞ —Ä–µ–ø–ª–∏–∫–∏?
2. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ö–∞–∫–∏–µ —É—Ä–æ–≤–Ω–∏ –∫–µ—à–µ–π (CDN, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –±—Ä–∞—É–∑–µ—Ä) —Å—Ç–æ—è—Ç –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã?
3. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è**: –ö–æ–≥–¥–∞ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏ –¥—Ä—É–≥–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º?
4. **–°–µ—Å—Å–∏–æ–Ω–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞**: –í–∏–¥–∏—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö?
5. **–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –ö–∞–∫ –±—ã—Å—Ç—Ä–æ –¥–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–∞–º–∏?
6. **–ü–æ–ª–∏—Ç–∏–∫–∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏**: –ö–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–º—è—Ç–∏ –Ω–∞ –¥–∏—Å–∫ –∏ –¥–µ–ª–∞–µ—Ç –∏—Ö –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏?

```
–ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö                                –ü–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –≤—Å–µ–º
     ‚îÇ                                              ‚îÇ
     ‚ñº                                              ‚ñº
     ‚óè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚óè
     ‚îÇ                                              ‚îÇ
     ‚îÇ          –í–∏–¥–∏–º–æ—Å—Ç—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è          ‚îÇ
     ‚îÇ                                              ‚îÇ
     ‚îú‚îÄ –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å (—Å–∞–º –∫–ª–∏–µ–Ω—Ç)          [–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ]
     ‚îú‚îÄ –í–∏–¥–∏–º–æ—Å—Ç—å –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏                     [–ø–æ commit]
     ‚îú‚îÄ –í–∏–¥–∏–º–æ—Å—Ç—å –≤ —Å–µ—Å—Å–∏–∏                         [0-100ms]
     ‚îú‚îÄ –í–∏–¥–∏–º–æ—Å—Ç—å –≤ —Ç–æ–º –∂–µ –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–µ            [10-500ms]
     ‚îî‚îÄ –í–∏–¥–∏–º–æ—Å—Ç—å –≤ –¥—Ä—É–≥–∏—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö               [100ms-5s+]
```

‚ö†Ô∏è **–í–∞–∂–Ω–æ**: –í –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–∏—Å—Ç–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è **–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ**, –∞ –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –¥–ª—è –≤—Å–µ—Ö. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–¥—ë–∂–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

---

## Read-After-Write Visibility (–í–∏–¥–∏–º–æ—Å—Ç—å "—á—Ç–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏")

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Read-After-Write Visibility** (—Ç–∞–∫–∂–µ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è **Read-Your-Writes Consistency**) ‚Äî —ç—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—è —Ç–æ–≥–æ, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç, –≤—ã–ø–æ–ª–Ω–∏–≤—à–∏–π –∑–∞–ø–∏—Å—å, –ø—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–º —á—Ç–µ–Ω–∏–∏ **–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–≤–æ–µ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏** (–∏–ª–∏ –±–æ–ª–µ–µ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ).

–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏: "–ï—Å–ª–∏ —è —á—Ç–æ-—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª, —è –¥–æ–ª–∂–µ–Ω —ç—Ç–æ –≤–∏–¥–µ—Ç—å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ".

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

```
–í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ ‚Üí

–ö–ª–∏–µ–Ω—Ç A:  ----W(x=1)----------R(x)‚Üí –î–û–õ–ñ–ï–ù –≤–µ—Ä–Ω—É—Ç—å 1 (–∏–ª–∏ –Ω–æ–≤–µ–µ)
              –∑–∞–ø–∏—Å—å          —á—Ç–µ–Ω–∏–µ

–ö–ª–∏–µ–Ω—Ç B:  --------------------------R(x)‚Üí –ú–û–ñ–ï–¢ –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                                    —á—Ç–µ–Ω–∏–µ   (–≥–∞—Ä–∞–Ω—Ç–∏–∏ –Ω–µ—Ç)
```

–í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ:
- ‚úÖ –ö–ª–∏–µ–Ω—Ç A –û–ë–Ø–ó–ê–ù –≤–∏–¥–µ—Ç—å —Å–≤–æ—ë –∏–∑–º–µ–Ω–µ–Ω–∏–µ (x=1)
- ‚ùå –ö–ª–∏–µ–Ω—Ç B –ù–ï –û–ë–Ø–ó–ê–ù –≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç –ö–ª–∏–µ–Ω—Ç–∞ A (–º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)

### –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –ö–ª–∏–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤–æ–∏—Ö —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —á—Ç–µ–Ω–∏—è –Ω–µ "–æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è" –∫ –±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º (–º–æ–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç—å)
- –ü—Ä–∏—á–∏–Ω–Ω–æ-–∑–∞–≤–∏—Å–∏–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤–∏–¥–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

‚ùå **–ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –î—Ä—É–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—ã —É–≤–∏–¥—è—Ç —Ç–≤–æ–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞–Ω—É—Ç –≤–∏–¥–∏–º—ã–º–∏ –¥—Ä—É–≥–∏–º
- –ß—Ç–æ —Ç—ã —É–≤–∏–¥–∏—à—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

### –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

#### PostgreSQL: Session-level Read-Your-Writes

PostgreSQL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç read-after-write visibility –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏:

1. –¢—ã –ø–æ–¥–∫–ª—é—á–∞–µ—à—å—Å—è –∫ –±–∞–∑–µ (–æ—Ç–∫—Ä—ã–≤–∞–µ—à—å TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)
2. –í—ã–ø–æ–ª–Ω—è–µ—à—å `UPDATE users SET email='new@mail.com' WHERE id=123`
3. –°—Ä–∞–∑—É –∂–µ –¥–µ–ª–∞–µ—à—å `SELECT email FROM users WHERE id=123`
4. **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤–∏–¥–∏—à—å** `'new@mail.com'`

**–ù–æ**: –ï—Å–ª–∏ —Ç—ã –ø–æ–¥–∫–ª—é—á–∏—à—å—Å—è –∫ –±–∞–∑–µ —Å –¥—Ä—É–≥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ (–¥—Ä—É–≥–æ–µ TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ), —Ç—ã –º–æ–∂–µ—à—å —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ —É —Ç–µ–±—è –∞–∫—Ç–∏–≤–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å –∏–∑–æ–ª—è—Ü–∏–µ–π REPEATABLE READ –∏–ª–∏ —Ç—ã —á–∏—Ç–∞–µ—à—å —Å —Ä–µ–ø–ª–∏–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∏–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

#### MongoDB: –ü—Ä–æ–±–ª–µ–º—ã —Å read preference

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ MongoDB –¥–æ –≤–µ—Ä—Å–∏–∏ 3.6:

1. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∏—à–µ—Ç –≤ primary: `db.users.updateOne({_id: 123}, {$set: {status: 'active'}})`
2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–∏—Ç–∞–µ—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π `readPreference: 'secondary'`
3. **–í–∏–¥–∏—Ç —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ** `status: 'pending'`, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ä–µ–ø–ª–∏–∫–∞ –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∏–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ

–≠—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ read-after-write! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ**: –° MongoDB 3.6+ –ø–æ—è–≤–∏–ª–∏—Å—å causal consistency sessions, –∫–æ—Ç–æ—Ä—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç read-your-writes –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π client session.

#### Redis: Rep–ª–∏–∫–∞—Ü–∏—è async –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

Redis –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**:

1. –ö–ª–∏–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç `SET user:123:status "verified"`
2. Redis –º–∞—Å—Ç–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç `OK`
3. –ö–ª–∏–µ–Ω—Ç —Ç—É—Ç –∂–µ —á–∏—Ç–∞–µ—Ç —Å —Ä–µ–ø–ª–∏–∫–∏ `GET user:123:status`
4. **–ú–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ**, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ä–µ–ø–ª–∏–∫–∞ –µ—â—ë –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å**: Redis –¥–∞—ë—Ç read-your-writes —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã —á–∏—Ç–∞–µ—à—å —Å —Ç–æ–≥–æ –∂–µ —É–∑–ª–∞, –∫—É–¥–∞ –ø–∏—Å–∞–ª. –ï—Å–ª–∏ —É —Ç–µ–±—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –º–µ–∂–¥—É –º–∞—Å—Ç–µ—Ä–æ–º –∏ —Ä–µ–ø–ª–∏–∫–∞–º–∏ –¥–ª—è —á—Ç–µ–Ω–∏—è ‚Äî –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã.

#### Kafka: Consumer –Ω–µ –≤–∏–¥–∏—Ç —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

Producer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Kafka —Ç–æ–ø–∏–∫. –ï—Å–ª–∏ —Ç–æ—Ç –∂–µ –ø—Ä–æ—Ü–µ—Å—Å –ø—ã—Ç–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–æ—á–∏—Ç–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ Consumer, –æ–Ω **–Ω–µ —É–≤–∏–¥–∏—Ç** –µ–≥–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ:

1. Producer –ø–∏—à–µ—Ç message –≤ partition
2. Message –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –±—É—Ñ–µ—Ä –Ω–∞ broker
3. Broker –∫–æ–º–º–∏—Ç–∏—Ç message –Ω–∞ –¥–∏—Å–∫
4. Message —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è consumers

–ú–µ–∂–¥—É —à–∞–≥–∞–º–∏ 1 –∏ 4 –º–æ–∂–µ—Ç –ø—Ä–æ–π—Ç–∏ –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –¥–æ —Å–µ–∫—É–Ω–¥ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ `linger.ms`, `batch.size`, `flush.messages`).

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–∞—Ä—É—à–µ–Ω–∏—è Read-Your-Writes

#### 1. –ß—Ç–µ–Ω–∏–µ —Å —Ä–µ–ø–ª–∏–∫ (Read Replicas)

**–ü—Ä–æ–±–ª–µ–º–∞**: –ó–∞–ø–∏—Å—å –∏–¥—ë—Ç –≤ –º–∞—Å—Ç–µ—Ä, —á—Ç–µ–Ω–∏–µ ‚Äî —Å —Ä–µ–ø–ª–∏–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç—Å—Ç–∞—ë—Ç.

```
   –ö–ª–∏–µ–Ω—Ç
      ‚îÇ
      ‚îú‚îÄ write ‚îÄ‚îÄ‚Üí [Master DB] ‚îÄ‚îÄreplication lag‚îÄ‚îÄ‚Üí [Replica DB]
      ‚îÇ               (x=1)        100-500ms            (x=0)
      ‚îÇ                                                   ‚Üë
      ‚îî‚îÄ read ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ x=0
```

**–†–µ–∞–ª—å–Ω—ã–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç**: Instagram –≤ 2013 –≥–æ–¥—É —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏ —Ñ–æ—Ç–æ, –Ω–æ –Ω–µ –≤–∏–¥–µ–ª–∏ –∏—Ö –≤ –ª–µ–Ω—Ç–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ —á—Ç–µ–Ω–∏–µ —à–ª–æ —Å –æ—Ç—Å—Ç–∞—é—â–∏—Ö —Ä–µ–ø–ª–∏–∫.

**–†–µ—à–µ–Ω–∏–µ**:
- Sticky sessions: –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∫ –º–∞—Å—Ç–µ—Ä—É –Ω–∞ N —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏
- Read from master: –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞—Ç—å —Å –º–∞—Å—Ç–µ—Ä–∞ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
- Session tokens: –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–∫–µ–Ω —Å timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏, —Ä–µ–ø–ª–∏–∫–∞ –∂–¥—ë—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞

#### 2. –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞**: –ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–∑—É, –Ω–æ CDN/–∫–µ—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è/–±—Ä–∞—É–∑–µ—Ä –æ—Ç–¥–∞—ë—Ç —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

```
–ö–ª–∏–µ–Ω—Ç ‚îÄ‚îÄPOST /profile‚îÄ‚îÄ‚Üí [App] ‚îÄ‚îÄUPDATE‚îÄ‚îÄ‚Üí [DB]
                           ‚îÇ                 (–Ω–æ–≤–æ–µ)
                        invalidate
                           cache?

–ö–ª–∏–µ–Ω—Ç ‚îÄ‚îÄGET /profile‚îÄ‚îÄ‚Üí [CDN Cache] ‚îÄ‚îÄ‚Üí —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (cache hit)
                          (TTL –µ—â—ë –Ω–µ –∏—Å—Ç—ë–∫)
```

**–†–µ–∞–ª—å–Ω—ã–π –∫–µ–π—Å**: Twitter –≥–æ–¥–∞–º–∏ —Å—Ç—Ä–∞–¥–∞–ª –æ—Ç —ç—Ç–æ–≥–æ ‚Äî —Ç—ã –º–µ–Ω—è–µ—à—å –∞–≤–∞—Ç–∞—Ä, –æ–±–Ω–æ–≤–ª—è–µ—à—å —Å—Ç—Ä–∞–Ω–∏—Ü—É, –∞ —Å—Ç–∞—Ä—ã–π –∞–≤–∞—Ç–∞—Ä –≤–∏—Å–∏—Ç –º–∏–Ω—É—Ç–∞–º–∏ –∏–∑-–∑–∞ CDN –∫–µ—à–∞.

**–†–µ—à–µ–Ω–∏–µ**:
- Cache invalidation: –∞–∫—Ç–∏–≤–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏
- Cache versioning: –¥–æ–±–∞–≤–ª—è—Ç—å version query parameter (`/avatar.jpg?v=123`)
- Set-Cookie with token: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cookie –¥–ª—è bypass –∫–µ—à–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–¥–µ–ª–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏–µ
- Short TTL –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### 3. Load Balancing –±–µ–∑ session affinity

**–ü—Ä–æ–±–ª–µ–º–∞**: –ó–∞–ø–∏—Å—å –ø–æ–ø–∞–ª–∞ –Ω–∞ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Å –≥–æ—Ä—è—á–∏–º –∫–µ—à–µ–º), —á—Ç–µ–Ω–∏–µ ‚Äî –Ω–∞ –¥—Ä—É–≥–æ–π (—Å —Ö–æ–ª–æ–¥–Ω—ã–º).

```
                        Load Balancer
                              ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚ñº                  ‚ñº                  ‚ñº
     [App Server 1]    [App Server 2]    [App Server 3]
      cache: x=1        cache: x=0        cache: x=0
           ‚Üë                  ‚Üë
           ‚îÇ                  ‚îÇ
        WRITE(x=1)         READ(x)
         –∫–ª–∏–µ–Ω—Ç            –∫–ª–∏–µ–Ω—Ç
                       (–ø–æ–ø–∞–ª –Ω–∞ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä)
```

**–†–µ—à–µ–Ω–∏–µ**:
- Sticky sessions: –ø—Ä–∏–≤—è–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∫ –æ–¥–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É –ø–æ cookie/IP
- –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –∫–µ—à: Redis/Memcached –≤–º–µ—Å—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∞
- Immediate cache sync: –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö —á–µ—Ä–µ–∑ pub/sub

#### 4. Eventual consistency –≤ NoSQL

**–ü—Ä–æ–±–ª–µ–º–∞**: NoSQL –±–∞–∑—ã —Ç–∏–ø–∞ Cassandra, DynamoDB —á–∞—Å—Ç–æ —Ä–∞–±–æ—Ç–∞—é—Ç —Å eventual consistency –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

Cassandra –ø—Ä–∏–º–µ—Ä:
1. –ü–∏—à–µ—à—å –≤ Cassandra —Å `consistency=ONE` (–∑–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ 1 —Ä–µ–ø–ª–∏–∫—É)
2. –ß–∏—Ç–∞–µ—à—å —Å `consistency=ONE` (—á–∏—Ç–∞–µ—à—å —Å –ª—é–±–æ–π —Ä–µ–ø–ª–∏–∫–∏)
3. –ú–æ–∂–µ—à—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å —Ä–µ–ø–ª–∏–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∏–ª–∞ update

**–†–µ—à–µ–Ω–∏–µ**:
- `consistency=QUORUM` –¥–ª—è –∑–∞–ø–∏—Å–∏ –∏ —á—Ç–µ–Ω–∏—è (–Ω–æ –¥–æ—Ä–æ–∂–µ)
- `consistency=LOCAL_QUORUM` –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `session.execute(..., serial_consistency_level=LOCAL_SERIAL)` –¥–ª—è –ª–∏–Ω–µ–∞—Ä–∏–∑—É–µ–º—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –ü—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º —Å Read-Your-Writes

#### 1. Session Routing (–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–π)

–ü—Ä–∏–≤—è–∑—ã–≤–∞–π –∫–ª–∏–µ–Ω—Ç–∞ –∫ —Ç–æ–º—É –∂–µ —É–∑–ª—É, –∫—É–¥–∞ –æ–Ω –ø–∏—Å–∞–ª:

- –ò—Å–ø–æ–ª—å–∑—É–π sticky sessions –Ω–∞ load balancer
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π cookie —Å server ID –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏
- –ù–∞–ø—Ä–∞–≤–ª—è–π –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ç–æ—Ç –∂–µ —Å–µ—Ä–≤–µ—Ä –º–∏–Ω–∏–º—É–º 5-10 —Å–µ–∫—É–Ω–¥

**Trade-off**: –£—Å–ª–æ–∂–Ω—è–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ, –Ω–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ.

#### 2. Smart Read Routing (–£–º–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —á—Ç–µ–Ω–∏—è)

–ü–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ —á–∏—Ç–∞–π –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–≤–µ–∂–µ—Å—Ç—å—é:

- –ü–µ—Ä–≤—ã–µ 1-2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ write —á–∏—Ç–∞–π —Å master
- –ó–∞—Ç–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞–π—Å—è –Ω–∞ replicas
- –ò—Å–ø–æ–ª—å–∑—É–π exponential backoff –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∏–∫–∏**:
```
if (time_since_last_write < 2 sec):
    read from master
else if (time_since_last_write < 10 sec):
    read from closest replica with max_lag < 500ms
else:
    read from any replica
```

#### 3. Version Vectors / Logical Clocks

–ü–µ—Ä–µ–¥–∞–≤–∞–π –∫–ª–∏–µ–Ω—Ç—É "–≤–µ—Ä—Å–∏—é" –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏:

1. –ö–ª–∏–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç write, –ø–æ–ª—É—á–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ `version=42`
2. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º read –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `read_version >= 42`
3. –°–µ—Ä–≤–µ—Ä –∂–¥—ë—Ç, –ø–æ–∫–∞ –µ–≥–æ —Ä–µ–ø–ª–∏–∫–∞ –¥–æ–π–¥—ë—Ç –¥–æ –≤–µ—Ä—Å–∏–∏ 42, –ø–æ—Ç–æ–º –æ—Ç–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ

–¢–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç DynamoDB sessions, MongoDB causal consistency, Cassandra lightweight transactions.

#### 4. Write-Through Cache

–ü—Ä–∏ –∑–∞–ø–∏—Å–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–π –≤—Å–µ –∫–µ—à–∏:

1. –ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ
2. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞—Ç–æ–º–∞—Ä–Ω–æ:
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –ë–î
   - –û–±–Ω–æ–≤–ª—è–µ—Ç/–∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Å–µ —É—Ä–æ–≤–Ω–∏ –∫–µ—à–∞ (local, Redis, CDN)
3. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–µ–π

**Trade-off**: –ó–∞–ø–∏—Å—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ —á—Ç–µ–Ω–∏–µ –≤—Å–µ–≥–¥–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ.

#### 5. Critical Path Optimization

–î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –æ–±–µ—Å–ø–µ—á–∏–≤–∞–π read-your-writes, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ‚Äî —ç–∫–æ–Ω–æ–º—å:

- **–ö—Ä–∏—Ç–∏—á–Ω–æ**: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –ø–ª–∞—Ç–µ–∂–∏, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π ‚Üí –≤—Å–µ–≥–¥–∞ read from master
- **–ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ**: –õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Üí eventual consistency –ø—Ä–∏–µ–º–ª–µ–º–∞

---

## Snapshot Visibility (–í–∏–¥–∏–º–æ—Å—Ç—å —Å–Ω–∏–º–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö)

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Snapshot Visibility** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –∫–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∏–ª–∏ –∑–∞–ø—Ä–æ—Å –≤–∏–¥–∏—Ç **—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π —Å–Ω–∏–º–æ–∫** –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏. –í—Å–µ —á—Ç–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Å–Ω–∏–º–∫–∞ –≤–∏–¥—è—Ç –¥–∞–Ω–Ω—ã–µ —Ç–∞–∫, –∫–∞–∫ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∏–º–∫–∞, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —É–ª–∏—Ü—ã. –ü–æ–∫–∞ —Ç—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—à—å —Ñ–æ—Ç–æ, –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–π —É–ª–∏—Ü–µ –º–∞—à–∏–Ω—ã –µ–¥—É—Ç, –ª—é–¥–∏ —Ö–æ–¥—è—Ç, –Ω–æ –Ω–∞ —Ç–≤–æ–µ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤—Å—ë –∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ –≤ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Ç—ã –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É. Snapshot visibility —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫ –∂–µ.

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

```
Timeline ‚Üí

t0          t1          t2          t3          t4
‚îÇ           ‚îÇ           ‚îÇ           ‚îÇ           ‚îÇ
‚îÇ           ‚îú‚îÄ TX1 –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è        ‚îÇ           ‚îÇ
‚îÇ           ‚îÇ  (snapshot@t1)         ‚îÇ           ‚îÇ
‚îÇ           ‚îÇ           ‚îÇ            ‚îÇ           ‚îÇ
‚îú‚îÄ W(x=1)   ‚îÇ           ‚îú‚îÄ W(x=2)   ‚îÇ           ‚îÇ
‚îÇ commit    ‚îÇ           ‚îÇ  commit    ‚îÇ           ‚îÇ
‚îÇ           ‚îÇ           ‚îÇ            ‚îÇ           ‚îú‚îÄ W(x=3)
‚îÇ           ‚îÇ           ‚îÇ            ‚îÇ           ‚îÇ  commit
‚îÇ           ‚îÇ           ‚îÇ            ‚îÇ           ‚îÇ
‚îÇ           ‚îú‚îÄ R(x) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí –≤–∏–¥–∏—Ç x=1  ‚îÇ
‚îÇ           ‚îÇ           ‚îÇ            ‚îÇ           ‚îÇ
‚îÇ           ‚îÇ           ‚îÇ            ‚îú‚îÄ R(x) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí –≤—Å—ë –µ—â—ë –≤–∏–¥–∏—Ç x=1
‚îÇ           ‚îÇ           ‚îÇ            ‚îÇ           ‚îÇ
‚îÇ           ‚îî‚îÄ TX1 commit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è TX1:
- –°–æ–∑–¥–∞–ª–∞ snapshot –≤ –º–æ–º–µ–Ω—Ç t1
- –í–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –±—ã–ª–æ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ **–¥–æ** t1 (x=1)
- –ù–ï –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ t1 (x=2, x=3)
- –î–∞–∂–µ –µ—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ t4, –æ–Ω–∞ –≤–∏–¥–∏—Ç –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–π snapshot

### –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –í—Å–µ —á—Ç–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–∏–¥—è—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
- Snapshot –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- Repeatable reads: –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –∫–ª—é—á–∞ –≤–µ—Ä–Ω—ë—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ

‚ùå **–ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è:**
- –¢—ã —É–≤–∏–¥–∏—à—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∏–º–∫–∞
- –î—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É–≤–∏–¥—è—Ç —Ç–≤–æ–π snapshot
- –ó–∞—â–∏—Ç–∞ –æ—Ç write-write –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏)

### –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

#### PostgreSQL: REPEATABLE READ –∏ SERIALIZABLE

PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MVCC (Multi-Version Concurrency Control) –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ snapshot isolation.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. –ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π transaction ID (XID)
2. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è snapshot: —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç
3. –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Ö—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–∞–∫–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –µ—ë —Å–æ–∑–¥–∞–ª–∞/–∏–∑–º–µ–Ω–∏–ª–∞
4. –ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è: –≤–∏–¥–∏–º–∞ –ª–∏ –æ–Ω–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ snapshot?

**–ü—Ä–∏–º–µ—Ä:**

```
Session 1:                          Session 2:
BEGIN;
SELECT balance FROM accounts
WHERE id=1;
‚Üí 1000
                                    BEGIN;
                                    UPDATE accounts SET balance=1500
                                    WHERE id=1;
                                    COMMIT;
SELECT balance FROM accounts
WHERE id=1;
‚Üí 1000 (–≤—Å—ë –µ—â—ë!)

UPDATE accounts SET balance=balance-100
WHERE id=1;
‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ 1000, —Ä–µ–∑—É–ª—å—Ç–∞—Ç 900

COMMIT;
```

Session 1 **–Ω–µ –≤–∏–¥–∏—Ç** –∏–∑–º–µ–Ω–µ–Ω–∏—è Session 2, –ø–æ—Ç–æ–º—É —á—Ç–æ snapshot –±—ã–ª —Å–æ–∑–¥–∞–Ω –¥–æ –∫–æ–º–º–∏—Ç–∞ Session 2. –ù–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç **lost update**: –∏–∑–º–µ–Ω–µ–Ω–∏–µ Session 2 (1500) –ø–æ—Ç–µ—Ä—è–Ω–æ, —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 900 –≤–º–µ—Å—Ç–æ 1400.

**–†–µ—à–µ–Ω–∏–µ**: SERIALIZABLE isolation level –±—Ä–æ—Å–∏—Ç –æ—à–∏–±–∫—É serialization failure.

#### ClickHouse: Snapshot –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

ClickHouse –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–≥–æ snapshot:

1. –í—Å–µ SELECT –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å–æ snapshot
2. Snapshot –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
3. –î–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è 10 –º–∏–Ω—É—Ç, –æ–Ω –≤–∏–¥–∏—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?** –ü—Ä–µ–¥—Å—Ç–∞–≤—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å:

```
SELECT
    COUNT(*) as total_orders,
    SUM(amount) as total_revenue,
    AVG(amount) as avg_order
FROM orders
WHERE date >= '2024-01-01'
```

–ó–∞–ø—Ä–æ—Å –∏–¥—ë—Ç 5 –º–∏–Ω—É—Ç. –ë–µ–∑ snapshot:
- –í –Ω–∞—á–∞–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å—á–∏—Ç–∞–ª–∏ 10000 –∑–∞–∫–∞–∑–æ–≤
- –ó–∞ 5 –º–∏–Ω—É—Ç –¥–æ–±–∞–≤–∏–ª–æ—Å—å –µ—â—ë 100 –∑–∞–∫–∞–∑–æ–≤
- –°—É–º–º–∞ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã, –∞ COUNT ‚Äî –Ω–µ—Ç
- –ü–æ–ª—É—á–∞–µ—Ç—Å—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞: `avg_order != total_revenue / total_orders`

–°–æ snapshot –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã.

#### MongoDB: Snapshot reads (since 4.0)

MongoDB –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç snapshot reads –¥–ª—è multi-document —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:

```
session = client.start_session()
session.start_transaction(read_concern=ReadConcern("snapshot"))

# –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥—è—Ç snapshot –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
user = db.users.find_one({"_id": user_id}, session=session)
orders = db.orders.find({"user_id": user_id}, session=session)

# –ì–∞—Ä–∞–Ω—Ç–∏—è: –µ—Å–ª–∏ user —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Ç–æ –≤—Å–µ –µ–≥–æ orders –±—É–¥—É—Ç –≤–∏–¥–Ω—ã
# –ù–µ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ order —É–∂–µ –µ—Å—Ç—å, –Ω–æ user –µ—â—ë –Ω–µ –≤–∏–¥–∏–º
```

**–ë–µ–∑ snapshot**: –í–æ–∑–º–æ–∂–Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –º–µ–∂–¥—É —á—Ç–µ–Ω–∏–µ–º users –∏ orders –¥—Ä—É–≥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–∏–ª–∞ –∑–∞–∫–∞–∑, –∏ –º—ã —É–≤–∏–¥–∏–º –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Snapshot Visibility

#### 1. Write Skew Anomaly (–ê–Ω–æ–º–∞–ª–∏—è –ø–µ—Ä–µ–∫–æ—Å–∞ –∑–∞–ø–∏—Å–∏)

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–∏—Ç–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π snapshot, –ø—Ä–∏–Ω–∏–º–∞—é—Ç —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –µ–≥–æ –æ—Å–Ω–æ–≤–µ, –æ–±–µ –ø–∏—à—É—Ç ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Ä—É—à–∞–µ—Ç –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞.

**–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä ‚Äî –¥–µ–∂—É—Ä–Ω—ã–µ –≤—Ä–∞—á–∏:**

–ü—Ä–∞–≤–∏–ª–æ: –ú–∏–Ω–∏–º—É–º 1 –≤—Ä–∞—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –¥–µ–∂—É—Ä—Å—Ç–≤–µ –≤—Å–µ–≥–¥–∞. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –î–æ–∫—Ç–æ—Ä –ê–ª–∏—Å–∞ –∏ –î–æ–∫—Ç–æ—Ä –ë–æ–± –æ–±–∞ –Ω–∞ –¥–µ–∂—É—Ä—Å—Ç–≤–µ.

```
TX1 (–ê–ª–∏—Å–∞ —É—Ö–æ–¥–∏—Ç):              TX2 (–ë–æ–± —É—Ö–æ–¥–∏—Ç):
BEGIN;                           BEGIN;
SELECT COUNT(*) FROM oncall      SELECT COUNT(*) FROM oncall
WHERE status='on';               WHERE status='on';
‚Üí 2 (–ê–ª–∏—Å–∞ –∏ –ë–æ–±)                ‚Üí 2 (–ê–ª–∏—Å–∞ –∏ –ë–æ–±)

"–û–∫, –µ—Å—Ç—å –µ—â—ë 1 –≤—Ä–∞—á,            "–û–∫, –µ—Å—Ç—å –µ—â—ë 1 –≤—Ä–∞—á,
—è –º–æ–≥—É —É–π—Ç–∏"                     —è –º–æ–≥—É —É–π—Ç–∏"

UPDATE oncall                    UPDATE oncall
SET status='off'                 SET status='off'
WHERE doctor='Alice';            WHERE doctor='Bob';
COMMIT;                          COMMIT;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –û–±–∞ –¥–æ–∫—Ç–æ—Ä–∞ —É—à–ª–∏, –¥–µ–∂—É—Ä–Ω—ã—Ö –Ω–µ—Ç! Snapshot isolation –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —ç—Ç–æ–≥–æ.

**–†–µ—à–µ–Ω–∏–µ**:
- SERIALIZABLE isolation (–¥–æ—Ä–æ–≥–æ)
- Explicit locking: `SELECT ... FOR UPDATE`
- Optimistic locking: –ø—Ä–æ–≤–µ—Ä–∫–∞ constraint –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏

#### 2. Phantom Reads –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–∞–∂–µ —Å–æ snapshot isolation –≤–æ–∑–º–æ–∂–Ω—ã phantom reads, –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è predicate locking.

```
TX1:                             TX2:
BEGIN;
SELECT COUNT(*) FROM orders
WHERE status='pending';
‚Üí 10
                                 BEGIN;
                                 INSERT INTO orders
                                 (id, status) VALUES (999, 'pending');
                                 COMMIT;
SELECT COUNT(*) FROM orders
WHERE status='pending';
‚Üí 10 (snapshot!)

UPDATE orders
SET processed_at=NOW()
WHERE status='pending';
‚Üí –û–±–Ω–æ–≤–ª—è–µ—Ç 10 –∑–∞–ø–∏—Å–µ–π

COMMIT;
```

–ó–∞–ø–∏—Å—å —Å id=999 –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π, –ø–æ—Ç–æ–º—É —á—Ç–æ TX1 –Ω–µ –≤–∏–¥–µ–ª–∞ –µ—ë –≤ snapshot!

**–†–µ—à–µ–Ω–∏–µ**:
- SERIALIZABLE —Å predicate locking
- Application-level locking –Ω–∞ –≤–µ—Å—å –¥–∏–∞–ø–∞–∑–æ–Ω
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø–æ pending –∑–∞–∫–∞–∑–∞–º –∑–∞–Ω–æ–≤–æ

#### 3. Long-Running Transactions –∏ Snapshot Bloat

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–µ—Ä–∂–∞—Ç —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –¥–∞–Ω–Ω—ã—Ö, —Ä–∞–∑–¥—É–≤–∞—è —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.

PostgreSQL –ø—Ä–∏–º–µ—Ä:
1. –ó–∞–ø—É—Å–∫–∞–µ—à—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å snapshot
2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç 2 —á–∞—Å–∞ (–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å)
3. –ó–∞ 2 —á–∞—Å–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –º–∏–ª–ª–∏–æ–Ω—ã UPDATE –æ–ø–µ—Ä–∞—Ü–∏–π
4. PostgreSQL –ù–ï –ú–û–ñ–ï–¢ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è snapshot
5. –¢–∞–±–ª–∏—Ü—ã —Ä–∞–∑–¥—É–≤–∞—é—Ç—Å—è, vacuum –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç

**–†–µ–∞–ª—å–Ω—ã–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç**: –£ –∫–ª–∏–µ–Ω—Ç–∞ –≤ production –∑–∞–±—ã–ª–∏ –∑–∞–∫—Ä—ã—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ pooler connection. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏—Å–µ–ª–∞ 3 –¥–Ω—è. –ë–∞–∑–∞ –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ 500 GB, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ø–∞–ª–∞ –≤ 10 —Ä–∞–∑.

**–†–µ—à–µ–Ω–∏–µ**:
- Statement timeout: `SET statement_timeout = '5min'`
- Idle-in-transaction timeout: `SET idle_in_transaction_session_timeout = '10min'`
- Monitoring: –∞–ª–µ—Ä—Ç—ã –Ω–∞ –¥–æ–ª–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (`SELECT * FROM pg_stat_activity WHERE state='idle in transaction'`)
- Read-only replicas –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç vacuum –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ

#### 4. Snapshot Isolation != Serializability

**–ü—Ä–æ–±–ª–µ–º–∞**: –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥—É–º–∞—é—Ç, —á—Ç–æ REPEATABLE READ –¥–∞—ë—Ç –ø–æ–ª–Ω—É—é –∏–∑–æ–ª—è—Ü–∏—é. –≠—Ç–æ –Ω–µ —Ç–∞–∫.

PostgreSQL REPEATABLE READ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç snapshot isolation, –∫–æ—Ç–æ—Ä–∞—è **–ù–ï** —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–∞ serializability. –í–æ–∑–º–æ–∂–Ω—ã –∞–Ω–æ–º–∞–ª–∏–∏ —Ç–∏–ø–∞ write skew.

**–†–µ—à–µ–Ω–∏–µ**:
- –ò—Å–ø–æ–ª—å–∑—É–π SERIALIZABLE, –µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å (–Ω–æ –¥–æ—Ä–æ–∂–µ –Ω–∞ 10-30%)
- –ü–æ–Ω–∏–º–∞–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è snapshot isolation –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–π —Å —É—á—ë—Ç–æ–º —ç—Ç–æ–≥–æ
- Application-level locking –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

### –ü—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º —Å–æ Snapshot Visibility

#### 1. Short-Lived Transactions

–î–µ—Ä–∂–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ—Ä–æ—Ç–∫–∏–º–∏:

- ‚ùå **–ü–ª–æ—Ö–æ**: `BEGIN` ‚Üí –∑–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É API ‚Üí –∑–∞–ø—Ä–æ—Å –∫ –ë–î ‚Üí `COMMIT`
- ‚úÖ **–•–æ—Ä–æ—à–æ**: –∑–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É API ‚Üí `BEGIN` ‚Üí –∑–∞–ø—Ä–æ—Å –∫ –ë–î ‚Üí `COMMIT`

–ß–µ–º –¥–æ–ª—å—à–µ –∂–∏–≤—ë—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è, —Ç–µ–º –±–æ–ª—å—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ snapshot bloat.

#### 2. Read-Only Transactions –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤

–î–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π read-only —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ —Ä–µ–ø–ª–∏–∫–∞—Ö:

- –ù–µ –±–ª–æ–∫–∏—Ä—É—é—Ç vacuum –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ
- –ù–µ –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—Ç –∑–∞ —Ä–µ—Å—É—Ä—Å—ã —Å write-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
- –ú–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–ª–≥–æ –±–µ–∑ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–∞ production

PostgreSQL:
```
SET TRANSACTION READ ONLY;
SELECT ... -- –¥–æ–ª–≥–∏–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
```

#### 3. Snapshot at Start –¥–ª—è batch processing

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –±–æ–ª—å—à–æ–π –≤—ã–±–æ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–∞—Ç—á–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π snapshot:

**–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ snapshot:**
```
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ 1000 —à—Ç—É–∫:
- Batch 1: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ 1-1000 (–æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –∑–∞ 1 –º–∏–Ω—É—Ç—É)
- Batch 2: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ 1001-2000
  –ù–æ! –ó–∞ —ç—Ç—É –º–∏–Ω—É—Ç—É –¥–æ–±–∞–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å id < 1001
  –ú—ã –∏—Ö –ø—Ä–æ–ø—É—Å—Ç–∏–º
```

**–° snapshot:**
```
BEGIN;
CREATE TEMP TABLE users_to_process AS
SELECT id FROM users WHERE status='pending';
-- –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ snapshot

FOR EACH batch:
    UPDATE users SET status='processed'
    WHERE id IN (SELECT id FROM users_to_process LIMIT 1000 OFFSET ...);
COMMIT;
```

#### 4. Optimistic Concurrency Control

–î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è lost updates –∏—Å–ø–æ–ª—å–∑—É–π –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:

```
Session 1:                        Session 2:
SELECT balance, version           SELECT balance, version
FROM accounts WHERE id=1;         FROM accounts WHERE id=1;
‚Üí balance=1000, version=5         ‚Üí balance=1000, version=5

UPDATE accounts                   UPDATE accounts
SET balance=900, version=6        SET balance=1500, version=6
WHERE id=1 AND version=5;         WHERE id=1 AND version=5;
‚Üí 1 row updated ‚úì                 ‚Üí 0 rows updated ‚úó (conflict!)

COMMIT;                           ROLLBACK; retry with new snapshot
```

---

## Commit Visibility (–í–∏–¥–∏–º–æ—Å—Ç—å –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Commit Visibility** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ —Ç–æ–≥–æ, **–∫–æ–≥–¥–∞ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏** –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤. –≠—Ç–æ –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.

–ö–ª—é—á–µ–≤–æ–π –≤–æ–ø—Ä–æ—Å: –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è A –∑–∞–∫–æ–º–º–∏—Ç–∏–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ T, –∫–æ–≥–¥–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è B (–∏–ª–∏ –¥—Ä—É–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—ã) —É–≤–∏–¥—è—Ç —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è?

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

```
Timeline ‚Üí

TX A:   BEGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ W(x=1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ COMMIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                       ‚îÇ             ‚îÇ
                       ‚îÇ             ‚îÇ –º–æ–º–µ–Ω—Ç –∫–æ–º–º–∏—Ç–∞
                       ‚Üì             ‚Üì
                 –Ω–µ–≤–∏–¥–∏–º–æ       —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–∏–¥–∏–º—ã–º
                  –¥—Ä—É–≥–∏–º           (–Ω–æ –∫–æ–≥–¥–∞ –∏–º–µ–Ω–Ω–æ?)

TX B:   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BEGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ R(x) ‚îÄ‚îÄ‚îÄ‚Üí –≤–∏–¥–∏—Ç x=1?
                     ‚Üë                      –∏–ª–∏ x=0?
                     ‚îÇ
                  –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–º–µ–Ω—Ç–∞
                  —Å–æ–∑–¥–∞–Ω–∏—è snapshot
```

### –ú–æ–¥–µ–ª–∏ Commit Visibility

#### 1. Immediate Visibility (–ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –ó–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–Ω—ã **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ** –≤—Å–µ–º –ø–æ—Å–ª–µ–¥—É—é—â–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º.

```
TX A:  ‚îÄ‚îÄW(x=1)‚îÄ‚îÄCOMMIT‚îÄ‚îÄ‚îê
                         ‚Üì –≤–∏–¥–∏–º–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
TX B:  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄBEGIN‚îÄ‚îÄR(x)‚Üí1
```

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**:
- PostgreSQL —Å READ COMMITTED isolation (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- MySQL InnoDB —Å READ COMMITTED
- Oracle —Å READ COMMITTED

**–ì–∞—Ä–∞–Ω—Ç–∏–∏**:
- ‚úÖ –õ—é–±–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è, –Ω–∞—á–∞—Ç–∞—è –ø–æ—Å–ª–µ COMMIT, –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –ù–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –∫–æ–º–º–∏—Ç–æ–º –∏ –≤–∏–¥–∏–º–æ—Å—Ç—å—é (–≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ —É–∑–ª–∞)

**–ü—Ä–æ–±–ª–µ–º—ã**:
- ‚ùå Non-repeatable reads: –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∫–ª—é—á–∞
- ‚ùå Phantom reads: –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
```
TX1:                          TX2:
BEGIN;
SELECT balance FROM accounts
WHERE id=1;
‚Üí 1000
                              BEGIN;
                              UPDATE accounts SET balance=2000
                              WHERE id=1;
                              COMMIT;
SELECT balance FROM accounts
WHERE id=1;
‚Üí 2000 (–∏–∑–º–µ–Ω–∏–ª–æ—Å—å!)

UPDATE accounts
SET balance=balance+100
WHERE id=1;
‚Üí 2100 (–Ω–µ 1100!)
COMMIT;
```

#### 2. Snapshot-Based Visibility (–í–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–Ω–∏–º–∫–∞)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã **–¥–æ –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –µ—ë snapshot**.

```
TX A:  ‚îÄ‚îÄW(x=1)‚îÄ‚îÄCOMMIT‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
           ‚îÇ        ‚îÇ
TX B:  ‚îÄ‚îÄBEGIN‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄR(x)‚Üí0 (–Ω–µ –≤–∏–¥–∏—Ç, —Ç.–∫. commit –ø–æ—Å–ª–µ BEGIN)
         (snapshot)

TX C:  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄBEGIN‚îÄ‚îÄR(x)‚Üí1 (–≤–∏–¥–∏—Ç, —Ç.–∫. commit –¥–æ BEGIN)
                       (snapshot)
```

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**:
- PostgreSQL —Å REPEATABLE READ / SERIALIZABLE
- MySQL InnoDB —Å REPEATABLE READ
- SQL Server —Å SNAPSHOT isolation

**–ì–∞—Ä–∞–Ω—Ç–∏–∏**:
- ‚úÖ Repeatable reads
- ‚úÖ –ù–µ—Ç non-repeatable reads
- ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π view –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º—ã**:
- ‚ùå –í–æ–∑–º–æ–∂–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ (–ø–µ—Ä–≤—ã–π –∫–æ–º–º–∏—Ç–µ—Ä –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç)
- ‚ùå Write skew anomalies

#### 3. Monotonic Visibility (–ú–æ–Ω–æ—Ç–æ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –ö–ª–∏–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏—Ç **–º–æ–Ω–æ—Ç–æ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π—Å—è –Ω–∞–±–æ—Ä** –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–≤–∏–¥–µ–ª –∫–æ–º–º–∏—Ç C1, –æ–Ω –Ω–µ –º–æ–∂–µ—Ç "–∑–∞–±—ã—Ç—å" –µ–≥–æ –≤ –±—É–¥—É—â–∏—Ö —á—Ç–µ–Ω–∏—è—Ö.

```
–ö–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç –∫–æ–º–º–∏—Ç—ã: C1 ‚Üí C1,C2 ‚Üí C1,C2,C3 ‚Üí ...
                              ‚Üë
                       —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è, –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
```

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**:
- –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –ë–î —Å session consistency (DynamoDB, Cosmos DB)
- MongoDB —Å causal consistency

**–ì–∞—Ä–∞–Ω—Ç–∏–∏**:
- ‚úÖ –ù–µ—Ç "–≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –ø—Ä–æ—à–ª–æ–µ"
- ‚úÖ –í–∏–¥–∏–º–æ—Å—Ç—å –∫–æ–º–º–∏—Ç–æ–≤ –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ —Ä–∞—Å—Ç—ë—Ç

**–ü—Ä–æ–±–ª–µ–º—ã**:
- ‚ùå –ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–æ–º–º–∏—Ç–æ–≤ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚ùå –¢—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, session tokens)

### –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

#### PostgreSQL: READ COMMITTED vs REPEATABLE READ

**READ COMMITTED** (immediate commit visibility):

```
Session 1:                       Session 2:
BEGIN;
SELECT * FROM products
WHERE category='electronics';
‚Üí 10 rows
                                 BEGIN;
                                 INSERT INTO products ...;
                                 COMMIT;
SELECT * FROM products
WHERE category='electronics';
‚Üí 11 rows (–≤–∏–¥–∏–º –Ω–æ–≤—ã–π –∫–æ–º–º–∏—Ç!)
COMMIT;
```

–ö–∞–∂–¥—ã–π SELECT –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–∏–¥–∏—Ç —Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

**REPEATABLE READ** (snapshot-based visibility):

```
Session 1:                       Session 2:
BEGIN;
SELECT * FROM products
WHERE category='electronics';
‚Üí 10 rows
                                 BEGIN;
                                 INSERT INTO products ...;
                                 COMMIT;
SELECT * FROM products
WHERE category='electronics';
‚Üí 10 rows (–ù–ï –≤–∏–¥–∏–º –∫–æ–º–º–∏—Ç!)
COMMIT;
```

Snapshot —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –¥–∞–ª—å—à–µ –≤–∏–¥–∏–º —Ç–æ–ª—å–∫–æ –µ–≥–æ.

#### MongoDB: Read Concerns –∏ Commit Visibility

MongoDB –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π read concern:

**"local"** - –≤–∏–¥–∏—à—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —ç—Ç–æ–º —É–∑–ª–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â—ë –Ω–µ —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ):
```
write ‚Üí primary –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–Ω—ã –ø—Ä–∏ read concern "local"
      ‚Üí —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ secondaries (async)
```

**"majority"** - –≤–∏–¥–∏—à—å —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ, —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —É–∑–ª–æ–≤:
```
write ‚Üí primary –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç
      ‚Üí —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ majority
      ‚Üí –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–Ω—ã –ø—Ä–∏ read concern "majority"
```

**–†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∏—à–µ—Ç —Å `writeConcern: {w: 1}`, —á–∏—Ç–∞–µ—Ç —Å `readConcern: "local"`. Primary –ø–∞–¥–∞–µ—Ç –¥–æ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏. Failover –Ω–∞ secondary. –î–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Ö "–≤–∏–¥–µ–ª–æ"!

**–†–µ—à–µ–Ω–∏–µ**: `writeConcern: {w: "majority"}` + `readConcern: "majority"` –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

#### MySQL: GTID –∏ commit visibility –≤ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏

MySQL —Å GTID (Global Transaction ID) –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–æ–º–º–∏—Ç–æ–≤ —á–µ—Ä–µ–∑ —Ä–µ–ø–ª–∏–∫–∏:

```
Master: TX1 –∫–æ–º–º–∏—Ç–∏—Ç—Å—è ‚Üí GTID = UUID:1
        TX2 –∫–æ–º–º–∏—Ç–∏—Ç—Å—è ‚Üí GTID = UUID:2

Replica: –ü—Ä–∏–º–µ–Ω—è–µ—Ç TX1 ‚Üí executed_gtid_set = UUID:1
         –ü—Ä–∏–º–µ–Ω—è–µ—Ç TX2 ‚Üí executed_gtid_set = UUID:1-2
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å: "–†–µ–ø–ª–∏–∫–∞ —É–∂–µ –≤–∏–¥–∏—Ç GTID UUID:2?" ‚Üí –µ—Å–ª–∏ –Ω–µ—Ç, –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏–ª–∏ —á–∏—Ç–∞—Ç—å —Å –º–∞—Å—Ç–µ—Ä–∞.

#### Kafka: Commit visibility –∏ isolation levels

Kafka producer –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ partition. –ö–æ–≥–¥–∞ –æ–Ω–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏ –¥–ª—è consumers?

**Producer side:**
```
Producer –ø–∏—à–µ—Ç batch —Å–æ–æ–±—â–µ–Ω–∏–π ‚Üí —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±—É—Ñ–µ—Ä–µ –Ω–∞ broker
                                 ‚Üí broker –ø–∏—à–µ—Ç –Ω–∞ –¥–∏—Å–∫
                                 ‚Üí broker –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç producer
                                 ‚Üí —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è "committed"
```

**Consumer side —Å isolation.level:**

- **"read_uncommitted"** (default): Consumer –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ –¥–∏—Å–∫, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è producer –Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ —á—Ç–µ–Ω–∏–µ partial transaction!

- **"read_committed"**: Consumer –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. Kafka —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç uncommitted —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ consumer.

**–ü—Ä–æ–±–ª–µ–º–∞ —Å read_uncommitted:**
```
Producer –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:
  - –ø–∏—à–µ—Ç msg1 (topic1)
  - –ø–∏—à–µ—Ç msg2 (topic2)
  - ABORTS —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

Consumer —Å read_uncommitted –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å msg1,
–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –µ–≥–æ, –∞ msg2 –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—ë—Ç (abort).
```

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Commit Visibility

#### 1. Lost Updates –∏–∑-–∑–∞ READ COMMITTED

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–∏—Ç–∞—é—Ç –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ, –æ–±–µ –æ–±–Ω–æ–≤–ª—è—é—Ç, –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—É—é.

```
TX1:                              TX2:
BEGIN;                            BEGIN;
SELECT balance FROM accounts      SELECT balance FROM accounts
WHERE id=1;                       WHERE id=1;
‚Üí 1000                            ‚Üí 1000

UPDATE accounts
SET balance=1000+500=1500
WHERE id=1;
COMMIT;
(balance=1500)
                                  UPDATE accounts
                                  SET balance=1000-200=800
                                  WHERE id=1;
                                  COMMIT;
                                  (balance=800, –ø–æ—Ç–µ—Ä—è +500!)
```

TX2 –Ω–µ —É–≤–∏–¥–µ–ª–∞ –∫–æ–º–º–∏—Ç TX1, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–æ—á–∏—Ç–∞–ª–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ –∫–æ–º–º–∏—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ**:
- REPEATABLE READ –∏–ª–∏ –≤—ã—à–µ
- `SELECT ... FOR UPDATE` –¥–ª—è –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- Optimistic locking —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- Atomic operations: `UPDATE accounts SET balance=balance+500` –≤–º–µ—Å—Ç–æ read-modify-write

#### 2. Premature Visibility –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–∞–Ω–Ω—ã–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏—Ö –¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å.

Cassandra –ø—Ä–∏–º–µ—Ä:
1. –ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç —Å `consistency=ONE` (–∑–∞–ø–∏—Å—å –Ω–∞ 1 —Ä–µ–ø–ª–∏–∫—É)
2. –£–∑–µ–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ—Å–ª–µ memtable (–≤ –ø–∞–º—è—Ç–∏)
3. –î—Ä—É–≥–æ–π –∫–ª–∏–µ–Ω—Ç —á–∏—Ç–∞–µ—Ç —Å `consistency=ONE` ‚Üí –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ
4. –£–∑–µ–ª –ø–∞–¥–∞–µ—Ç –¥–æ flush –Ω–∞ –¥–∏—Å–∫ ‚Üí –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã

–ö–ª–∏–µ–Ω—Ç –≤–∏–¥–µ–ª –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å—á–µ–∑–ª–∏!

**–†–µ—à–µ–Ω–∏–µ**:
- `consistency=QUORUM` –¥–ª—è write –∏ read
- `commitlog_sync=batch` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ flush
- Application-level acknowledgment: —Å—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ "–≤–∏–¥–∏–º—ã–º–∏" —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É–∑–ª–æ–≤

#### 3. Visibility Lag –≤ read replicas

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–ª–∏–µ–Ω—Ç –∫–æ–º–º–∏—Ç–∏—Ç –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ, –Ω–æ —Ä–µ–ø–ª–∏–∫–∏ –æ—Ç—Å—Ç–∞—é—Ç ‚Üí –¥—Ä—É–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ –≤–∏–¥—è—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è.

```
–ö–ª–∏–µ–Ω—Ç A ‚Üí write ‚Üí Master (committed)
                     ‚Üì
                  replication lag 500ms
                     ‚Üì
                  Replicas (–µ—â—ë –Ω–µ –≤–∏–¥—è—Ç)
                     ‚Üë
–ö–ª–∏–µ–Ω—Ç B ‚Üê read ‚Üê‚îÄ‚îÄ‚îò (—á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)
```

**–†–µ–∞–ª—å–Ω—ã–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç**: E-commerce –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ñ–æ—Ä–º–∏–ª –∑–∞–∫–∞–∑ (–∑–∞–ø–∏—Å—å –Ω–∞ master), –ø–æ–ª—É—á–∏–ª confirmation page (—á—Ç–µ–Ω–∏–µ —Å replica), –Ω–æ "–∑–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω" ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—É–º–∞–ª, —á—Ç–æ –∑–∞–∫–∞–∑ –ø–æ—Ç–µ—Ä—è–Ω, —Å–æ–∑–¥–∞–ª –¥—É–±–ª–∏–∫–∞—Ç.

**–†–µ—à–µ–Ω–∏–µ**:
- Read from master –ø–æ—Å–ª–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö write –æ–ø–µ—Ä–∞—Ü–∏–π
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ "pending" —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- Async processing —Å eventual visibility: "–ó–∞–∫–∞–∑ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ email"

#### 4. Transaction Coordinator Failures

**–ü—Ä–æ–±–ª–µ–º–∞**: Distributed transactions —Å 2PC –º–æ–≥—É—Ç –∑–∞—Å—Ç—Ä—è—Ç—å –≤ "prepared" —Å–æ—Å—Ç–æ—è–Ω–∏–∏.

```
Coordinator: PREPARE ‚Üí Node1 ‚úì
                     ‚Üí Node2 ‚úì
             COMMIT ‚Üí Node1 ‚úì
                    ‚Üí Node2 ‚úó (coordinator crashed!)
```

Node1 –≤–∏–¥–∏—Ç –∫–æ–º–º–∏—Ç, Node2 –∑–∞—Å—Ç—Ä—è–ª –≤ prepared (–¥–∞–Ω–Ω—ã–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã, –Ω–æ –Ω–µ –≤–∏–¥–Ω—ã).

**–†–µ—à–µ–Ω–∏–µ**:
- Coordinator recovery protocol
- Timeout-based abort
- 3PC (Three-Phase Commit) –≤–º–µ—Å—Ç–æ 2PC (–Ω–æ –¥–æ—Ä–æ–∂–µ)
- –ò–∑–±–µ–≥–∞—Ç—å distributed transactions, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ (—Å–∞–≥–∏, eventual consistency)

### –ü—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º —Å —É—á—ë—Ç–æ–º Commit Visibility

#### 1. –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π SERIALIZABLE –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ–≥–æ ‚Äî —ç—Ç–æ –¥–æ—Ä–æ–≥–æ. –í—ã–±–∏—Ä–∞–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥ –∑–∞–¥–∞—á—É:

| –û–ø–µ—Ä–∞—Ü–∏—è | –£—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏ | –ü—Ä–∏—á–∏–Ω–∞ |
|----------|------------------|---------|
| –ü–ª–∞—Ç–µ–∂–∏ | SERIALIZABLE | –ö—Ä–∏—Ç–∏—á–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è | READ COMMITTED | Lost update –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω |
| –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã | REPEATABLE READ | –ù—É–∂–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å snapshot |
| –ß—Ç–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ | READ UNCOMMITTED | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ |

#### 2. Application-Level Visibility Control

–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π –≤–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –ø–æ—Å—Ç:
1. INSERT INTO posts ... ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç id=123
2. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∫–µ—à: pending_posts:user_456 = [123]
3. –ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ –ª–µ–Ω—Ç—ã: –æ–±—ä–µ–¥–∏–Ω—è–µ–º posts –∏–∑ –ë–î + pending_posts –∏–∑ –∫–µ—à–∞
4. –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ —É–¥–∞–ª—è–µ–º –∏–∑ pending_posts (–∫ —ç—Ç–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–ø–ª–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å)
```

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–π –ø–æ—Å—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–ø–ª–∏–∫–∏ –æ—Ç—Å—Ç–∞—é—Ç.

#### 3. Delayed Visibility –¥–ª—è anti-spam

–ù–∞–º–µ—Ä–µ–Ω–Ω–æ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–π –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
1. INSERT INTO comments (status='pending_review')
2. Async job –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞ —Å–ø–∞–º (1-5 —Å–µ–∫—É–Ω–¥)
3. UPDATE comments SET status='published'
4. –¢–æ–ª—å–∫–æ —Ç–æ–≥–¥–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–∏–¥—è—Ç –¥—Ä—É–≥–∏–µ
```

–î–∞—ë—Ç –≤—Ä–µ–º—è –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è UX.

#### 4. Multi-Version Visibility

–•—Ä–∞–Ω–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π –¥–∞–Ω–Ω—ã—Ö —Å —Ä–∞–∑–Ω–æ–π –≤–∏–¥–∏–º–æ—Å—Ç—å—é:

```
/api/products/123?version=draft    ‚Üí –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä
/api/products/123?version=review   ‚Üí –≤–∏–¥–∏—Ç –∫–æ–º–∞–Ω–¥–∞
/api/products/123                  ‚Üí –≤–∏–¥—è—Ç –≤—Å–µ (published)
```

–ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–ª–∞–≤–Ω–æ —Ä–∞—Å–∫–∞—Ç—ã–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ distributed transactions.

---

## Transaction Visibility (–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å)

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Transaction Visibility** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ —Ç–æ–≥–æ, **–∫–∞–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–∏–¥—è—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞** –≤–æ –≤—Ä–µ–º—è –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –≠—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç commit visibility —Ç–µ–º, —á—Ç–æ —Ñ–æ–∫—É—Å –Ω–∞ **–Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö** (in-flight) –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.

–ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
- –í–∏–¥–∏—Ç –ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è A –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ B?
- –í–∏–¥–∏—Ç –ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ –∫–æ–º–º–∏—Ç–∞?
- –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö?

### –ú–æ–¥–µ–ª–∏ Transaction Visibility

#### 1. Dirty Reads (–ì—Ä—è–∑–Ω–æ–µ —á—Ç–µ–Ω–∏–µ)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

```
TX A:   BEGIN ‚îÄ‚îÄ‚îÄ W(x=1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ROLLBACK
                    ‚îÇ                      ‚Üì
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–∫–∞—á–µ–Ω–æ

TX B:   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BEGIN ‚îÄ R(x)‚Üí1 ‚îÄ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 1 ‚îÄ ERROR!
                              ‚Üë
                          –≥—Ä—è–∑–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
```

TX B –ø—Ä–æ—á–∏—Ç–∞–ª–∞ –∑–Ω–∞—á–µ–Ω–∏–µ x=1, –∫–æ—Ç–æ—Ä–æ–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–æ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ!

**–ì–¥–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ**:
- SQL: READ UNCOMMITTED isolation level
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ NoSQL –ë–î –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**–ü—Ä–æ–±–ª–µ–º—ã**:
```
–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥:
TX A: BEGIN;
      UPDATE accounts SET balance=balance-100 WHERE id=1; (–±–∞–ª–∞–Ω—Å=900)
      -- TX A –µ—â—ë –Ω–µ –∫–æ–º–º–∏—Ç–Ω—É–ª–∞

TX B: SELECT balance FROM accounts WHERE id=1; ‚Üí 900
      IF balance < 1000:
          send_notification("–ù–∏–∑–∫–∏–π –±–∞–ª–∞–Ω—Å!")

TX A: ROLLBACK; -- –ü–µ—Ä–µ–¥—É–º–∞–ª–∏
      -- –†–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å 1000, –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –ü–æ—á—Ç–∏ –Ω–∏–∫–æ–≥–¥–∞. –¢–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫, –≥–¥–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–æ–ø—É—Å—Ç–∏–º–∞.

#### 2. Read Committed (–ß—Ç–µ–Ω–∏–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

```
TX A:   BEGIN ‚îÄ‚îÄ‚îÄ W(x=1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ COMMIT
                    ‚îÇ                 ‚îÇ
TX B:   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BEGIN ‚îÄ R(x)‚Üí0 ‚îÄ R(x)‚Üí1
                              ‚Üë         ‚Üë
                         –≤–∏–¥–∏—Ç —Å—Ç–∞—Ä–æ–µ –≤–∏–¥–∏—Ç –∫–æ–º–º–∏—Ç
```

**–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** (PostgreSQL):
- –ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è: –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞ –ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –µ—ë –∏–∑–º–µ–Ω–∏–ª–∞?
- –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è (MVCC)
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç lost updates

**–ì–∞—Ä–∞–Ω—Ç–∏–∏**:
- ‚úÖ –ù–µ—Ç dirty reads
- ‚úÖ –ù–µ—Ç dirty writes (–¥–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É)

**–ü—Ä–æ–±–ª–µ–º—ã**:
- ‚ùå Non-repeatable reads
- ‚ùå Phantom reads
- ‚ùå Read skew

#### 3. Repeatable Read (–ü–æ–≤—Ç–æ—Ä—è–µ–º–æ–µ —á—Ç–µ–Ω–∏–µ)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π snapshot –¥–∞–Ω–Ω—ã—Ö, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —á—Ç–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

```
TX A:   BEGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ W(x=1) ‚îÄ‚îÄ‚îÄ‚îÄ COMMIT
                             ‚îÇ            ‚îÇ
TX B:   ‚îÄ‚îÄ BEGIN ‚îÄ R(x)‚Üí0 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ R(x)‚Üí0 ‚îÄ COMMIT
           (snapshot)           ‚Üë
                           –≤—Å—ë –µ—â—ë –≤–∏–¥–∏—Ç 0
```

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**:
- PostgreSQL: REPEATABLE READ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç snapshot isolation
- MySQL InnoDB: REPEATABLE READ —Å gap locking

**–ì–∞—Ä–∞–Ω—Ç–∏–∏**:
- ‚úÖ –ù–µ—Ç dirty reads
- ‚úÖ –ù–µ—Ç non-repeatable reads
- ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π snapshot

**–ü—Ä–æ–±–ª–µ–º—ã**:
- ‚ùå Phantom reads (–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è—Ö)
- ‚ùå Write skew
- ‚ùå Lost updates (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SELECT FOR UPDATE)

#### 4. Serializable (–°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä–æ–º—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–º—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é.

```
TX A –∏ TX B –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
      ‚Üì
–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –µ—Å–ª–∏ –±—ã –æ–Ω–∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏—Å—å
TX A ‚Üí TX B  –∏–ª–∏  TX B ‚Üí TX A
```

**–ú–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**:

1. **Pessimistic locking** (MySQL):
   - –°—Ç—Ä–æ–≥–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —á–∏—Ç–∞–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
   - –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º, –º–µ–¥–ª–µ–Ω–Ω–µ–µ

2. **Optimistic concurrency control** (PostgreSQL SSI):
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ
   - –ü—Ä–∏ –∫–æ–º–º–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
   - –ï—Å–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç ‚Üí serialization failure, retry

**–ì–∞—Ä–∞–Ω—Ç–∏–∏**:
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è
- ‚úÖ –ù–µ—Ç –∞–Ω–æ–º–∞–ª–∏–π

**–¶–µ–Ω–∞**:
- ‚ùå –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∏–∂–µ –Ω–∞ 10-50%
- ‚ùå –ë–æ–ª—å—à–µ aborted —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–Ω—É–∂–µ–Ω retry logic)

### –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

#### PostgreSQL: Transaction visibility —á–µ—Ä–µ–∑ MVCC

PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MVCC (Multi-Version Concurrency Control) –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ transaction visibility.

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ —Ö—Ä–∞–Ω–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:
- `xmin`: ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞–ª–∞ —Å—Ç—Ä–æ–∫—É
- `xmax`: ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è —É–¥–∞–ª–∏–ª–∞/–æ–±–Ω–æ–≤–∏–ª–∞ —Å—Ç—Ä–æ–∫—É (0 –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞)

–ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏:
```
if xmin –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞ AND (xmax = 0 OR xmax –Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞ OR xmax –ø–æ—Å–ª–µ –º–æ–µ–≥–æ snapshot):
    —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∏–º–∞
else:
    —Å—Ç—Ä–æ–∫–∞ –Ω–µ–≤–∏–¥–∏–º–∞
```

**–ü—Ä–∏–º–µ—Ä:**
```
TX1 (XID=100):               TX2 (XID=101):
BEGIN;
UPDATE users SET name='Alice'
WHERE id=1;
-- –¢–µ–ø–µ—Ä—å —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–µ—Ç xmin=100, xmax=0 (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)
-- –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∏–º–µ–µ—Ç xmax=100 (–ø–æ–º–µ—á–µ–Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–π)

                             BEGIN; (snapshot: [100 –∞–∫—Ç–∏–≤–Ω–∞])
                             SELECT name FROM users WHERE id=1;
                             ‚Üí –≤–∏–¥–∏—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é (Bob), –ø–æ—Ç–æ–º—É —á—Ç–æ
                               –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞ TX 100, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–∞

COMMIT;

                             SELECT name FROM users WHERE id=1;
                             ‚Üí –≤—Å—ë –µ—â—ë –≤–∏–¥–∏—Ç Bob! (snapshot –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω)
```

#### Oracle: Read Consistency —á–µ—Ä–µ–∑ Undo Tablespace

Oracle –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç read consistency –Ω–µ–º–Ω–æ–≥–æ –∏–Ω–∞—á–µ:

1. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ undo tablespace
2. –ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π Oracle —á–∏—Ç–∞–µ—Ç –∏—Ö –∏–∑ undo
3. –ï—Å—Ç—å SCN (System Change Number) ‚Äî –º–æ–Ω–æ—Ç–æ–Ω–Ω–æ —Ä–∞—Å—Ç—É—â–∏–π —Å—á—ë—Ç—á–∏–∫

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ, undo —Å–µ–≥–º–µ–Ω—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã ‚Üí `ORA-01555: snapshot too old`.

**–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á–∏—Ç—å undo retention, —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

#### MySQL InnoDB: REPEATABLE READ —Å Next-Key Locking

MySQL InnoDB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç gap locking –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è phantom reads:

```
TX1: SELECT * FROM orders WHERE user_id=5 FOR UPDATE;
     ‚Üí –ë–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏, –Ω–æ –∏ "gap" –ø–µ—Ä–µ–¥ –∏ –ø–æ—Å–ª–µ

TX2: INSERT INTO orders (user_id=5, ...);
     ‚Üí –ë–õ–û–ö–ò–†–£–ï–¢–°–Ø! –ù–µ –º–æ–∂–µ—Ç –≤—Å—Ç–∞–≤–∏—Ç—å –≤ locked gap
```

**–ü—Ä–æ–±–ª–µ–º–∞**: Gap locks –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å deadlocks:

```
TX1: SELECT * FROM orders WHERE id > 100 FOR UPDATE;
     ‚Üí –±–ª–æ–∫–∏—Ä—É–µ—Ç gap (100, +‚àû)

TX2: SELECT * FROM orders WHERE id > 50 FOR UPDATE;
     ‚Üí –±–ª–æ–∫–∏—Ä—É–µ—Ç gap (50, +‚àû)

TX1: INSERT INTO orders (id=150, ...);
     ‚Üí –∂–¥—ë—Ç TX2 (–∫–æ–Ω—Ñ–ª–∏–∫—Ç gap locks)

TX2: INSERT INTO orders (id=120, ...);
     ‚Üí –∂–¥—ë—Ç TX1

DEADLOCK!
```

**–†–µ—à–µ–Ω–∏–µ**: READ COMMITTED –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–µ —Ç—Ä–µ–±—É—é—â–∏—Ö repeatable reads.

#### Cassandra: Tunable transaction visibility

Cassandra –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º —Å–º—ã—Å–ª–µ, –Ω–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ consistency levels:

**Lightweight Transactions (LWT)**:
```
UPDATE users SET email='new@mail.com'
WHERE id=123
IF email='old@mail.com';
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç Paxos –¥–ª—è –ª–∏–Ω–µ–∞—Ä–∏–∑—É–µ–º–æ—Å—Ç–∏. –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –≤ 10-100 —Ä–∞–∑ –æ–±—ã—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

**Batches**:
```
BEGIN BATCH
  INSERT INTO users ...;
  INSERT INTO user_emails ...;
APPLY BATCH;
```

–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ partition, –Ω–æ –ù–ï –∏–∑–æ–ª—è—Ü–∏—é. –î—Ä—É–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Transaction Visibility

#### 1. Lost Update Problem

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–∏—Ç–∞—é—Ç –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ, –æ–±–µ –∏–∑–º–µ–Ω—è—é—Ç, –æ–¥–Ω–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥—Ä—É–≥—É—é.

```
TX1:                              TX2:
BEGIN;                            BEGIN;
x = SELECT counter FROM stats;    x = SELECT counter FROM stats;
‚Üí 10                              ‚Üí 10

UPDATE stats SET counter=11;
COMMIT;

                                  UPDATE stats SET counter=11;
                                  COMMIT;

–§–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 11, –∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 12!
```

**–†–µ—à–µ–Ω–∏–µ 1 - –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞:**
```
SELECT counter FROM stats FOR UPDATE;
-- –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É, TX2 –±—É–¥–µ—Ç –∂–¥–∞—Ç—å TX1
```

**–†–µ—à–µ–Ω–∏–µ 2 - –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞:**
```
UPDATE stats SET counter=counter+1 WHERE id=1;
-- –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —á—Ç–µ–Ω–∏—è
```

**–†–µ—à–µ–Ω–∏–µ 3 - –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
UPDATE stats SET counter=11, version=version+1
WHERE id=1 AND version=5;
-- –ï—Å–ª–∏ version –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Üí 0 rows updated, retry
```

#### 2. Write Skew

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–∏—Ç–∞—é—Ç –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ, –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏, –Ω–∞—Ä—É—à–∞—é—Ç constraint.

**–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä ‚Äî meeting room booking:**

Constraint: –í –∫–æ–º–Ω–∞—Ç–µ –Ω–µ –±–æ–ª–µ–µ 1 –≤—Å—Ç—Ä–µ—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

```
TX1 (–±—Ä–æ–Ω—å 10:00-11:00):         TX2 (–±—Ä–æ–Ω—å 10:30-11:30):
BEGIN;                           BEGIN;

SELECT COUNT(*) FROM bookings    SELECT COUNT(*) FROM bookings
WHERE room=1                     WHERE room=1
  AND time_range                   AND time_range
  OVERLAPS('10:00','11:00');       OVERLAPS('10:30','11:30');
‚Üí 0 (—Å–≤–æ–±–æ–¥–Ω–æ)                   ‚Üí 0 (—Å–≤–æ–±–æ–¥–Ω–æ)

INSERT INTO bookings             INSERT INTO bookings
(room=1, start='10:00',          (room=1, start='10:30',
 end='11:00');                    end='11:30');

COMMIT;                          COMMIT;
```

–û–±–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–æ—à–ª–∏! –¢–µ–ø–µ—Ä—å –¥–≤–µ –≤—Å—Ç—Ä–µ—á–∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç—Å—è.

**–†–µ—à–µ–Ω–∏–µ**:
- SERIALIZABLE isolation (–¥–æ—Ä–æ–≥–æ)
- –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã: —Å–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞, –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏—Ö
- Application-level locking: `SELECT ... FOR UPDATE` –Ω–∞ –∫–æ–º–Ω–∞—Ç—É

#### 3. Phantom Reads

**–ü—Ä–æ–±–ª–µ–º–∞**: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç —Ä–∞–∑–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

```
TX1:                             TX2:
BEGIN;
SELECT COUNT(*) FROM orders
WHERE status='pending';
‚Üí 10
                                 BEGIN;
                                 INSERT INTO orders
                                 (status='pending', ...);
                                 COMMIT;
SELECT COUNT(*) FROM orders
WHERE status='pending';
‚Üí 11 (phantom row!)
```

**–†–µ—à–µ–Ω–∏–µ**:
- REPEATABLE READ —Å snapshot isolation (PostgreSQL)
- SERIALIZABLE —Å predicate locking
- –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: —Ö—Ä–∞–Ω–∏ —Å—á—ë—Ç—á–∏–∫ –æ—Ç–¥–µ–ª—å–Ω–æ, –æ–±–Ω–æ–≤–ª—è–π –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

#### 4. Deadlocks –∏–∑-–∑–∞ visibility conflicts

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—ã—Ç–∞—é—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.

```
TX1:                             TX2:
BEGIN;                           BEGIN;
UPDATE accounts                  UPDATE accounts
SET balance=balance-100          SET balance=balance+50
WHERE id=1;                      WHERE id=2;
(–±–ª–æ–∫–∏—Ä—É–µ—Ç id=1)                 (–±–ª–æ–∫–∏—Ä—É–µ—Ç id=2)

UPDATE accounts                  UPDATE accounts
SET balance=balance+100          SET balance=balance-50
WHERE id=2;                      WHERE id=1;
(–∂–¥—ë—Ç TX2)                       (–∂–¥—ë—Ç TX1)

DEADLOCK!
```

**–†–µ—à–µ–Ω–∏–µ**:
- –£–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –≤—Å–µ–≥–¥–∞ –±–ª–æ–∫–∏—Ä—É–π –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è ID
- –ò—Å–ø–æ–ª—å–∑—É–π timeout –¥–ª—è deadlock detection
- Retry logic —Å exponential backoff

### –ü—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### 1. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–∞—è vs –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞

**–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–∞—è (–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)**:
- ‚úÖ –•–æ—Ä–æ—à–æ –¥–ª—è low-contention —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º
- ‚ùå –¢—Ä–µ–±—É–µ—Ç retry logic
- ‚ùå –ü–ª–æ—Ö–æ –¥–ª—è high-contention

**–ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–∞—è (SELECT FOR UPDATE)**:
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —É—Å–ø–µ—Ö –±–µ–∑ retry
- ‚úÖ –•–æ—Ä–æ—à–æ –¥–ª—è high-contention
- ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º
- ‚ùå –†–∏—Å–∫ deadlocks

–í—ã–±–æ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∞—Å—Ç–æ—Ç—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:
```
if (–∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã < 10%):
    –∏—Å–ø–æ–ª—å–∑—É–π –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
else:
    –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–µ—Å–∫—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
```

#### 2. –ö–æ—Ä–æ—Ç–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–î–µ—Ä–∂–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ—Ä–æ—Ç–∫–∏–º–∏:

‚ùå **–ü–ª–æ—Ö–æ:**
```
BEGIN
  SELECT ... (–∑–∞–ø—Ä–æ—Å –∫ –ë–î)
  -- –≤—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ API (500ms)
  -- –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö (200ms)
  UPDATE ... (–∑–∞–ø—Ä–æ—Å –∫ –ë–î)
COMMIT
```

‚úÖ **–•–æ—Ä–æ—à–æ:**
```
SELECT ... (–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
-- –≤—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ API
-- –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
BEGIN
  UPDATE ...
COMMIT
```

#### 3. Retry Logic —Å Exponential Backoff

Serialization failures —Ç—Ä–µ–±—É—é—Ç retry:

```
max_retries = 3
retry_delay = 100ms

for attempt in 1..max_retries:
    try:
        BEGIN
        ... –æ–ø–µ—Ä–∞—Ü–∏–∏ ...
        COMMIT
        break
    except SerializationFailure:
        if attempt == max_retries:
            raise
        sleep(retry_delay * 2^attempt + random(0, 100ms))
```

#### 4. Isolation Level –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

–ù–∞—Å—Ç—Ä–æ–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π isolation level –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

- **Web apps** (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏): READ COMMITTED
- **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã**: SERIALIZABLE
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: REPEATABLE READ
- **High-throughput APIs**: READ COMMITTED —Å optimistic locking

---

## Session Visibility (–°–µ—Å—Å–∏–æ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å)

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Session Visibility** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, **–∫–∞–∫ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏ –≤ —Ä–∞–º–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å–µ—Å—Å–∏–∏**. –°–µ—Å—Å–∏—è ‚Äî —ç—Ç–æ –ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –æ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –¥–∞–∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤.

–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è: –ö–ª–∏–µ–Ω—Ç –≤ —Ä–∞–º–∫–∞—Ö —Å–≤–æ–µ–π —Å–µ—Å—Å–∏–∏ –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å **—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ** —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –∏ –¥–∞–Ω–Ω—ã–µ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.

### –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

```
–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å–µ—Å—Å–∏—è (session_id=abc123)
       ‚îÇ
       ‚îú‚îÄ Request 1: POST /cart/add (item=X)
       ‚îÇ    ‚Üì
       ‚îÇ  [Server A, Replica 1] ‚Üí writes item X
       ‚îÇ
       ‚îú‚îÄ Request 2: GET /cart
       ‚îÇ    ‚Üì
       ‚îÇ  [Server B, Replica 2] ‚Üí –î–û–õ–ñ–ï–ù –≤–∏–¥–µ—Ç—å item X
       ‚îÇ                          (–¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–ø–ª–∏–∫–∞ –æ—Ç—Å—Ç–∞—ë—Ç!)
       ‚îÇ
       ‚îî‚îÄ Request 3: POST /checkout
            ‚Üì
          [Server C, Master] ‚Üí –î–û–õ–ñ–ï–ù –≤–∏–¥–µ—Ç—å item X
```

### –ì–∞—Ä–∞–Ω—Ç–∏–∏ Session Visibility

#### 1. Read-Your-Writes (–≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏)

–ö–ª–∏–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤–æ–∏—Ö —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤–Ω—É—Ç—Ä–∏ —Å–µ—Å—Å–∏–∏:

```
Session A:  ‚îÄ W(x=1) ‚îÄ R(x) ‚Üí MUST return 1 ‚îÄ W(x=2) ‚îÄ R(x) ‚Üí MUST return 2

Session B:  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ R(x) ‚Üí MAY return 0,1, or 2
```

#### 2. Monotonic Reads (–º–æ–Ω–æ—Ç–æ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ)

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—á–∏—Ç–∞–ª –∑–Ω–∞—á–µ–Ω–∏–µ, –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —á—Ç–µ–Ω–∏—è –Ω–µ –º–æ–≥—É—Ç –≤–µ—Ä–Ω—É—Ç—å –±–æ–ª–µ–µ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:

```
Session A:  ‚îÄ R(x)‚Üí2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ R(x) ‚Üí MUST return ‚â•2, NOT 1 or 0
```

#### 3. Monotonic Writes (–º–æ–Ω–æ—Ç–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å)

–ó–∞–ø–∏—Å–∏ –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

```
Session A:  ‚îÄ W(x=1) ‚îÄ W(x=2) ‚îÄ W(x=3)
              ‚îÇ         ‚îÇ         ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚Üí —Ä–µ–ø–ª–∏–∫–∏ –≤–∏–¥—è—Ç –≤ –ø–æ—Ä—è–¥–∫–µ 1‚Üí2‚Üí3
```

#### 4. Writes Follow Reads

–ó–∞–ø–∏—Å—å –ø–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è –≤–∏–¥–∏—Ç —Ç–æ –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ –∏ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ:

```
Session A:  ‚îÄ R(x)‚Üí2 ‚îÄ W(y=f(x)) ‚Üí W –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ x=2, –∞ –Ω–µ –±–æ–ª–µ–µ —Å—Ç–∞—Ä–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
```

### –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

#### DynamoDB: Session Consistency —á–µ—Ä–µ–∑ Session Tokens

AWS DynamoDB –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–ø—Ü–∏—é `ConsistentRead` –∏ session tokens –¥–ª—è session visibility.

**–ë–µ–∑ session consistency:**
```
1. –ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –≤ DynamoDB: PutItem(user_id=123, status='verified')
   ‚Üí –ó–∞–ø–∏—Å—å –∏–¥—ë—Ç –≤ primary partition

2. –ö–ª–∏–µ–Ω—Ç —Ç—É—Ç –∂–µ —á–∏—Ç–∞–µ—Ç: GetItem(user_id=123) —Å ConsistentRead=false
   ‚Üí –ß—Ç–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–∞ —Ä–µ–ø–ª–∏–∫—É, –∫–æ—Ç–æ—Ä–∞—è –µ—â—ë –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å
   ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç status='pending' (—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!)
```

**–° consistent read:**
```
GetItem(user_id=123, ConsistentRead=true)
‚Üí –í—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ—Ç —Å primary partition
‚Üí –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤–∏–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
```

**–ü—Ä–æ–±–ª–µ–º–∞**: Consistent reads –≤ 2 —Ä–∞–∑–∞ –¥–æ—Ä–æ–∂–µ –∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å Global Tables (multi-region).

**–†–µ—à–µ–Ω–∏–µ**: Session tokens ‚Äî –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω —Å version –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏, –ø–µ—Ä–µ–¥–∞—ë—Ç –µ–≥–æ –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —á—Ç–µ–Ω–∏—è—Ö.

#### MongoDB: Causal Consistency Sessions

MongoDB 3.6+ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç causal consistency —á–µ—Ä–µ–∑ client sessions:

```
session = client.start_session(causal_consistency=True)

# Request 1: Write
db.users.update_one(
    {"_id": user_id},
    {"$set": {"verified": True}},
    session=session
)
# Session –ø–æ–ª—É—á–∞–µ—Ç operation_time (–ª–æ–≥–∏—á–µ—Å–∫–∏–π timestamp)

# Request 2: Read (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–π —Ä–µ–ø–ª–∏–∫–µ)
user = db.users.find_one({"_id": user_id}, session=session)
# MongoDB –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç: —á—Ç–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç —Å —Ä–µ–ø–ª–∏–∫–∏,
# –∫–æ—Ç–æ—Ä–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å –º–∏–Ω–∏–º—É–º –¥–æ operation_time

‚Üí –ö–ª–∏–µ–Ω—Ç –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û –≤–∏–¥–∏—Ç verified=True
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. –ü–æ—Å–ª–µ write MongoDB –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `operationTime` (cluster time)
2. –ö–ª–∏–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ session
3. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º read –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `afterClusterTime=operationTime`
4. –°–µ—Ä–≤–µ—Ä –∂–¥—ë—Ç, –ø–æ–∫–∞ –µ–≥–æ oplog –¥–æ–π–¥—ë—Ç –¥–æ —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ—Ç–æ–º —á–∏—Ç–∞–µ—Ç

#### Redis: –ü—Ä–æ–±–ª–µ–º—ã —Å session visibility

Redis –ù–ï –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π session consistency –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ä–µ–ø–ª–∏–∫.

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
1. –ö–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–∞ master: SET session:abc123 "user_id=456"
2. Master —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç async –Ω–∞ replica (–∑–∞–¥–µ—Ä–∂–∫–∞ 10-100ms)
3. –ö–ª–∏–µ–Ω—Ç —á–∏—Ç–∞–µ—Ç —Å replica: GET session:abc123
   ‚Üí –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å nil –∏–ª–∏ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

**–†–µ—à–µ–Ω–∏—è:**

1. **–í—Å–µ–≥–¥–∞ —á–∏—Ç–∞—Ç—å —Å master:**
   ```
   –ò—Å–ø–æ–ª—å–∑—É–π Redis Sentinel –∏–ª–∏ Cluster,
   –Ω–æ –Ω–∞–ø—Ä–∞–≤–ª—è–π –í–°–ï –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ master
   ```
   –ú–∏–Ω—É—Å: –†–µ–ø–ª–∏–∫–∏ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—Ç, –Ω–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è —á—Ç–µ–Ω–∏—è.

2. **Sticky sessions:**
   ```
   –ü–æ—Å–ª–µ write –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∫ master –Ω–∞ N —Å–µ–∫—É–Ω–¥
   –ó–∞—Ç–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ replicas
   ```

3. **WAIT –∫–æ–º–∞–Ω–¥–∞:**
   ```
   SET session:abc123 "user_id=456"
   WAIT 1 1000  # –ñ–¥–∞—Ç—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ 1 —Ä–µ–ø–ª–∏–∫—É, timeout 1 —Å–µ–∫
   ‚Üí –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º–∏–Ω–∏–º—É–º 1 —Ä–µ–ø–ª–∏–∫–∞ –ø–æ–ª—É—á–∏–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
   ```

#### Cosmos DB: Session consistency level

Azure Cosmos DB –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç 5 —É—Ä–æ–≤–Ω–µ–π consistency, –≤–∫–ª—é—á–∞—è "session":

```
Session consistency (default):
- Read-your-writes –≤–Ω—É—Ç—Ä–∏ —Å–µ—Å—Å–∏–∏
- Monotonic reads
- Writes follow reads

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ session tokens:
1. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç session token –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
2. –¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç LSN (Log Sequence Number)
3. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º read –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç —Ç–æ–∫–µ–Ω
4. –°–µ—Ä–≤–µ—Ä –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–∏–Ω–∏–º—É–º –¥–æ —ç—Ç–æ–≥–æ LSN
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ**: Session consistency —Ä–∞–±–æ—Ç–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ (multi-region), –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç strong consistency.

```
User –≤ US:  ‚îÄ write ‚îÄ‚Üí [US region] ‚îÄ token: LSN=1000
                          ‚Üì
                       geo-replication (100-300ms)
                          ‚Üì
User –≤ EU:  ‚îÄ read with token:LSN=1000 ‚îÄ‚Üí [EU region]
                          ‚Üì
                    –∂–¥—ë—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ LSN=1000
                          ‚Üì
                    –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
```

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Session Visibility

#### 1. Session Affinity –Ω–∞—Ä—É—à–µ–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏/—Ä–µ–ø–ª–∏–∫–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ —Å–µ—Å—Å–∏–∏, –≤–∏–¥–∏–º–æ—Å—Ç—å –ª–æ–º–∞–µ—Ç—Å—è.

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
1. User –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ Server A
   Server A —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç session cookie

2. User –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å ‚Üí load balancer –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ Server B
   Server B –Ω–µ –≤–∏–¥–∏—Ç —Å–µ—Å—Å–∏—é (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ Server A)

3. User –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ /login (—Å–µ—Å—Å–∏—è "–ø–æ—Ç–µ—Ä—è–Ω–∞")
```

**–†–µ—à–µ–Ω–∏–µ 1 - Sticky sessions –Ω–∞ load balancer:**
```
HAProxy config:
  cookie SERVERID insert indirect nocache
  server server1 10.0.0.1:8000 cookie s1
  server server2 10.0.0.2:8000 cookie s2

‚Üí –ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –æ–¥–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
```

**–†–µ—à–µ–Ω–∏–µ 2 - Distributed session store:**
```
–í–º–µ—Å—Ç–æ in-memory sessions:
  ‚Üí Redis/Memcached –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π
  ‚Üí –í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã —á–∏—Ç–∞—é—Ç –∏–∑ –æ–¥–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
```

**–†–µ—à–µ–Ω–∏–µ 3 - Stateless sessions:**
```
JWT tokens –≤–º–µ—Å—Ç–æ server-side sessions:
  ‚Üí –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–æ–∫–µ–Ω–µ (–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–º)
  ‚Üí –õ—é–±–æ–π —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å
```

#### 2. Session expiry –∏ visibility

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–µ—Å—Å–∏—è "–ø—Ä–æ—Ç—É—Ö–∞–µ—Ç" –Ω–∞ –æ–¥–Ω–∏—Ö —Ä–µ–ø–ª–∏–∫–∞—Ö, –Ω–æ –µ—â—ë –∞–∫—Ç–∏–≤–Ω–∞ –Ω–∞ –¥—Ä—É–≥–∏—Ö.

```
1. User –∞–∫—Ç–∏–≤–µ–Ω, session_expiry –ø—Ä–æ–¥–ª—è–µ—Ç—Å—è –Ω–∞ Master
2. –†–µ–ø–ª–∏–∫–∞ –æ—Ç—Å—Ç–∞—ë—Ç –Ω–∞ 5 —Å–µ–∫—É–Ω–¥
3. User –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–ø–ª–∏–∫—É
4. –†–µ–ø–ª–∏–∫–∞ –≤–∏–¥–∏—Ç —Å—Ç–∞—Ä—ã–π session_expiry ‚Üí —Å—á–∏—Ç–∞–µ—Ç —Å–µ—Å—Å–∏—é –∏—Å—Ç—ë–∫—à–µ–π
5. User –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è ‚Üí –ø–ª–æ—Ö–æ–π UX
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–π –∞–±—Å–æ–ª—é—Ç–Ω—ã–π TTL –≤–º–µ—Å—Ç–æ sliding expiry –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- –ß–∏—Ç–∞–π session —Å master –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (logout, payment)
- –î–æ–±–∞–≤—å grace period: `if (now < expiry + 10 sec): still valid`

#### 3. Multi-Device Session Visibility

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –æ–¥–Ω–æ–º –Ω–µ –≤–∏–¥–Ω—ã –Ω–∞ –¥—Ä—É–≥–æ–º.

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
User –Ω–∞ Desktop:  ‚îÄ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É ‚îÄ‚Üí [Session A]
User –Ω–∞ Mobile:   ‚îÄ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–æ—Ä–∑–∏–Ω—É ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí [Session B, –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è]
```

**–ü—Ä–∏—á–∏–Ω–∞**: Session A –∏ Session B ‚Äî —Ä–∞–∑–Ω—ã–µ —Å–µ—Å—Å–∏–∏, –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.

**–†–µ—à–µ–Ω–∏–µ 1 - User-based state –≤–º–µ—Å—Ç–æ session-based:**
```
–•—Ä–∞–Ω–∏ –∫–æ—Ä–∑–∏–Ω—É –≤ –ë–î –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫ user_id, –∞ –Ω–µ –∫ session_id
‚Üí –í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤–∏–¥—è—Ç –æ–¥–Ω—É –∫–æ—Ä–∑–∏–Ω—É
```

**–†–µ—à–µ–Ω–∏–µ 2 - Distributed session —Å user_id:**
```
session_key = f"session:{user_id}"  # –Ω–µ session_id!
‚Üí –í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω—É —Å–µ—Å—Å–∏—é
```

**–†–µ—à–µ–Ω–∏–µ 3 - Eventual sync:**
```
–ö–∞–∂–¥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–º–µ–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é
–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
–ò—Å–ø–æ–ª—å–∑—É–π conflict resolution (last-write-wins, CRDT)
```

#### 4. Cross-Region Session Visibility

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É—Ç–µ—à–µ—Å—Ç–≤—É–µ—Ç, –µ–≥–æ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω, —Å–µ—Å—Å–∏—è –Ω–µ –≤–∏–¥–Ω–∞.

```
User –≤ US:  ‚îÄ login ‚îÄ‚Üí [US region]
                        session —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ US Redis

User –ª–µ—Ç–∏—Ç –≤ EU

User –≤ EU:  ‚îÄ request ‚îÄ‚Üí [EU region]
                         –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ EU Redis
                         ‚Üí —Å–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
```

**–†–µ—à–µ–Ω–∏–µ 1 - Global session store:**
```
–ò—Å–ø–æ–ª—å–∑—É–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π session store (DynamoDB Global Tables, Cosmos DB)
‚Üí –î–∞–Ω–Ω—ã–µ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É—é—Ç—Å—è –≤–æ –≤—Å–µ —Ä–µ–≥–∏–æ–Ω—ã
–ó–∞–¥–µ—Ä–∂–∫–∞: 100-500ms, –Ω–æ —Å–µ—Å—Å–∏—è –≤–∏–¥–Ω–∞ –≤–µ–∑–¥–µ
```

**–†–µ—à–µ–Ω–∏–µ 2 - Session migration:**
```
1. EU region –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å–µ—Å—Å–∏—é –ª–æ–∫–∞–ª—å–Ω–æ
2. –î–µ–ª–∞–µ—Ç fallback –Ω–∞ US region
3. –ö–æ–ø–∏—Ä—É–µ—Ç —Å–µ—Å—Å–∏—é –≤ EU region
4. –î–∞–ª—å—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –∫–æ–ø–∏–µ–π
```

**–†–µ—à–µ–Ω–∏–µ 3 - JWT tokens:**
```
–°–µ—Å—Å–∏—è –≤ —Ç–æ–∫–µ–Ω–µ, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–æ–º
‚Üí –ù–µ —Ç—Ä–µ–±—É–µ—Ç lookup –≤ –ë–î
‚Üí –†–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Å–µ—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö
```

### –ü—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å Session Visibility

#### 1. Session Token Propagation

–ü–µ—Ä–µ–¥–∞–≤–∞–π session token —á–µ—Ä–µ–∑ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏:

```
Client                     Backend
  ‚îÇ                           ‚îÇ
  ‚îú‚îÄ POST /api/cart/add ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ
  ‚îÇ                           ‚îú‚îÄ write to DB
  ‚îÇ                           ‚îú‚îÄ –ø–æ–ª—É—á–∞–µ—Ç session_token: "v=123"
  ‚îÇ‚Üê‚îÄ response: {session_token: "v=123"}
  ‚îÇ                           ‚îÇ
  ‚îú‚îÄ GET /api/cart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ
  ‚îÇ   Header: X-Session-Token: "v=123"
  ‚îÇ                           ‚îú‚îÄ read from DB with min_version=123
  ‚îÇ‚Üê‚îÄ response: [items]       ‚îÇ
```

#### 2. Session TTL –∏ Sliding Window

–ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ TTL –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–µ—Å—Å–∏–π:

```
–ê–Ω–æ–Ω–∏–º–Ω–∞—è —Å–µ—Å—Å–∏—è (–∫–æ—Ä–∑–∏–Ω–∞):    TTL = 24 —á–∞—Å–∞, sliding window
–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è:         TTL = 7 –¥–Ω–µ–π, sliding window
Remember-me:                   TTL = 30 –¥–Ω–µ–π, absolute
```

Sliding window: TTL –ø—Ä–æ–¥–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

#### 3. Graceful Session Degradation

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –≤–∏–¥–∏–º–æ—Å—Ç—å—é –¥–µ–≥—Ä–∞–¥–∏—Ä—É–π gracefully:

```
try:
    session = read_from_redis(session_id, consistent=True)
except Timeout:
    # Fallback: —á–∏—Ç–∞–µ–º –∏–∑ –∫–µ—à–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º)
    session = read_from_local_cache(session_id)
    session.degraded = True  # –û—Ç–º–µ—Ç–∫–∞ –¥–ª—è –ª–æ–≥–æ–≤

if session.degraded:
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
    disable_critical_operations()
    show_warning_to_user("–ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã")
```

#### 4. Session Handoff –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏

–î–ª—è seamless multi-device UX –∏—Å–ø–æ–ª—å–∑—É–π QR-–∫–æ–¥—ã –∏–ª–∏ push:

```
User –Ω–∞ Desktop:
  1. –ù–∞—á–∏–Ω–∞–µ—Ç checkout
  2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è session_handoff_token
  3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è QR-–∫–æ–¥

User —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR –Ω–∞ Mobile:
  4. Mobile –ø–æ–ª—É—á–∞–µ—Ç session_handoff_token
  5. Backend –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω
  6. Mobile –ø–æ–ª—É—á–∞–µ—Ç full session state
  7. User –∑–∞–≤–µ—Ä—à–∞–µ—Ç checkout –Ω–∞ Mobile
```

---

## Cross-Region Visibility (–ú–µ–∂—Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å)

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Cross-Region Visibility** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, **–∫–∞–∫ –±—ã—Å—Ç—Ä–æ –∏ —Å –∫–∞–∫–∏–º–∏ –≥–∞—Ä–∞–Ω—Ç–∏—è–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏ –≤ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä–∞—Ö**. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –æ–±—Å–ª—É–∂–∏–≤–∞—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É.

–ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã:
- Latency (–∑–∞–¥–µ—Ä–∂–∫–∞): –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ–∂–¥—É —Ä–µ–≥–∏–æ–Ω–∞–º–∏?
- Consistency (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å): –ö–∞–∫–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–∞—é—Ç—Å—è –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤?
- Availability (–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å): –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Å–µ—Ç–µ–≤–æ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ –º–µ–∂–¥—É —Ä–µ–≥–∏–æ–Ω–∞–º–∏?

### –§–∏–∑–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

**Speed of light** –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

```
–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–≥–∏–æ–Ω–∞–º–∏   | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (RTT)
------------------------------|---------------------------
–ú–æ—Å–∫–≤–∞ ‚Üî –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥     | ~6 ms
–ú–æ—Å–∫–≤–∞ ‚Üî –õ–æ–Ω–¥–æ–Ω              | ~60 ms
–ú–æ—Å–∫–≤–∞ ‚Üî –ù—å—é-–ô–æ—Ä–∫            | ~120 ms
–ú–æ—Å–∫–≤–∞ ‚Üî –¢–æ–∫–∏–æ               | ~160 ms
–ú–æ—Å–∫–≤–∞ ‚Üî –°–∏–¥–Ω–µ–π              | ~280 ms
```

–≠—Ç–æ **–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ** –∑–∞–¥–µ—Ä–∂–∫–∏. –†–µ–∞–ª—å–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –æ–±—ã—á–Ω–æ –≤ 1.5-3 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –∏–∑-–∑–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.

### –ú–æ–¥–µ–ª–∏ Cross-Region Visibility

#### 1. Active-Passive (Master-Replica)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –û–¥–∏–Ω —Ä–µ–≥–∏–æ–Ω ‚Äî master (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø–∏—Å–∏), –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî read-only —Ä–µ–ø–ª–∏–∫–∏.

```
            [US region - MASTER]
                 ‚îÇ
                 ‚îÇ async replication
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚Üì                   ‚Üì
[EU region]          [APAC region]
(read-only)          (read-only)
```

**Visibility –≥–∞—Ä–∞–Ω—Ç–∏–∏:**
- ‚úÖ –ó–∞–ø–∏—Å–∏ –≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ (–æ–¥–∏–Ω master)
- ‚ùå –†–µ–ø–ª–∏–∫–∏ –æ—Ç—Å—Ç–∞—é—Ç –Ω–∞ 100-5000ms (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è)
- ‚ùå –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ master —Ç—Ä–µ–±—É–µ—Ç—Å—è failover (downtime)

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**: PostgreSQL —Å streaming replication, MySQL —Å binlog replication, MongoDB replica set.

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã:**
```
1. User –≤ EU –¥–µ–ª–∞–µ—Ç –∑–∞–∫–∞–∑ ‚Üí –ø–∏—à–µ—Ç –≤ US master
2. US master –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç "–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω"
3. User –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Üí –∑–∞–ø—Ä–æ—Å –∏–¥—ë—Ç –Ω–∞ EU replica
4. EU replica –æ—Ç—Å—Ç–∞—ë—Ç –Ω–∞ 500ms ‚Üí –∑–∞–∫–∞–∑ –µ—â—ë –Ω–µ –≤–∏–¥–∏–º
5. User –ø–∞–Ω–∏–∫—É–µ—Ç: "–ó–∞–∫–∞–∑ –ø–æ—Ç–µ—Ä—è–Ω!"
```

#### 2. Active-Active (Multi-Master)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –ù–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–≥–∏–æ–Ω–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –∑–∞–ø–∏—Å–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.

```
[US region] ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí [EU region]
     ‚Üë                    ‚Üë
     ‚îÇ  bi-directional   ‚îÇ
     ‚îÇ   replication      ‚îÇ
     ‚Üì                    ‚Üì
[APAC region] ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí [...]
```

**Visibility –≥–∞—Ä–∞–Ω—Ç–∏–∏:**
- ‚úÖ –ù–∏–∑–∫–∞—è latency –∑–∞–ø–∏—Å–∏ (–ª–æ–∫–∞–ª—å–Ω—ã–π master)
- ‚úÖ –í—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (–∫–∞–∂–¥—ã–π —Ä–µ–≥–∏–æ–Ω –Ω–µ–∑–∞–≤–∏—Å–∏–º)
- ‚ùå –í–æ–∑–º–æ–∂–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã (–¥–≤–∞ —Ä–µ–≥–∏–æ–Ω–∞ –∏–∑–º–µ–Ω—è—é—Ç –æ–¥–Ω–∏ –¥–∞–Ω–Ω—ã–µ)
- ‚ùå Eventual consistency

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**: CockroachDB, Cassandra, DynamoDB Global Tables, Cosmos DB.

**–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞:**
```
t0: –±–∞–ª–∞–Ω—Å user_id=123 —Ä–∞–≤–µ–Ω 1000 –≤–æ –≤—Å–µ—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö

t1: [US]  —Å–ø–∏—Å—ã–≤–∞–µ—Ç 600 ‚Üí –±–∞–ª–∞–Ω—Å 400
    [EU]  —Å–ø–∏—Å—ã–≤–∞–µ—Ç 500 ‚Üí –±–∞–ª–∞–Ω—Å 500

t2: –†–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç—Å—è:
    [US] –ø–æ–ª—É—á–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–∑ EU ‚Üí –±–∞–ª–∞–Ω—Å 500 - 600 = -100 ‚ùå
    [EU] –ø–æ–ª—É—á–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–∑ US ‚Üí –±–∞–ª–∞–Ω—Å 400 - 500 = -100 ‚ùå

–ö–æ–Ω—Ñ–ª–∏–∫—Ç! –ù—É–∂–Ω–∞ conflict resolution strategy.
```

#### 3. Quorum-Based (–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è)

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∫–≤–æ—Ä—É–º —É–∑–ª–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö.

```
Client –ø–∏—à–µ—Ç –≤ [US region]
       ‚Üì
[US] –ø–∏—à–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
[US] –∂–¥—ë—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:        ‚îÇ
  ‚îú‚îÄ‚Üí [EU] ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ACK            ‚îú‚îÄ‚Üí Quorum (2/3) ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
  ‚îú‚îÄ‚Üí [APAC] ‚îÄ‚îÄ‚Üí ACK            ‚îÇ
  ‚îî‚îÄ‚Üí [SA] ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí timeout        ‚îò
```

**Visibility –≥–∞—Ä–∞–Ω—Ç–∏–∏:**
- ‚úÖ Strong consistency
- ‚úÖ –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –æ–¥–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
- ‚ùå –í—ã—Å–æ–∫–∞—è latency –∑–∞–ø–∏—Å–∏ (–∂–¥—ë–º cross-region RTT)
- ‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —Å–µ—Ç–µ–≤–æ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**: Spanner, CockroachDB (—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π), YugabyteDB.

### –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

#### AWS DynamoDB Global Tables

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: Active-active multi-master —Å conflict resolution.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. –ö–∞–∂–¥—ã–π —Ä–µ–≥–∏–æ–Ω –∏–º–µ–µ—Ç –ø–æ–ª–Ω—É—é –∫–æ–ø–∏—é —Ç–∞–±–ª–∏—Ü—ã
2. –ó–∞–ø–∏—Å–∏ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ –¥—Ä—É–≥–∏–µ —Ä–µ–≥–∏–æ–Ω—ã
3. Conflict resolution: last-write-wins (–ø–æ timestamp)

**Visibility:**
```
Client –≤ US:  ‚îÄ write(x=1) ‚îÄ‚Üí [US DynamoDB]
                                  ‚îÇ async replication (–æ–±—ã—á–Ω–æ 1-2 —Å–µ–∫)
                                  ‚Üì
Client –≤ EU:  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí [EU DynamoDB] ‚îÄ read(x) ‚Üí –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

**–ü—Ä–æ–±–ª–µ–º—ã:**

1. **Clock skew**: –†–∞–∑–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ —á–∞—Å—ã, last-write-wins –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–µ —Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ.

2. **Lost updates**: –ï—Å–ª–∏ –¥–≤–∞ —Ä–µ–≥–∏–æ–Ω–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–∏—à—É—Ç, –æ–¥–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –¥—Ä—É–≥–æ–µ.

**–†–µ—à–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑—É–π `version` –∞—Ç—Ä–∏–±—É—Ç –¥–ª—è optimistic locking
- –ò–∑–±–µ–≥–∞–π multi-region writes –¥–ª—è –æ–¥–Ω–æ–≥–æ item
- –ò—Å–ø–æ–ª—å–∑—É–π region affinity: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π item –ø–∏—à–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –æ–¥–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞

#### Google Cloud Spanner

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: Synchronous multi-region replication —Å TrueTime.

**TrueTime API**: –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —á–∞—Å—ã —Å –∏–∑–≤–µ—Å—Ç–Ω–æ–π –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å—é:
```
TrueTime.now() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª [earliest, latest]
–ì–¥–µ:
  latest - earliest ‚â§ 7ms (–æ–±—ã—á–Ω–æ ~4ms)
```

**Visibility:**
```
Client –ø–∏—à–µ—Ç –≤ Spanner:
  1. Spanner –Ω–∞–∑–Ω–∞—á–∞–µ—Ç commit timestamp T –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ TrueTime
  2. –ñ–¥—ë—Ç TrueTime.latest(), —á—Ç–æ–±—ã T –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤ –ø—Ä–æ—à–ª–æ–º –¥–ª—è –≤—Å–µ—Ö
  3. –†–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç –Ω–∞ –∫–≤–æ—Ä—É–º —Ä–µ–≥–∏–æ–Ω–æ–≤ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
  4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É

‚Üí –õ—é–±–æ–µ —á—Ç–µ–Ω–∏–µ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –≤–∏–¥–∏—Ç –∑–∞–ø–∏—Å—å (linearizability)
```

**–¶–µ–Ω–∞**: –ó–∞–ø–∏—Å—å –∑–∞–Ω–∏–º–∞–µ—Ç ~100-300ms –¥–ª—è cross-region, –Ω–æ –¥–∞—ë—Ç —Å—Ç—Ä–æ–≥–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏.

#### MongoDB Global Clusters

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: Geo-distributed replica set —Å –∑–æ–Ω–∞–ª—å–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–µ–π.

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```
Replica Set:
  Primary:     US-East (priority=2)
  Secondary:   US-West (priority=1)
  Secondary:   EU-West (priority=1, hidden, votes=1)

Write concern: {w: "majority"} ‚Üí –∂–¥—ë—Ç 2 –∏–∑ 3 —É–∑–ª–æ–≤
Read preference: "primaryPreferred" –∏–ª–∏ "nearest"
```

**Visibility —Å—Ü–µ–Ω–∞—Ä–∏–∏:**

```
–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ó–∞–ø–∏—Å—å —Å w="majority", —á—Ç–µ–Ω–∏–µ —Å "primaryPreferred"
  1. Client –ø–∏—à–µ—Ç ‚Üí Primary –≤ US-East
  2. Primary —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç ‚Üí US-West (50ms) + EU-West (100ms)
  3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–æ—Å–ª–µ 2/3 (US-West) ‚Üí latency ~50ms
  4. Client —á–∏—Ç–∞–µ—Ç ‚Üí Primary ‚Üí –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚úì

–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ó–∞–ø–∏—Å—å —Å w=1, —á—Ç–µ–Ω–∏–µ —Å "nearest" –∏–∑ EU
  1. Client –ø–∏—à–µ—Ç ‚Üí Primary –≤ US-East
  2. Primary –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å—Ä–∞–∑—É ‚Üí latency ~1ms
  3. Async —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç –≤ EU (100ms)
  4. Client –∏–∑ EU —á–∏—Ç–∞–µ—Ç —Å "nearest" (EU secondary)
     ‚Üí –ú–æ–∂–µ—Ç –Ω–µ –≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –µ—â—ë 100ms ‚úó
```

#### Cassandra: Multi-DC —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: Active-active —Å tunable consistency.

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```
CREATE KEYSPACE ecommerce
WITH replication = {
  'class': 'NetworkTopologyStrategy',
  'US-East': 3,
  'EU-West': 3,
  'APAC': 2
};
```

**Consistency levels –¥–ª—è cross-region:**

```
EACH_QUORUM:
  Write: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ quorum –≤ –ö–ê–ñ–î–û–ú DC
  Read:  –ß–∏—Ç–∞–µ—Ç quorum –∏–∑ –ö–ê–ñ–î–û–ì–û DC
  ‚Üí Strong consistency, –Ω–æ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ

LOCAL_QUORUM:
  Write: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ quorum –≤ –õ–û–ö–ê–õ–¨–ù–û–ú DC
  Read:  –ß–∏—Ç–∞–µ—Ç quorum –∏–∑ –õ–û–ö–ê–õ–¨–ù–û–ì–û DC
  ‚Üí Eventual consistency –º–µ–∂–¥—É DC, –Ω–æ –±—ã—Å—Ç—Ä–æ

LOCAL_ONE:
  Write: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ 1 —É–∑–µ–ª –ª–æ–∫–∞–ª—å–Ω–æ
  Read:  –ß–∏—Ç–∞–µ—Ç —Å 1 —É–∑–ª–∞ –ª–æ–∫–∞–ª—å–Ω–æ
  ‚Üí –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
```

**Visibility –ø—Ä–∏–º–µ—Ä:**
```
–ö–ª–∏–µ–Ω—Ç –≤ US –ø–∏—à–µ—Ç —Å consistency=LOCAL_QUORUM:
  t0:  –∑–∞–ø–∏—Å—å –Ω–∞ US —É–∑–ª—ã (2/3) ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∑–∞ 5ms
  t1:  async —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –≤ EU ‚Üí –ø—Ä–∏—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ 100ms

–ö–ª–∏–µ–Ω—Ç –≤ EU —á–∏—Ç–∞–µ—Ç —Å consistency=LOCAL_QUORUM:
  t50:  —á–∏—Ç–∞–µ—Ç –∏–∑ EU —É–∑–ª–æ–≤ ‚Üí –ù–ï –≤–∏–¥–∏—Ç –∑–∞–ø–∏—Å—å (—Ç–æ–ª—å–∫–æ 0/3 —É–∑–ª–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å)
  t150: —á–∏—Ç–∞–µ—Ç –∏–∑ EU —É–∑–ª–æ–≤ ‚Üí –≤–∏–¥–∏—Ç –∑–∞–ø–∏—Å—å (2/3 —É–∑–ª–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å)
```

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã Cross-Region Visibility

#### 1. –†–µ–≥–∏–æ–Ω-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Ç–µ–∫–∞—é—Ç –≤ –¥—Ä—É–≥–∏–µ —Ä–µ–≥–∏–æ–Ω—ã

**–ü—Ä–æ–±–ª–µ–º–∞**: GDPR —Ç—Ä–µ–±—É–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ EU –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–æ–ª—å–∫–æ –≤ EU, –Ω–æ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è —Ä–∞–∑–º—ã–≤–∞–µ—Ç —ç—Ç–æ.

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
EU User —Å–æ–∑–¥–∞—ë—Ç –∞–∫–∫–∞—É–Ω—Ç:
  ‚Üí –ü–∏—à–µ—Ç—Å—è –≤ EU region
  ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç—Å—è –≤ US, APAC —Ä–µ–≥–∏–æ–Ω—ã
  ‚Üí –ù–∞—Ä—É—à–µ–Ω–∏–µ GDPR ‚ùå
```

**–†–µ—à–µ–Ω–∏–µ 1 - Geo-pinning:**
```
–ù–∞—Å—Ç—Ä–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é per-tenant:
  EU users ‚Üí —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ EU1, EU2
  US users ‚Üí —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ US1, US2
```

**–†–µ—à–µ–Ω–∏–µ 2 - Data residency –ø—Ä–∞–≤–∏–ª–∞:**
```
–ò—Å–ø–æ–ª—å–∑—É–π database sharding –ø–æ —Ä–µ–≥–∏–æ–Ω—É:
  eu_users table ‚Üí —Ç–æ–ª—å–∫–æ EU clusters
  us_users table ‚Üí —Ç–æ–ª—å–∫–æ US clusters
```

#### 2. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ conflicting updates

**–ü—Ä–æ–±–ª–µ–º–∞**: Active-active —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏.

**–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä - Twitter:**
```
t0: User @alice –∏–º–µ–µ—Ç 1000 –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤

t1: [US region]  User @bob –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è ‚Üí followers=1001
    [EU region]  User @charlie –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è ‚Üí followers=1001

t2: Replication:
    US –ø–æ–ª—É—á–∞–µ—Ç EU update: followers=1001 (overwrites 1001)
    EU –ø–æ–ª—É—á–∞–µ—Ç US update: followers=1001 (overwrites 1001)

–ò—Ç–æ–≥: 2 –ø–æ–¥–ø–∏—Å–∫–∏, –Ω–æ —Å—á—ë—Ç—á–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç +1, –ø–æ—Ç–µ—Ä—è–Ω–∞ –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞!
```

**–†–µ—à–µ–Ω–∏–µ 1 - CRDT (Conflict-free Replicated Data Types):**
```
–í–º–µ—Å—Ç–æ —Å—á—ë—Ç—á–∏–∫–∞ —Ö—Ä–∞–Ω–∏–º set –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤:
  followers = {bob, charlie}

Merge strategy: UNION
  US: {bob}
  EU: {charlie}
  Merged: {bob, charlie}
  Count: 2 ‚úì
```

**–†–µ—à–µ–Ω–∏–µ 2 - Regional affinity:**
```
–•–µ—à user_id –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç home region:
  @alice (hash=7) ‚Üí home=US
  –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ @alice –∏–¥—É—Ç —Ç–æ–ª—å–∫–æ –≤ US
  –î—Ä—É–≥–∏–µ —Ä–µ–≥–∏–æ–Ω—ã —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—é—Ç
```

#### 3. Stale reads –∏–∑-–∑–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ª–∞–≥–∞

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ä–∞–∑–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É —Ä–µ–≥–∏–æ–Ω–∞–º–∏.

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
User –ø—É–±–ª–∏–∫—É–µ—Ç –ø–æ—Å—Ç –≤ US:
  t0:  –ø–æ—Å—Ç –∑–∞–ø–∏—Å–∞–Ω –≤ US region
  t100: –ø–æ—Å—Ç —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω –≤ EU

User –ø—É—Ç–µ—à–µ—Å—Ç–≤—É–µ—Ç:
  t50:  User –≤ —Å–∞–º–æ–ª—ë—Ç–µ US‚ÜíEU
  t70:  User –ø—Ä–∏–∑–µ–º–ª—è–µ—Ç—Å—è, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç app (–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ EU region)
       ‚Üí –ü–æ—Å—Ç –Ω–µ –≤–∏–¥–µ–Ω! (EU –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∏–ª —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é)
  t150: User –æ–±–Ω–æ–≤–ª—è–µ—Ç ‚Üí –ø–æ—Å—Ç –ø–æ—è–≤–∏–ª—Å—è
```

**–†–µ—à–µ–Ω–∏–µ - Session tokens —Å –≤–µ—Ä—Å–∏—è–º–∏:**
```
1. –ü–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ app –ø–æ–ª—É—á–∞–µ—Ç global_version=12345
2. App —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ localStorage: last_seen_version=12345
3. –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –≤ EU –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: min_version=12345
4. EU region –∂–¥—ë—Ç, –ø–æ–∫–∞ –¥–æ–≥–æ–Ω–∏—Ç –¥–æ –≤–µ—Ä—Å–∏–∏ 12345
5. –ó–∞—Ç–µ–º –æ—Ç–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ
```

#### 4. Split-brain –ø—Ä–∏ —Å–µ—Ç–µ–≤–æ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞**: –†–µ–≥–∏–æ–Ω—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞, –∫–∞–∂–¥—ã–π –¥—É–º–∞–µ—Ç —á—Ç–æ –¥—Ä—É–≥–æ–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

```
t0:  [US] ‚Üê‚îÄ‚îÄ‚îÄX‚îÄ‚îÄ‚îÄ‚Üí [EU]  (—Å–µ—Ç–µ–≤–æ–π —Ä–∞–∑—Ä—ã–≤)
       ‚Üì             ‚Üì
   –ø—Ä–∏–Ω–∏–º–∞–µ—Ç      –ø—Ä–∏–Ω–∏–º–∞–µ—Ç
     –∑–∞–ø–∏—Å–∏         –∑–∞–ø–∏—Å–∏
       ‚Üì             ‚Üì
  US —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è   EU —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
   inconsistent   inconsistent
   —Å EU           —Å US
```

**–†–µ—à–µ–Ω–∏–µ 1 - Quorum —Ç—Ä–µ–±—É–µ—Ç majority —Ä–µ–≥–∏–æ–Ω–æ–≤:**
```
3 —Ä–µ–≥–∏–æ–Ω–∞: US, EU, APAC
Quorum = 2

–ü—Ä–∏ —Å–µ—Ç–µ–≤–æ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏:
  US isolated: –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–µ–±—è (1/3) ‚Üí –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø–∏—Å–∏
  EU + APAC: –≤–∏–¥—è—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞ (2/3) ‚Üí –ø—Ä–∏–Ω–∏–º–∞—é—Ç –∑–∞–ø–∏—Å–∏

‚Üí –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ partition –æ—Å—Ç–∞—ë—Ç—Å—è writeable
```

**–†–µ—à–µ–Ω–∏–µ 2 - Manual failover:**
```
–ü—Ä–∏ —Å–µ—Ç–µ–≤–æ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏:
  ‚Üí –ü–µ—Ä–µ–≤–æ–¥–∏–º —Å–∏—Å—Ç–µ–º—É –≤ read-only mode
  ‚Üí Operations team –≤—Ä—É—á–Ω—É—é –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç authoritative region
  ‚Üí –î—Ä—É–≥–∏–µ —Ä–µ–≥–∏–æ–Ω—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è read-only –¥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
```

### –ü—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Cross-Region —Å–∏—Å—Ç–µ–º

#### 1. Regional Data Partitioning

–†–∞–∑–¥–µ–ª—è–π –¥–∞–Ω–Ω—ã–µ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ:

```
User data:
  EU users ‚Üí stored only in EU
  US users ‚Üí stored only in US

Reference data (product catalog):
  Replicated globally

Transactional data:
  Stored in user's home region
  Read-only replicas in other regions
```

#### 2. Read-Local, Write-Global —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

```
Reads (95% —Ç—Ä–∞—Ñ–∏–∫–∞):
  ‚Üí –í—Å–µ–≥–¥–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
  ‚Üí Eventual consistency –û–ö
  ‚Üí Low latency ‚úì

Writes (5% —Ç—Ä–∞—Ñ–∏–∫–∞):
  ‚Üí –í home region (–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º/geo)
  ‚Üí –ú–æ–∂–µ—Ç –±—ã—Ç—å cross-region latency
  ‚Üí Strong consistency ‚úì
```

#### 3. Conflict-Free –æ–ø–µ—Ä–∞—Ü–∏–∏

–ü—Ä–æ–µ–∫—Ç–∏—Ä—É–π –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç:

‚ùå **–ö–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
```
UPDATE counter SET value = value + 1  (race condition)
UPDATE user SET email = 'new@mail.com' (last-write-wins)
```

‚úÖ **Conflict-free –æ–ø–µ—Ä–∞—Ü–∏–∏:**
```
INSERT INTO events (id, timestamp, type) VALUES (...)  (append-only)
ADD item TO set  (CRDT set, union –ø—Ä–∏ merge)
INCREMENT counter (CRDT counter, sum –ø—Ä–∏ merge)
```

#### 4. Graceful Degradation –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö

```
if (can_reach_other_regions):
    use global consistency
else:
    switch to local mode:
        - accept writes locally
        - mark data as "pending_sync"
        - show warning to users: "–†–∞–±–æ—Ç–∞–µ–º –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ"
        - when connection restored: sync conflicts, notify users
```

#### 5. Monitoring —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ª–∞–≥–∞

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**

```
replication_lag_seconds{from=US, to=EU}
  Alert if > 5 seconds

replication_lag_bytes{from=US, to=EU}
  Alert if > 100 MB

replication_errors_total{from=US, to=EU}
  Alert if > 0

data_inconsistency_detected{region=EU}
  Alert if > 0
```

**Dashboard:**
```
–ì—Ä–∞—Ñ–∏–∫ replication lag –º–µ–∂–¥—É –≤—Å–µ–º–∏ –ø–∞—Ä–∞–º–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤
–ú–∞—Ç—Ä–∏—Ü–∞: –∫–∞–∫–∏–µ —Ä–µ–≥–∏–æ–Ω—ã –≤–∏–¥—è—Ç –∫–∞–∫–∏–µ –≤–µ—Ä—Å–∏–∏ –¥–∞–Ω–Ω—ã—Ö
P95/P99 latency –¥–ª—è cross-region queries
```

---

## Delayed Visibility (–û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å)

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**Delayed Visibility** ‚Äî —ç—Ç–æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–∞—è –∏–ª–∏ –Ω–µ–ø—Ä–µ–¥–Ω–∞–º–µ—Ä–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –º–æ–º–µ–Ω—Ç–æ–º –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–º–µ–Ω—Ç–æ–º, –∫–æ–≥–¥–∞ –æ–Ω–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏ –¥–ª—è —á—Ç–µ–Ω–∏—è. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ visibility, –≥–¥–µ –∑–∞–¥–µ—Ä–∂–∫–∞ –æ–±—ã—á–Ω–æ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–∞, delayed visibility —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ –∫–∞–∫ –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### –ü—Ä–∏—á–∏–Ω—ã Delayed Visibility

#### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ (–Ω–∞–º–µ—Ä–µ–Ω–Ω—ã–µ)

**Message Queue Visibility Timeout:**
```
–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å:
  t0:   —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ queue
  t0-t30: –ù–ï–í–ò–î–ò–ú–û –¥–ª—è consumers (visibility timeout = 30 sec)
  t30:  —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–∏–¥–∏–º—ã–º
```

**Scheduled Publishing:**
```
–ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω —Å publish_at = "2024-12-25 00:00":
  t0:   –ø–æ—Å—Ç –≤ –ë–î, status='scheduled'
  ...   –ù–ï–í–ò–î–ò–ú –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  t_publish: status='published', —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–∏–¥–∏–º—ã–º
```

**Cache warming / Gradual rollout:**
```
–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞:
  t0:   –≤–µ—Ä—Å–∏—è 2 —Å–æ–∑–¥–∞–Ω–∞
  t0-t60: 10% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–∏–¥—è—Ç –≤–µ—Ä—Å–∏—é 2 (A/B test)
  t60-t120: 50% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  t120+:  100% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

#### 2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ (–Ω–µ–ø—Ä–µ–¥–Ω–∞–º–µ—Ä–µ–Ω–Ω—ã–µ)

**Replication Lag:**
```
–ó–∞–ø–∏—Å—å –≤ master ‚Üí —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –Ω–∞ replicas ‚Üí –≤–∏–¥–∏–º–æ—Å—Ç—å –Ω–∞ replicas
          0ms              100-5000ms           ????
```

**Batch Processing Delays:**
```
–î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã ‚Üí –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã batch job ‚Üí –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã ‚Üí –≤–∏–¥–∏–º—ã –≤ –ø–æ–∏—Å–∫–µ
          0ms           –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω         +10-20 sec
```

**Cache Invalidation Lag:**
```
–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ –ë–î ‚Üí –∫–µ—à —É—Å—Ç–∞—Ä–µ–ª ‚Üí TTL –∏—Å—Ç–µ–∫–∞–µ—Ç ‚Üí –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–Ω—ã
              0ms          5 min         +5 min
```

### –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

#### Amazon SQS: Visibility Timeout

SQS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç visibility timeout –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ consumers.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

```
1. Producer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç message –≤ queue
   ‚Üí message –≤–∏–¥–∏–º–æ –¥–ª—è consumers

2. Consumer A –ø–æ–ª—É—á–∞–µ—Ç message
   ‚Üí SQS —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç visibility timeout = 30 sec
   ‚Üí message –ù–ï–í–ò–î–ò–ú–û –¥–ª—è –¥—Ä—É–≥–∏—Ö consumers 30 —Å–µ–∫—É–Ω–¥

3. –ï—Å–ª–∏ Consumer A –æ–±—Ä–∞–±–æ—Ç–∞–ª —É—Å–ø–µ—à–Ω–æ:
   ‚Üí —É–¥–∞–ª—è–µ—Ç message –∏–∑ queue (delete_message)
   ‚Üí message –∏—Å—á–µ–∑–∞–µ—Ç –Ω–∞–≤—Å–µ–≥–¥–∞

4. –ï—Å–ª–∏ Consumer A –ù–ï —É–¥–∞–ª–∏–ª message –∑–∞ 30 sec:
   ‚Üí visibility timeout –∏—Å—Ç–µ–∫–∞–µ—Ç
   ‚Üí message —Å–Ω–æ–≤–∞ –í–ò–î–ò–ú–û
   ‚Üí –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª—É—á–µ–Ω–æ Consumer B
```

**–ü—Ä–æ–±–ª–µ–º–∞ ‚Äî Message —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–∏–¥–∏–º—ã–º –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ:**

```
1. Consumer –ø–æ–ª—É—á–∞–µ—Ç message, visibility timeout = 30 sec
2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 45 —Å–µ–∫—É–Ω–¥ (–¥–æ–ª–≥–∞—è –∑–∞–¥–∞—á–∞)
3. –ß–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ message —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–∏–¥–∏–º—ã–º —Å–Ω–æ–≤–∞
4. Consumer B –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ –∂–µ message
5. –¢–µ–ø–µ—Ä—å –æ–±–∞ consumers –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ–¥–Ω–æ message! (duplicate processing)
```

**–†–µ—à–µ–Ω–∏–µ:**
```
while processing:
    if (elapsed_time > visibility_timeout * 0.5):
        sqs.change_message_visibility(
            new_timeout=current_timeout + 30
        )
        # –ü—Ä–æ–¥–ª—è–µ–º visibility, –ø–æ–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
```

#### RabbitMQ: Unacked Messages Visibility

RabbitMQ –∏–º–µ–µ—Ç –ø–æ—Ö–æ–∂–∏–π –º–µ—Ö–∞–Ω–∏–∑–º —Å unacked messages:

```
1. Message –≤ queue, –≤–∏–¥–∏–º–æ
2. Consumer –ø–æ–ª—É—á–∞–µ—Ç message (basic.get –∏–ª–∏ basic.consume)
   ‚Üí message –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ "unacked"
   ‚Üí –ù–ï–í–ò–î–ò–ú–û –¥–ª—è –¥—Ä—É–≥–∏—Ö consumers
3. Consumer –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ACK
   ‚Üí message —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ queue
4. –ï—Å–ª–∏ consumer –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –±–µ–∑ ACK:
   ‚Üí message –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ queue
   ‚Üí —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –í–ò–î–ò–ú–´–ú —Å–Ω–æ–≤–∞ (redelivery)
```

**–ü—Ä–æ–±–ª–µ–º–∞ ‚Äî Consumer –ø–∞–¥–∞–µ—Ç –¥–æ ACK:**

```
1. Consumer –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç message (15 —Å–µ–∫—É–Ω–¥)
2. –ù–∞ 14-–π —Å–µ–∫—É–Ω–¥–µ consumer crash
3. Message –ù–ï acknowledged
4. RabbitMQ –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç message –¥—Ä—É–≥–æ–º—É consumer
5. –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã–ª–∞ side-effect (email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –ø–ª–∞—Ç—ë–∂ —Å–¥–µ–ª–∞–Ω):
   ‚Üí Duplicate processing! Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–≤–∞–∂–¥—ã
```

**–†–µ—à–µ–Ω–∏–µ**: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ + deduplication –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ consumer.

#### ClickHouse: Delayed Visibility —á–µ—Ä–µ–∑ ReplacingMergeTree

ClickHouse –∏—Å–ø–æ–ª—å–∑—É–µ—Ç merge background –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:

```
Table: ReplacingMergeTree(version)

t0:  INSERT (id=1, value='A', version=1)
t1:  INSERT (id=1, value='B', version=2)  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ

SELECT * FROM table WHERE id=1:
  ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –û–ë–ï —Å—Ç—Ä–æ–∫–∏:
    (id=1, value='A', version=1)
    (id=1, value='B', version=2)

Background merge –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∂–¥—ã–µ N –º–∏–Ω—É—Ç:
  ‚Üí –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é (version=1)

–ü–æ—Å–ª–µ merge:
SELECT * FROM table WHERE id=1:
  ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É:
    (id=1, value='B', version=2)
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –î–æ merge –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–∏–¥–∏—Ç –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–¥—É–±–ª–∏–∫–∞—Ç—ã).

**–†–µ—à–µ–Ω–∏–µ:**
```
SELECT * FROM table
WHERE id=1
ORDER BY version DESC
LIMIT 1
-- –í—Å–µ–≥–¥–∞ –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –≤—Ä—É—á–Ω—É—é
```

–∏–ª–∏
```
SELECT * FROM table FINAL WHERE id=1
-- FINAL –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç ClickHouse —Å–¥–µ–ª–∞—Ç—å merge –Ω–∞ –ª–µ—Ç—É (–º–µ–¥–ª–µ–Ω–Ω–æ!)
```

#### Elasticsearch: Refresh Interval

Elasticsearch –Ω–µ –¥–µ–ª–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–∏–º—ã–º–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ:

```
1. –ö–ª–∏–µ–Ω—Ç –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç:
   POST /products/_doc/123 {"name": "iPhone"}
   ‚Üí Elasticsearch –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {"result": "created"}

2. –î–æ–∫—É–º–µ–Ω—Ç –∑–∞–ø–∏—Å–∞–Ω –≤ in-memory buffer
   ‚Üí –ù–ï –í–ò–î–ò–ú –¥–ª—è –ø–æ–∏—Å–∫–∞

3. –ö–∞–∂–¥—ã–µ 1 —Å–µ–∫—É–Ω–¥—É (refresh_interval) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç refresh:
   ‚Üí –î–∞–Ω–Ω—ã–µ –∏–∑ buffer –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è –≤ segment
   ‚Üí –°—Ç–∞–Ω–æ–≤—è—Ç—Å—è –í–ò–î–ò–ú–´ –¥–ª—è –ø–æ–∏—Å–∫–∞

4. GET /products/_search?q=iPhone
   ‚Üí –ú–æ–∂–µ—Ç –Ω–µ –Ω–∞–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç, –µ—Å–ª–∏ refresh –µ—â—ë –Ω–µ –ø—Ä–æ–∏–∑–æ—à—ë–ª!
```

**Visibility delay: 0-1 —Å–µ–∫—É–Ω–¥–∞** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).

**–ü—Ä–æ–±–ª–µ–º—ã:**

```
E-commerce —Å—Ü–µ–Ω–∞—Ä–∏–π:
1. User —Å–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑ ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ Elasticsearch
2. –°—Ä–∞–∑—É —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—Å—è –Ω–∞ /orders/123
3. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ–ª–∞–µ—Ç –ø–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞ ‚Üí –ù–ï –ù–ê–ô–î–ï–ù (refresh –Ω–µ –ø—Ä–æ–∏–∑–æ—à—ë–ª)
4. User –≤–∏–¥–∏—Ç 404 ‚Üí –ø–∞–Ω–∏–∫–∞
```

**–†–µ—à–µ–Ω–∏—è:**

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π refresh (–¥–æ—Ä–æ–≥–æ):**
   ```
   POST /products/_doc/123?refresh=true
   ‚Üí –§–æ—Ä—Å–∏—Ä—É–µ—Ç refresh –ø–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
   ‚Üí Latency ~50-200ms –≤–º–µ—Å—Ç–æ ~5ms
   ```

2. **Wait for refresh:**
   ```
   POST /products/_doc/123?refresh=wait_for
   ‚Üí –ñ–¥—ë—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ refresh (max 1 sec)
   ‚Üí –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–æ–∫—É–º–µ–Ω—Ç –≤–∏–¥–∏–º
   ```

3. **Read from database, search from ES:**
   ```
   –ó–∞–ø–∏—Å—å –∏–¥—ë—Ç –≤ –ë–î + async –≤ Elasticsearch
   GET /orders/123 ‚Üí —á–∏—Ç–∞–µ—Ç –∏–∑ –ë–î (–≤–∏–¥–∏—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)
   GET /orders/search ‚Üí —á–∏—Ç–∞–µ—Ç –∏–∑ ES (eventual visibility)
   ```

#### Kafka: Consumer Group Rebalancing Visibility

–ü—Ä–∏ rebalancing Kafka consumer group, —á–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–≤–∏–¥–∏–º–æ–π:

```
Consumer Group —Å 3 consumers:
  C1 —á–∏—Ç–∞–µ—Ç partitions [0, 1]
  C2 —á–∏—Ç–∞–µ—Ç partitions [2, 3]
  C3 —á–∏—Ç–∞–µ—Ç partitions [4, 5]

t0: C2 –ø–∞–¥–∞–µ—Ç
    ‚Üí Triggering rebalance

t0-t5 sec (rebalance period):
  ‚Üí –í–°–ï consumers –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç —á—Ç–µ–Ω–∏–µ
  ‚Üí Partitions [2, 3] –ù–ï –ß–ò–¢–ê–Æ–¢–°–Ø
  ‚Üí –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è, –Ω–æ –Ω–µ–≤–∏–¥–∏–º—ã –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

t5: Rebalance –∑–∞–≤–µ—Ä—à—ë–Ω:
  C1 —á–∏—Ç–∞–µ—Ç [0, 1, 2]
  C3 —á–∏—Ç–∞–µ—Ç [3, 4, 5]
  ‚Üí –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ [2, 3] —Å–Ω–æ–≤–∞ –≤–∏–¥–∏–º—ã
```

**Visibility delay: 3-10 —Å–µ–∫—É–Ω–¥** –ø—Ä–∏ –∫–∞–∂–¥–æ–º rebalance.

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ rebalance –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —á–∞—Å—Ç–æ ‚Üí —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã invisibility.

**–†–µ—à–µ–Ω–∏—è:**
- –£–≤–µ–ª–∏—á–∏—Ç—å `session.timeout.ms` –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã rebalance
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å static membership (Kafka 2.3+) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è rebalance –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–∞—Ö
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ rebalance events: –∞–ª–µ—Ä—Ç –µ—Å–ª–∏ > 1 —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Delayed Visibility

#### 1. "My changes disappeared!" UX –ø—Ä–æ–±–ª–µ–º–∞

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –≤–∏–¥–∏—Ç –µ–≥–æ, –Ω–æ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏–µ "–∏—Å—á–µ–∑–∞–µ—Ç".

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
1. User –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å ‚Üí –ø–∏—à–µ—Ç—Å—è –≤ master DB
2. App –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ write-through cache ‚Üí user –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ ‚úì
3. Cache TTL –∏—Å—Ç–µ–∫–∞–µ—Ç (5 min)
4. App —á–∏—Ç–∞–µ—Ç —Å read replica, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç—Å—Ç–∞—ë—Ç –Ω–∞ 30 —Å–µ–∫—É–Ω–¥
5. User –≤–∏–¥–∏—Ç –°–¢–ê–†–û–ï –∑–Ω–∞—á–µ–Ω–∏–µ ‚Üí "–ú–æ–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ç–µ—Ä—è–ª–∏—Å—å!"
```

**–†–µ—à–µ–Ω–∏–µ ‚Äî Optimistic UI + Sticky reads:**
```
1. –ü–æ—Å–ª–µ write —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage:
   pending_changes = {profile: {name: 'New Name'}, timestamp: now()}

2. –ü—Ä–∏ read:
   data = fetch_from_api()
   if (pending_changes.timestamp > data.timestamp):
       merge(data, pending_changes)  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º pending –∏–∑–º–µ–Ω–µ–Ω–∏—è

3. –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –æ—á–∏—â–∞–µ–º pending_changes (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ä–µ–ø–ª–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å)
```

#### 2. Ordering issues –∏–∑-–∑–∞ delayed visibility

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–æ–±—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–µ –≤ —Ç–æ–º –ø–æ—Ä—è–¥–∫–µ –∏–∑-–∑–∞ —Ä–∞–∑–Ω—ã—Ö visibility delays.

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```
User actions:
  t0:   –°–æ–∑–¥–∞—ë—Ç –ø–æ—Å—Ç (POST /posts)
  t1:   –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (POST /posts/123/comments)

Backend:
  POST /posts ‚Üí –ø–∏—à–µ—Ç—Å—è –≤ DB ‚Üí –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ Elasticsearch (refresh 1 sec)
  POST /comments ‚Üí –ø–∏—à–µ—Ç—Å—è –≤ DB ‚Üí –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ Elasticsearch (refresh 1 sec)

–ù–æ! Refresh –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ä–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è:
  t0.3: Comment indexed (–ø–æ–ø–∞–ª –≤ refresh —Ä–∞–Ω—å—à–µ)
  t0.8: Post indexed (–ø–æ–ø–∞–ª –≤ —Å–ª–µ–¥—É—é—â–∏–π refresh)

Search results:
  ‚Üí –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–∏–¥–∏–º, –Ω–æ –ø–æ—Å—Ç –µ—â—ë –Ω–µ—Ç!
  ‚Üí UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —É–¥–∞–ª—ë–Ω–Ω–æ–º—É –ø–æ—Å—Ç—É"
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑—É–π –µ–¥–∏–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π `refresh=wait_for` –¥–ª—è –æ–±–µ–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –•—Ä–∞–Ω–∏ foreign key –≤ –∫–æ–º–º–µ–Ω—Ç–µ, –ø—Ä–æ–≤–µ—Ä—è–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏

#### 3. Delayed visibility –Ω–∞—Ä—É—à–∞–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É

**–ü—Ä–æ–±–ª–µ–º–∞**: –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ –ø–æ–ª–∞–≥–∞—é—Ç—Å—è –Ω–∞ —Å–≤–µ–∂–µ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –Ω–æ visibility delayed.

**–°—Ü–µ–Ω–∞—Ä–∏–π ‚Äî Limited stock:**
```
–¢–æ–≤–∞—Ä: –æ—Å—Ç–∞–ª–æ—Å—å 1 —à—Ç.

User A (US region):
  GET /product/123 ‚Üí reads from US replica ‚Üí stock=1
  POST /cart/add ‚Üí –ø–∏—à–µ—Ç –≤ US master ‚Üí stock=0

User B (EU region):
  GET /product/123 ‚Üí reads from EU replica (–æ—Ç—Å—Ç–∞—ë—Ç 2 sec)
                   ‚Üí stock=1 (—É—Å—Ç–∞—Ä–µ–≤—à–µ–µ!)
  POST /cart/add ‚Üí –ø–∏—à–µ—Ç –≤ EU master ‚Üí stock=-1 ‚ùå

Oversell!
```

**–†–µ—à–µ–Ω–∏–µ 1 - Pessimistic locking:**
```
POST /cart/add:
  BEGIN TRANSACTION
  SELECT stock FROM products WHERE id=123 FOR UPDATE
  IF stock > 0:
    UPDATE products SET stock=stock-1
    COMMIT
  ELSE:
    ROLLBACK
    return "Out of stock"
```

**–†–µ—à–µ–Ω–∏–µ 2 - Reservations:**
```
–í–º–µ—Å—Ç–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è stock:
  1. –°–æ–∑–¥–∞—ë–º reservation (expires in 10 min)
  2. stock_available = stock_total - active_reservations
  3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º stock_available –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
  4. –ü—Ä–∏ checkout –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º reservation –≤ –ø—Ä–æ–¥–∞–∂—É
```

#### 4. Delayed visibility –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–±—ã—Ç–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞**: Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –±—ã—Å—Ç—Ä—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É, –Ω–æ visibility delays –Ω–∞—Ä—É—à–∞—é—Ç —ç—Ç–æ.

**–°—Ü–µ–Ω–∞—Ä–∏–π ‚Äî Payment confirmation:**
```
1. Payment service –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç event "PaymentCompleted" –≤ Kafka
   ‚Üí event –≤ partition

2. Order service —á–∏—Ç–∞–µ—Ç –∏–∑ Kafka —Å lag 2 seconds
   ‚Üí –µ—â—ë –Ω–µ –≤–∏–¥–∏—Ç event

3. User –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–∫–∞–∑–∞
   ‚Üí Order service —á–∏—Ç–∞–µ—Ç –∏–∑ DB
   ‚Üí –ó–∞–∫–∞–∑ –µ—â—ë –≤ —Å—Ç–∞—Ç—É—Å–µ "pending_payment"
   ‚Üí User –≤–∏–¥–∏—Ç "–ñ–¥—ë–º –æ–ø–ª–∞—Ç—ã" (—Ö–æ—Ç—è —É–∂–µ –æ–ø–ª–∞—Ç–∏–ª!)

4. –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã Order service –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç event
   ‚Üí –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ "paid"
```

**–†–µ—à–µ–Ω–∏–µ ‚Äî Dual writes:**
```
Payment service:
  1. –ü–∏—à–µ—Ç event –≤ Kafka (–¥–ª—è async –æ–±—Ä–∞–±–æ—Ç–∫–∏)
  2. –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç Order service API (–¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏)

Order service:
  - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—Ä–∏ API call
  - Kafka event –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è idempotent retry (–µ—Å–ª–∏ API call failed)
```

### –ü—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å Delayed Visibility

#### 1. –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ï—Å–ª–∏ visibility delayed –Ω–µ–∏–∑–±–µ–∂–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–π —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:

```
"–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –∏ –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 1 –º–∏–Ω—É—Ç—ã"
"–ó–∞–∫–∞–∑ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –¥–µ—Ç–∞–ª–∏ –ø–æ—è–≤—è—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥"
"–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥"
```

–ò—Å–ø–æ–ª—å–∑—É–π UI states:
```
[‚úì Saved]           ‚Üí –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã
[‚è≥ Processing...]  ‚Üí –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è (delayed visibility period)
[‚úÖ Published]      ‚Üí –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–∏–º—ã –≤—Å–µ–º
```

#### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Visibility Delay –ø–æ–¥ use case

–†–∞–∑–Ω—ã–µ —á–∞—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏:

| Feature | Acceptable Delay | Strategy |
|---------|-----------------|----------|
| –ü–ª–∞—Ç—ë–∂ | 0 sec (real-time) | Sync write, read from master |
| –õ–∞–π–∫ –ø–æ—Å—Ç–∞ | 1-5 sec | Async, eventual |
| –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ | 5-60 sec | Batch indexing |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | 5-60 min | Batch processing |

#### 3. Graceful Degradation

–ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ real-time –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–π delayed:

```
try:
    data = read_from_master(timeout=100ms)
except Timeout:
    data = read_from_replica()  # –ú–æ–∂–µ—Ç –±—ã—Ç—å delayed, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ
    data.stale_warning = True

if data.stale_warning:
    show_banner("–î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É")
```

#### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Visibility Delays

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**

```
visibility_delay_seconds{component="elasticsearch"}
  ‚Üí Measure: –≤—Ä–µ–º—è –º–µ–∂–¥—É write –∏ visibility –≤ search
  ‚Üí Alert: –µ—Å–ª–∏ > 5 seconds

replication_lag_seconds{from="master", to="replica"}
  ‚Üí Measure: –∑–∞–¥–µ—Ä–∂–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
  ‚Üí Alert: –µ—Å–ª–∏ > 2 seconds

queue_processing_lag_seconds{queue="payments"}
  ‚Üí Measure: –≤–æ–∑—Ä–∞—Å—Ç —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ message –≤ queue
  ‚Üí Alert: –µ—Å–ª–∏ > 30 seconds
```

#### 5. Testing Delayed Visibility

–¢–µ—Å—Ç–∏—Ä—É–π –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏:

```
Test: "User –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å duplicate –ø—Ä–∏ delayed visibility"
1. –°–æ–∑–¥–∞—Ç—å —Ä–µ—Å—É—Ä—Å
2. –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–¥–µ—Ä–∂–∞—Ç—å visibility (mock delay)
3. –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

Test: "–°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç replication lag"
1. –û—Ç–∫–ª—é—á–∏—Ç—å —Ä–µ–ø–ª–∏–∫—É
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å writes –Ω–∞ master
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ app gracefully degraded
4. –í–∫–ª—é—á–∏—Ç—å —Ä–µ–ø–ª–∏–∫—É
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∏—Å—å
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**Visibility Semantics** ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏, –∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∞—Å–ø–µ–∫—Ç –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–ø—Ä—è–º—É—é –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ü–æ–Ω–∏–º–∞–π trade-offs**: –ù–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è. Strong consistency ‚Üí –≤—ã—Å–æ–∫–∞—è latency, eventual consistency ‚Üí —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.

2. **–ü—Ä–æ–µ–∫—Ç–∏—Ä—É–π —Å —É—á—ë—Ç–æ–º –≤–∏–¥–∏–º–æ—Å—Ç–∏**: –ù–µ –Ω–∞–¥–µ–π—Å—è –Ω–∞ "–º–∞–≥–∏—é" –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –Ø–≤–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–π, –∫–æ–≥–¥–∞ –∏ –∫–æ–º—É –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–∏–º—ã.

3. **–ë—É–¥—å —á–µ—Å—Ç–µ–Ω —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏**: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ delayed, —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º. "–í–∞—à –∑–∞–∫–∞–∑ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è" –ª—É—á—à–µ, —á–µ–º –º–æ–ª—á–∞–Ω–∏–µ –∏ 404.

4. **–ú–æ–Ω–∏—Ç–æ—Ä—å visibility metrics**: Replication lag, queue processing delay, cache staleness ‚Äî –≤—Å—ë —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–∏–º–æ –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö.

5. **–¢–µ—Å—Ç–∏—Ä—É–π –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏**: –≠–º—É–ª–∏—Ä—É–π —Å–µ—Ç–µ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏, –ø–∞–¥–µ–Ω–∏—è —É–∑–ª–æ–≤, replication lag. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ gracefully degraded.

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫—É—é –º–æ–¥–µ–ª—å?

```
–ö–†–ò–¢–ò–ß–ù–´–ï –û–ü–ï–†–ê–¶–ò–ò (–ø–ª–∞—Ç–µ–∂–∏, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è):
  ‚Üí Strong consistency
  ‚Üí Sync replication
  ‚Üí Read from master
  ‚Üí Latency –ø—Ä–∏–µ–º–ª–µ–º–∞, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–Ω–∞

–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ô –ö–û–ù–¢–ï–ù–¢ (–ø–æ—Å—Ç—ã, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏):
  ‚Üí Session consistency
  ‚Üí Read-your-writes
  ‚Üí Eventual consistency –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  ‚Üí –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π UI –¥–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –∑–∞–¥–µ—Ä–∂–µ–∫

–ê–ù–ê–õ–ò–¢–ò–ö–ê (–æ—Ç—á—ë—Ç—ã, –¥–∞—à–±–æ—Ä–¥—ã):
  ‚Üí Snapshot isolation
  ‚Üí Delayed visibility –ø—Ä–∏–µ–º–ª–µ–º–∞
  ‚Üí –í–∞–∂–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å snapshot, –∞ –Ω–µ —Å–≤–µ–∂–µ—Å—Ç—å

–ö–≠–®–ò (CDN, app cache):
  ‚Üí Eventual consistency
  ‚Üí TTL-based visibility
  ‚Üí –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

–£–¥–∞—á–∏ –≤ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∏—Å—Ç–µ–º —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π visibility semantics! üöÄ
